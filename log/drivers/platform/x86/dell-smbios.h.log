commit 149ed3d404c9bd00f0fadc35215a9e7a54c5cfd0
Author: Pali Rohár <pali@kernel.org>
Date:   Fri Apr 10 14:34:00 2020 -0700

    change email address for Pali Rohár
    
    For security reasons I stopped using gmail account and kernel address is
    now up-to-date alias to my personal address.
    
    People periodically send me emails to address which they found in source
    code of drivers, so this change reflects state where people can contact
    me.
    
    [ Added .mailmap entry as per Joe Perches  - Linus ]
    Signed-off-by: Pali Rohár <pali@kernel.org>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Cc: Joe Perches <joe@perches.com>
    Link: http://lkml.kernel.org/r/20200307104237.8199-1-pali@kernel.org
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>

diff --git a/drivers/platform/x86/dell-smbios.h b/drivers/platform/x86/dell-smbios.h
index a7ff9803f41a..75fa8ea0476d 100644
--- a/drivers/platform/x86/dell-smbios.h
+++ b/drivers/platform/x86/dell-smbios.h
@@ -4,7 +4,7 @@
  *
  *  Copyright (c) Red Hat <mjg@redhat.com>
  *  Copyright (c) 2014 Gabriele Mazzotta <gabriele.mzt@gmail.com>
- *  Copyright (c) 2014 Pali Rohár <pali.rohar@gmail.com>
+ *  Copyright (c) 2014 Pali Rohár <pali@kernel.org>
  *
  *  Based on documentation in the libsmbios package:
  *  Copyright (C) 2005-2014 Dell Inc.

commit d2912cb15bdda8ba4a5dd73396ad62641af2f520
Author: Thomas Gleixner <tglx@linutronix.de>
Date:   Tue Jun 4 10:11:33 2019 +0200

    treewide: Replace GPLv2 boilerplate/reference with SPDX - rule 500
    
    Based on 2 normalized pattern(s):
    
      this program is free software you can redistribute it and or modify
      it under the terms of the gnu general public license version 2 as
      published by the free software foundation
    
      this program is free software you can redistribute it and or modify
      it under the terms of the gnu general public license version 2 as
      published by the free software foundation #
    
    extracted by the scancode license scanner the SPDX license identifier
    
      GPL-2.0-only
    
    has been chosen to replace the boilerplate/reference in 4122 file(s).
    
    Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
    Reviewed-by: Enrico Weigelt <info@metux.net>
    Reviewed-by: Kate Stewart <kstewart@linuxfoundation.org>
    Reviewed-by: Allison Randal <allison@lohutok.net>
    Cc: linux-spdx@vger.kernel.org
    Link: https://lkml.kernel.org/r/20190604081206.933168790@linutronix.de
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

diff --git a/drivers/platform/x86/dell-smbios.h b/drivers/platform/x86/dell-smbios.h
index d8adaf959740..a7ff9803f41a 100644
--- a/drivers/platform/x86/dell-smbios.h
+++ b/drivers/platform/x86/dell-smbios.h
@@ -1,3 +1,4 @@
+/* SPDX-License-Identifier: GPL-2.0-only */
 /*
  *  Common functions for kernel modules using Dell SMBIOS
  *
@@ -7,10 +8,6 @@
  *
  *  Based on documentation in the libsmbios package:
  *  Copyright (C) 2005-2014 Dell Inc.
- *
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the GNU General Public License version 2 as
- *  published by the Free Software Foundation.
  */
 
 #ifndef _DELL_SMBIOS_H_

commit 25d47027e1003546bfd8964b4423cb39bc2d53e9
Author: Mario Limonciello <mario.limonciello@dell.com>
Date:   Tue Feb 27 12:23:04 2018 -0600

    platform/x86: dell-smbios: Link all dell-smbios-* modules together
    
    Some race conditions were raised due to dell-smbios and its backends
    not being ready by the time that a consumer would call one of the
    exported methods.
    
    To avoid this problem, guarantee that all initialization has been
    done by linking them all together and running init for them all.
    
    As part of this change the Kconfig needs to be adjusted so that
    CONFIG_DELL_SMBIOS_SMM and CONFIG_DELL_SMBIOS_WMI are boolean
    rather than modules.
    
    CONFIG_DELL_SMBIOS is a visually selectable option again and both
    CONFIG_DELL_SMBIOS_WMI and CONFIG_DELL_SMBIOS_SMM are optional.
    
    Signed-off-by: Mario Limonciello <mario.limonciello@dell.com>
    [dvhart: Update prompt and help text for DELL_SMBIOS_* backends]
    Signed-off-by: Darren Hart (VMware) <dvhart@infradead.org>

diff --git a/drivers/platform/x86/dell-smbios.h b/drivers/platform/x86/dell-smbios.h
index 138d478d9adc..d8adaf959740 100644
--- a/drivers/platform/x86/dell-smbios.h
+++ b/drivers/platform/x86/dell-smbios.h
@@ -75,4 +75,29 @@ int dell_laptop_register_notifier(struct notifier_block *nb);
 int dell_laptop_unregister_notifier(struct notifier_block *nb);
 void dell_laptop_call_notifier(unsigned long action, void *data);
 
-#endif
+/* for the supported backends */
+#ifdef CONFIG_DELL_SMBIOS_WMI
+int init_dell_smbios_wmi(void);
+void exit_dell_smbios_wmi(void);
+#else /* CONFIG_DELL_SMBIOS_WMI */
+static inline int init_dell_smbios_wmi(void)
+{
+	return -ENODEV;
+}
+static inline void exit_dell_smbios_wmi(void)
+{}
+#endif /* CONFIG_DELL_SMBIOS_WMI */
+
+#ifdef CONFIG_DELL_SMBIOS_SMM
+int init_dell_smbios_smm(void);
+void exit_dell_smbios_smm(void);
+#else /* CONFIG_DELL_SMBIOS_SMM */
+static inline int init_dell_smbios_smm(void)
+{
+	return -ENODEV;
+}
+static inline void exit_dell_smbios_smm(void)
+{}
+#endif /* CONFIG_DELL_SMBIOS_SMM */
+
+#endif /* _DELL_SMBIOS_H_ */

commit f2645fa317b8905b8934f06a0601d5b7fa66aba0
Author: Mario Limonciello <mario.limonciello@dell.com>
Date:   Wed Nov 1 14:25:36 2017 -0500

    platform/x86: dell-smbios-wmi: introduce userspace interface
    
    It's important for the driver to provide a R/W ioctl to ensure that
    two competing userspace processes don't race to provide or read each
    others data.
    
    This userspace character device will be used to perform SMBIOS calls
    from any applications.
    
    It provides an ioctl that will allow passing the WMI calling
    interface buffer between userspace and kernel space.
    
    This character device is intended to deprecate the dcdbas kernel module
    and the interface that it provides to userspace.
    
    To perform an SMBIOS IOCTL call using the character device userspace will
    perform a read() on the the character device.  The WMI bus will provide
    a u64 variable containing the necessary size of the IOCTL buffer.
    
    The API for interacting with this interface is defined in documentation
    as well as the WMI uapi header provides the format of the structures.
    
    Not all userspace requests will be accepted.  The dell-smbios filtering
    functionality will be used to prevent access to certain tokens and calls.
    
    All whitelisted commands and tokens are now shared out to userspace so
    applications don't need to define them in their own headers.
    
    Signed-off-by: Mario Limonciello <mario.limonciello@dell.com>
    Reviewed-by: Edward O'Callaghan <quasisec@google.com>
    Signed-off-by: Darren Hart (VMware) <dvhart@infradead.org>

diff --git a/drivers/platform/x86/dell-smbios.h b/drivers/platform/x86/dell-smbios.h
index 91e8004d48ba..138d478d9adc 100644
--- a/drivers/platform/x86/dell-smbios.h
+++ b/drivers/platform/x86/dell-smbios.h
@@ -17,23 +17,11 @@
 #define _DELL_SMBIOS_H_
 
 #include <linux/device.h>
+#include <uapi/linux/wmi.h>
 
-/* Classes and selects used in kernel drivers */
-#define CLASS_TOKEN_READ 0
-#define CLASS_TOKEN_WRITE 1
-#define SELECT_TOKEN_STD 0
-#define SELECT_TOKEN_BAT 1
-#define SELECT_TOKEN_AC 2
+/* Classes and selects used only in kernel drivers */
 #define CLASS_KBD_BACKLIGHT 4
 #define SELECT_KBD_BACKLIGHT 11
-#define CLASS_FLASH_INTERFACE 7
-#define SELECT_FLASH_INTERFACE 3
-#define CLASS_ADMIN_PROP 10
-#define SELECT_ADMIN_PROP 3
-#define CLASS_INFO 17
-#define SELECT_RFKILL 11
-#define SELECT_APP_REGISTRATION	3
-#define SELECT_DOCK 22
 
 /* Tokens used in kernel drivers, any of these
  * should be filtered from userspace access
@@ -50,24 +38,8 @@
 #define GLOBAL_MIC_MUTE_ENABLE	0x0364
 #define GLOBAL_MIC_MUTE_DISABLE	0x0365
 
-/* tokens whitelisted to userspace use */
-#define CAPSULE_EN_TOKEN	0x0461
-#define CAPSULE_DIS_TOKEN	0x0462
-#define WSMT_EN_TOKEN		0x04EC
-#define WSMT_DIS_TOKEN		0x04ED
-
 struct notifier_block;
 
-/* This structure will be modified by the firmware when we enter
- * system management mode, hence the volatiles */
-
-struct calling_interface_buffer {
-	u16 cmd_class;
-	u16 cmd_select;
-	volatile u32 input[4];
-	volatile u32 output[4];
-} __packed;
-
 struct calling_interface_token {
 	u16 tokenID;
 	u16 location;

commit 1f8543a5d602b816b9b64a62cafd6caae2af4ca6
Author: Mario Limonciello <mario.limonciello@dell.com>
Date:   Wed Nov 1 14:25:34 2017 -0500

    platform/x86: dell-smbios: Add filtering support
    
    When a userspace interface is introduced to dell-smbios filtering
    support will be used to make sure that userspace doesn't make calls
    deemed unsafe or that can cause the kernel drivers to get out of
    sync.
    
    A blacklist is provided for the following:
    - Items that are in use by other kernel drivers
    - Items that are deemed unsafe (diagnostics, write-once, etc)
    - Any items in the blacklist will be rejected.
    
    Following that a whitelist is provided as follows:
    - Each item has an associated capability.  If a userspace interface
      accesses this item, that capability will be tested to filter
      the request.
    - If the process provides CAP_SYS_RAWIO the whitelist will be
      overridden.
    
    When an item is not in the blacklist, or whitelist and the process
    is run with insufficient capabilities the call will be rejected.
    
    Signed-off-by: Mario Limonciello <mario.limonciello@dell.com>
    Reviewed-by: Edward O'Callaghan <quasisec@google.com>
    Signed-off-by: Darren Hart (VMware) <dvhart@infradead.org>

diff --git a/drivers/platform/x86/dell-smbios.h b/drivers/platform/x86/dell-smbios.h
index 07effdc7ae8b..91e8004d48ba 100644
--- a/drivers/platform/x86/dell-smbios.h
+++ b/drivers/platform/x86/dell-smbios.h
@@ -26,9 +26,14 @@
 #define SELECT_TOKEN_AC 2
 #define CLASS_KBD_BACKLIGHT 4
 #define SELECT_KBD_BACKLIGHT 11
+#define CLASS_FLASH_INTERFACE 7
+#define SELECT_FLASH_INTERFACE 3
+#define CLASS_ADMIN_PROP 10
+#define SELECT_ADMIN_PROP 3
 #define CLASS_INFO 17
 #define SELECT_RFKILL 11
 #define SELECT_APP_REGISTRATION	3
+#define SELECT_DOCK 22
 
 /* Tokens used in kernel drivers, any of these
  * should be filtered from userspace access
@@ -44,6 +49,10 @@
 #define KBD_LED_AUTO_100_TOKEN	0x02F6
 #define GLOBAL_MIC_MUTE_ENABLE	0x0364
 #define GLOBAL_MIC_MUTE_DISABLE	0x0365
+
+/* tokens whitelisted to userspace use */
+#define CAPSULE_EN_TOKEN	0x0461
+#define CAPSULE_DIS_TOKEN	0x0462
 #define WSMT_EN_TOKEN		0x04EC
 #define WSMT_DIS_TOKEN		0x04ED
 
@@ -80,6 +89,8 @@ int dell_smbios_register_device(struct device *d, void *call_fn);
 void dell_smbios_unregister_device(struct device *d);
 
 int dell_smbios_error(int value);
+int dell_smbios_call_filter(struct device *d,
+	struct calling_interface_buffer *buffer);
 int dell_smbios_call(struct calling_interface_buffer *buffer);
 
 struct calling_interface_token *dell_smbios_find_token(int tokenid);

commit da1f607ed6e6a904463396bb6a28bf96584c61cc
Author: Mario Limonciello <mario.limonciello@dell.com>
Date:   Wed Nov 1 14:25:33 2017 -0500

    platform/x86: dell-smbios-smm: test for WSMT
    
    WSMT is as an attestation to the OS that the platform won't
    modify memory outside of pre-defined areas.
    
    If a platform has WSMT enabled in BIOS setup, SMM calls through
    dcdbas will fail.  The only way to access platform data in these
    instances is through the WMI SMBIOS calling interface.
    
    Signed-off-by: Mario Limonciello <mario.limonciello@dell.com>
    Reviewed-by: Edward O'Callaghan <quasisec@google.com>
    Signed-off-by: Darren Hart (VMware) <dvhart@infradead.org>

diff --git a/drivers/platform/x86/dell-smbios.h b/drivers/platform/x86/dell-smbios.h
index b3179f5b326b..07effdc7ae8b 100644
--- a/drivers/platform/x86/dell-smbios.h
+++ b/drivers/platform/x86/dell-smbios.h
@@ -44,6 +44,8 @@
 #define KBD_LED_AUTO_100_TOKEN	0x02F6
 #define GLOBAL_MIC_MUTE_ENABLE	0x0364
 #define GLOBAL_MIC_MUTE_DISABLE	0x0365
+#define WSMT_EN_TOKEN		0x04EC
+#define WSMT_DIS_TOKEN		0x04ED
 
 struct notifier_block;
 

commit 549b4930f057658dc50d8010e66219233119a4d8
Author: Mario Limonciello <mario.limonciello@dell.com>
Date:   Wed Nov 1 14:25:31 2017 -0500

    platform/x86: dell-smbios: Introduce dispatcher for SMM calls
    
    This splits up the dell-smbios driver into two drivers:
    * dell-smbios
    * dell-smbios-smm
    
    dell-smbios can operate with multiple different dispatcher drivers to
    perform SMBIOS operations.
    
    Also modify the interface that dell-laptop and dell-wmi use align to this
    model more closely.  Rather than a single global buffer being allocated
    for all drivers, each driver will allocate and be responsible for it's own
    buffer. The pointer will be passed to the calling function and each
    dispatcher driver will then internally copy it to the proper location to
    perform it's call.
    
    Add defines for calls used by these methods in the dell-smbios.h header
    for tracking purposes.
    
    Signed-off-by: Mario Limonciello <mario.limonciello@dell.com>
    Reviewed-by: Edward O'Callaghan <quasisec@google.com>
    Signed-off-by: Darren Hart (VMware) <dvhart@infradead.org>

diff --git a/drivers/platform/x86/dell-smbios.h b/drivers/platform/x86/dell-smbios.h
index 742dd8bd66b9..b3179f5b326b 100644
--- a/drivers/platform/x86/dell-smbios.h
+++ b/drivers/platform/x86/dell-smbios.h
@@ -16,6 +16,35 @@
 #ifndef _DELL_SMBIOS_H_
 #define _DELL_SMBIOS_H_
 
+#include <linux/device.h>
+
+/* Classes and selects used in kernel drivers */
+#define CLASS_TOKEN_READ 0
+#define CLASS_TOKEN_WRITE 1
+#define SELECT_TOKEN_STD 0
+#define SELECT_TOKEN_BAT 1
+#define SELECT_TOKEN_AC 2
+#define CLASS_KBD_BACKLIGHT 4
+#define SELECT_KBD_BACKLIGHT 11
+#define CLASS_INFO 17
+#define SELECT_RFKILL 11
+#define SELECT_APP_REGISTRATION	3
+
+/* Tokens used in kernel drivers, any of these
+ * should be filtered from userspace access
+ */
+#define BRIGHTNESS_TOKEN	0x007d
+#define KBD_LED_AC_TOKEN	0x0451
+#define KBD_LED_OFF_TOKEN	0x01E1
+#define KBD_LED_ON_TOKEN	0x01E2
+#define KBD_LED_AUTO_TOKEN	0x01E3
+#define KBD_LED_AUTO_25_TOKEN	0x02EA
+#define KBD_LED_AUTO_50_TOKEN	0x02EB
+#define KBD_LED_AUTO_75_TOKEN	0x02EC
+#define KBD_LED_AUTO_100_TOKEN	0x02F6
+#define GLOBAL_MIC_MUTE_ENABLE	0x0364
+#define GLOBAL_MIC_MUTE_DISABLE	0x0365
+
 struct notifier_block;
 
 /* This structure will be modified by the firmware when we enter
@@ -37,12 +66,19 @@ struct calling_interface_token {
 	};
 };
 
-int dell_smbios_error(int value);
+struct calling_interface_structure {
+	struct dmi_header header;
+	u16 cmdIOAddress;
+	u8 cmdIOCode;
+	u32 supportedCmds;
+	struct calling_interface_token tokens[];
+} __packed;
 
-struct calling_interface_buffer *dell_smbios_get_buffer(void);
-void dell_smbios_clear_buffer(void);
-void dell_smbios_release_buffer(void);
-void dell_smbios_send_request(int class, int select);
+int dell_smbios_register_device(struct device *d, void *call_fn);
+void dell_smbios_unregister_device(struct device *d);
+
+int dell_smbios_error(int value);
+int dell_smbios_call(struct calling_interface_buffer *buffer);
 
 struct calling_interface_token *dell_smbios_find_token(int tokenid);
 

commit f35a8efe2c34496eaf45f8a9bd5bb7625d34bb5c
Author: Mario Limonciello <mario.limonciello@dell.com>
Date:   Wed Nov 1 14:25:22 2017 -0500

    platform/x86: dell-smbios: Prefix class/select with cmd_
    
    Later on these structures will be brought up to userspace.
    the word "class" is a reserved word in c++ and this will prevent
    uapi headers from being included directly in c++ programs.
    
    To make life easier on these applications, prepare the change now.
    
    Signed-off-by: Mario Limonciello <mario.limonciello@dell.com>
    Reviewed-by: Edward O'Callaghan <quasisec@google.com>
    Signed-off-by: Darren Hart (VMware) <dvhart@infradead.org>

diff --git a/drivers/platform/x86/dell-smbios.h b/drivers/platform/x86/dell-smbios.h
index 45cbc2292cd3..742dd8bd66b9 100644
--- a/drivers/platform/x86/dell-smbios.h
+++ b/drivers/platform/x86/dell-smbios.h
@@ -22,8 +22,8 @@ struct notifier_block;
  * system management mode, hence the volatiles */
 
 struct calling_interface_buffer {
-	u16 class;
-	u16 select;
+	u16 cmd_class;
+	u16 cmd_select;
 	volatile u32 input[4];
 	volatile u32 output[4];
 } __packed;

commit 504b02593fc5c24575d7d50d1b388b5ecf9354ee
Author: Hans de Goede <hdegoede@redhat.com>
Date:   Thu Mar 16 11:55:32 2017 +0100

    platform/x86: dell-*: Add a generic dell-laptop notifier chain
    
    There are several cases where events handled in one of the dell-* drivers
    need to be propagated to another dell-* driver.
    
    This commit adds 3 generic functions:
    dell_laptop_register_notifier()
    dell_laptop_unregister_notifier()
    dell_laptop_call_notifier()
    
    It currently only defines 1 action:
    DELL_LAPTOP_KBD_BACKLIGHT_BRIGHTNESS_CHANGED
    
    Which is intended to propagate kbd_backlight_brightness_changed wmi
    events from dell-wmi to dell-laptop (which contains the actual kbd
    backlight driver).
    
    These functions are put in dell-smbios as both dell-wmi and dell-laptop
    use smbios functions and I do not want to put the notifier head in
    either driver, as that will make the 2 drivers depend on each other.
    
    Signed-off-by: Hans de Goede <hdegoede@redhat.com>
    Acked-by: Pali Rohár <pali.rohar@gmail.com>
    Signed-off-by: Darren Hart (VMware) <dvhart@infradead.org>

diff --git a/drivers/platform/x86/dell-smbios.h b/drivers/platform/x86/dell-smbios.h
index ec7d40ae5e6e..45cbc2292cd3 100644
--- a/drivers/platform/x86/dell-smbios.h
+++ b/drivers/platform/x86/dell-smbios.h
@@ -16,6 +16,8 @@
 #ifndef _DELL_SMBIOS_H_
 #define _DELL_SMBIOS_H_
 
+struct notifier_block;
+
 /* This structure will be modified by the firmware when we enter
  * system management mode, hence the volatiles */
 
@@ -43,4 +45,13 @@ void dell_smbios_release_buffer(void);
 void dell_smbios_send_request(int class, int select);
 
 struct calling_interface_token *dell_smbios_find_token(int tokenid);
+
+enum dell_laptop_notifier_actions {
+	DELL_LAPTOP_KBD_BACKLIGHT_BRIGHTNESS_CHANGED,
+};
+
+int dell_laptop_register_notifier(struct notifier_block *nb);
+int dell_laptop_unregister_notifier(struct notifier_block *nb);
+void dell_laptop_call_notifier(unsigned long action, void *data);
+
 #endif

commit 0db2180fce6ada548f03c4f456ba2113753cdba9
Author: Michał Kępień <kernel@kempniu.pl>
Date:   Fri Mar 4 14:09:07 2016 +0100

    dell-smbios: rename dell_smi_error() to dell_smbios_error()
    
    As dell_smi_error() is exported by dell-smbios, its prefix should be
    consistent with other exported symbols, so change function name to
    dell_smbios_error().
    
    Signed-off-by: Michał Kępień <kernel@kempniu.pl>
    Reviewed-by: Pali Rohár <pali.rohar@gmail.com>
    Signed-off-by: Darren Hart <dvhart@linux.intel.com>

diff --git a/drivers/platform/x86/dell-smbios.h b/drivers/platform/x86/dell-smbios.h
index 52febe62d189..ec7d40ae5e6e 100644
--- a/drivers/platform/x86/dell-smbios.h
+++ b/drivers/platform/x86/dell-smbios.h
@@ -35,7 +35,7 @@ struct calling_interface_token {
 	};
 };
 
-int dell_smi_error(int value);
+int dell_smbios_error(int value);
 
 struct calling_interface_buffer *dell_smbios_get_buffer(void);
 void dell_smbios_clear_buffer(void);

commit e8edf53b198f5656d5ae99685bc6c1f616662b3d
Author: Michał Kępień <kernel@kempniu.pl>
Date:   Fri Mar 4 14:09:06 2016 +0100

    dell-laptop: move dell_smi_error() to dell-smbios
    
    The dell_smi_error() method could be used by modules other than
    dell-laptop for convenient translation of SMBIOS request errors into
    errno values.  Thus, move it to dell-smbios.
    
    Signed-off-by: Michał Kępień <kernel@kempniu.pl>
    Reviewed-by: Pali Rohár <pali.rohar@gmail.com>
    Signed-off-by: Darren Hart <dvhart@linux.intel.com>

diff --git a/drivers/platform/x86/dell-smbios.h b/drivers/platform/x86/dell-smbios.h
index 4f69b16f7769..52febe62d189 100644
--- a/drivers/platform/x86/dell-smbios.h
+++ b/drivers/platform/x86/dell-smbios.h
@@ -35,6 +35,8 @@ struct calling_interface_token {
 	};
 };
 
+int dell_smi_error(int value);
+
 struct calling_interface_buffer *dell_smbios_get_buffer(void);
 void dell_smbios_clear_buffer(void);
 void dell_smbios_release_buffer(void);

commit b7bca2d7ff1a232466fa5447ec27e62bf02b310f
Author: Michał Kępień <kernel@kempniu.pl>
Date:   Fri Jan 22 15:27:26 2016 +0100

    dell-smbios: make da_tokens static
    
    As dell-laptop has been changed to use dell_smbios_find_token() instead
    of directly accessing members of the da_tokens table, the latter can be
    marked static.
    
    Signed-off-by: Michał Kępień <kernel@kempniu.pl>
    Reviewed-by: Pali Rohár <pali.rohar@gmail.com>
    Signed-off-by: Darren Hart <dvhart@linux.intel.com>

diff --git a/drivers/platform/x86/dell-smbios.h b/drivers/platform/x86/dell-smbios.h
index f17cf7b26f1d..4f69b16f7769 100644
--- a/drivers/platform/x86/dell-smbios.h
+++ b/drivers/platform/x86/dell-smbios.h
@@ -35,8 +35,6 @@ struct calling_interface_token {
 	};
 };
 
-extern struct calling_interface_token *da_tokens;
-
 struct calling_interface_buffer *dell_smbios_get_buffer(void);
 void dell_smbios_clear_buffer(void);
 void dell_smbios_release_buffer(void);

commit 73511ff30c6dc5347ede4c2a2fa5ab22fae3f152
Author: Michał Kępień <kernel@kempniu.pl>
Date:   Fri Jan 22 15:27:25 2016 +0100

    dell-smbios: remove find_token_{id,location}()
    
    As dell-laptop has been changed to use dell_smbios_find_token() instead
    of find_token_id() and find_token_location(), these functions can be
    safely removed.
    
    Signed-off-by: Michał Kępień <kernel@kempniu.pl>
    Reviewed-by: Pali Rohár <pali.rohar@gmail.com>
    Signed-off-by: Darren Hart <dvhart@linux.intel.com>

diff --git a/drivers/platform/x86/dell-smbios.h b/drivers/platform/x86/dell-smbios.h
index 6f6dbe8b05d4..f17cf7b26f1d 100644
--- a/drivers/platform/x86/dell-smbios.h
+++ b/drivers/platform/x86/dell-smbios.h
@@ -43,7 +43,4 @@ void dell_smbios_release_buffer(void);
 void dell_smbios_send_request(int class, int select);
 
 struct calling_interface_token *dell_smbios_find_token(int tokenid);
-
-int find_token_id(int tokenid);
-int find_token_location(int tokenid);
 #endif

commit 96f7ef90cc373f805a38f2a3e96a8b1948706954
Author: Michał Kępień <kernel@kempniu.pl>
Date:   Fri Jan 22 15:27:22 2016 +0100

    dell-smbios: implement new function for finding DMI table 0xDA tokens
    
    Ultimately, the da_tokens table should not be exported from dell-smbios.
    Currently, in some cases, dell-laptop accesses that table's members
    directly, so implement a new function, dell_smbios_find_token(), which
    returns a pointer to an entry inside the da_tokens table with the given
    token ID (or NULL if it is not found).
    
    Signed-off-by: Michał Kępień <kernel@kempniu.pl>
    Reviewed-by: Pali Rohár <pali.rohar@gmail.com>
    Signed-off-by: Darren Hart <dvhart@linux.intel.com>

diff --git a/drivers/platform/x86/dell-smbios.h b/drivers/platform/x86/dell-smbios.h
index af653ff29b68..6f6dbe8b05d4 100644
--- a/drivers/platform/x86/dell-smbios.h
+++ b/drivers/platform/x86/dell-smbios.h
@@ -42,6 +42,8 @@ void dell_smbios_clear_buffer(void);
 void dell_smbios_release_buffer(void);
 void dell_smbios_send_request(int class, int select);
 
+struct calling_interface_token *dell_smbios_find_token(int tokenid);
+
 int find_token_id(int tokenid);
 int find_token_location(int tokenid);
 #endif

commit 92ebd0d1a80930c52eb091d497d4527c4fe556ca
Author: Michał Kępień <kernel@kempniu.pl>
Date:   Fri Jan 22 15:27:21 2016 +0100

    dell-smbios: make the SMBIOS buffer static
    
    As dell-laptop has been changed to always retrieve a pointer to the
    SMBIOS buffer using dell_smbios_get_buffer(), the SMBIOS buffer can be
    marked static.
    
    Signed-off-by: Michał Kępień <kernel@kempniu.pl>
    Reviewed-by: Pali Rohár <pali.rohar@gmail.com>
    Signed-off-by: Darren Hart <dvhart@linux.intel.com>

diff --git a/drivers/platform/x86/dell-smbios.h b/drivers/platform/x86/dell-smbios.h
index f7a51f5ddeed..af653ff29b68 100644
--- a/drivers/platform/x86/dell-smbios.h
+++ b/drivers/platform/x86/dell-smbios.h
@@ -35,7 +35,6 @@ struct calling_interface_token {
 	};
 };
 
-extern struct calling_interface_buffer *buffer;
 extern struct calling_interface_token *da_tokens;
 
 struct calling_interface_buffer *dell_smbios_get_buffer(void);

commit bc2104c27aad0c988d23c6abcd46f3313618bdbb
Author: Michał Kępień <kernel@kempniu.pl>
Date:   Fri Jan 22 15:27:20 2016 +0100

    dell-smbios: return the SMBIOS buffer from dell_smbios_get_buffer()
    
    Ultimately, the SMBIOS buffer should not be exported from dell-smbios.
    Currently, dell-laptop accesses it directly using a global variable, so
    make dell_smbios_get_buffer() return a pointer to the SMBIOS buffer and
    replace all uses of the global variable with local variables.
    
    Signed-off-by: Michał Kępień <kernel@kempniu.pl>
    Reviewed-by: Pali Rohár <pali.rohar@gmail.com>
    Signed-off-by: Darren Hart <dvhart@linux.intel.com>

diff --git a/drivers/platform/x86/dell-smbios.h b/drivers/platform/x86/dell-smbios.h
index 80b5048f2bd2..f7a51f5ddeed 100644
--- a/drivers/platform/x86/dell-smbios.h
+++ b/drivers/platform/x86/dell-smbios.h
@@ -38,7 +38,7 @@ struct calling_interface_token {
 extern struct calling_interface_buffer *buffer;
 extern struct calling_interface_token *da_tokens;
 
-void dell_smbios_get_buffer(void);
+struct calling_interface_buffer *dell_smbios_get_buffer(void);
 void dell_smbios_clear_buffer(void);
 void dell_smbios_release_buffer(void);
 void dell_smbios_send_request(int class, int select);

commit c42831c8a9db32a5a0e2c6c31042014039f11739
Author: Michał Kępień <kernel@kempniu.pl>
Date:   Fri Jan 22 15:27:19 2016 +0100

    dell-smbios: don't return an SMBIOS buffer from dell_smbios_send_request()
    
    An SMBIOS buffer pointer does not need to be returned by
    dell_smbios_send_request(), because SMBIOS call results are stored in
    the buffer exported by the module.
    
    Signed-off-by: Michał Kępień <kernel@kempniu.pl>
    Reviewed-by: Pali Rohár <pali.rohar@gmail.com>
    Signed-off-by: Darren Hart <dvhart@linux.intel.com>

diff --git a/drivers/platform/x86/dell-smbios.h b/drivers/platform/x86/dell-smbios.h
index 4220ac1fe703..80b5048f2bd2 100644
--- a/drivers/platform/x86/dell-smbios.h
+++ b/drivers/platform/x86/dell-smbios.h
@@ -41,8 +41,7 @@ extern struct calling_interface_token *da_tokens;
 void dell_smbios_get_buffer(void);
 void dell_smbios_clear_buffer(void);
 void dell_smbios_release_buffer(void);
-struct calling_interface_buffer *
-dell_smbios_send_request(int class, int select);
+void dell_smbios_send_request(int class, int select);
 
 int find_token_id(int tokenid);
 int find_token_location(int tokenid);

commit 17070f242aa989c33b227e61ea060f768a77f2dc
Author: Michał Kępień <kernel@kempniu.pl>
Date:   Fri Jan 22 15:27:18 2016 +0100

    dell-smbios: don't pass an SMBIOS buffer to dell_smbios_send_request()
    
    Passing an SMBIOS buffer pointer to dell_smbios_send_request() is
    redundant as it should always operate on the SMBIOS buffer exported from
    the module.
    
    Signed-off-by: Michał Kępień <kernel@kempniu.pl>
    Reviewed-by: Pali Rohár <pali.rohar@gmail.com>
    Signed-off-by: Darren Hart <dvhart@linux.intel.com>

diff --git a/drivers/platform/x86/dell-smbios.h b/drivers/platform/x86/dell-smbios.h
index 33ed9712430b..4220ac1fe703 100644
--- a/drivers/platform/x86/dell-smbios.h
+++ b/drivers/platform/x86/dell-smbios.h
@@ -42,8 +42,7 @@ void dell_smbios_get_buffer(void);
 void dell_smbios_clear_buffer(void);
 void dell_smbios_release_buffer(void);
 struct calling_interface_buffer *
-dell_smbios_send_request(struct calling_interface_buffer *buffer,
-			 int class, int select);
+dell_smbios_send_request(int class, int select);
 
 int find_token_id(int tokenid);
 int find_token_location(int tokenid);

commit 2f262136159fedceb45b42336ae53f20bc0ff714
Author: Michał Kępień <kernel@kempniu.pl>
Date:   Fri Jan 22 15:27:17 2016 +0100

    dell-smbios: rename dell_send_request() to dell_smbios_send_request()
    
    As dell_send_request() is exported from the module, its prefix should be
    consistent with other exported symbols, so change function name to
    dell_smbios_send_request().
    
    Signed-off-by: Michał Kępień <kernel@kempniu.pl>
    Reviewed-by: Pali Rohár <pali.rohar@gmail.com>
    Signed-off-by: Darren Hart <dvhart@linux.intel.com>

diff --git a/drivers/platform/x86/dell-smbios.h b/drivers/platform/x86/dell-smbios.h
index 85581037a547..33ed9712430b 100644
--- a/drivers/platform/x86/dell-smbios.h
+++ b/drivers/platform/x86/dell-smbios.h
@@ -42,8 +42,8 @@ void dell_smbios_get_buffer(void);
 void dell_smbios_clear_buffer(void);
 void dell_smbios_release_buffer(void);
 struct calling_interface_buffer *
-dell_send_request(struct calling_interface_buffer *buffer,
-		  int class, int select);
+dell_smbios_send_request(struct calling_interface_buffer *buffer,
+			 int class, int select);
 
 int find_token_id(int tokenid);
 int find_token_location(int tokenid);

commit cb16176380cca991dba162952941ad04ae760d0e
Author: Michał Kępień <kernel@kempniu.pl>
Date:   Fri Jan 22 15:27:16 2016 +0100

    dell-smbios: rename release_buffer() to dell_smbios_release_buffer()
    
    As release_buffer() is exported from the module, it has to be renamed to
    something less generic, so add a "dell_smbios_" prefix to the function
    name.
    
    Signed-off-by: Michał Kępień <kernel@kempniu.pl>
    Reviewed-by: Pali Rohár <pali.rohar@gmail.com>
    Signed-off-by: Darren Hart <dvhart@linux.intel.com>

diff --git a/drivers/platform/x86/dell-smbios.h b/drivers/platform/x86/dell-smbios.h
index c5e94742505b..85581037a547 100644
--- a/drivers/platform/x86/dell-smbios.h
+++ b/drivers/platform/x86/dell-smbios.h
@@ -40,7 +40,7 @@ extern struct calling_interface_token *da_tokens;
 
 void dell_smbios_get_buffer(void);
 void dell_smbios_clear_buffer(void);
-void release_buffer(void);
+void dell_smbios_release_buffer(void);
 struct calling_interface_buffer *
 dell_send_request(struct calling_interface_buffer *buffer,
 		  int class, int select);

commit b6aa7e1817a35b93550283707dc93c98d41813eb
Author: Michał Kępień <kernel@kempniu.pl>
Date:   Fri Jan 22 15:27:15 2016 +0100

    dell-smbios: rename clear_buffer() to dell_smbios_clear_buffer()
    
    As clear_buffer() is exported from the module, it has to be renamed to
    something less generic, so add a "dell_smbios_" prefix to the function
    name.
    
    Signed-off-by: Michał Kępień <kernel@kempniu.pl>
    Reviewed-by: Pali Rohár <pali.rohar@gmail.com>
    Signed-off-by: Darren Hart <dvhart@linux.intel.com>

diff --git a/drivers/platform/x86/dell-smbios.h b/drivers/platform/x86/dell-smbios.h
index ace16c128a77..c5e94742505b 100644
--- a/drivers/platform/x86/dell-smbios.h
+++ b/drivers/platform/x86/dell-smbios.h
@@ -39,7 +39,7 @@ extern struct calling_interface_buffer *buffer;
 extern struct calling_interface_token *da_tokens;
 
 void dell_smbios_get_buffer(void);
-void clear_buffer(void);
+void dell_smbios_clear_buffer(void);
 void release_buffer(void);
 struct calling_interface_buffer *
 dell_send_request(struct calling_interface_buffer *buffer,

commit ee83c475415edd48b0739bee230b75454b82199e
Author: Michał Kępień <kernel@kempniu.pl>
Date:   Fri Jan 22 15:27:14 2016 +0100

    dell-smbios: rename get_buffer() to dell_smbios_get_buffer()
    
    As get_buffer() is exported from the module, it has to be renamed to
    something less generic, so add a "dell_smbios_" prefix to the function
    name.
    
    Signed-off-by: Michał Kępień <kernel@kempniu.pl>
    Reviewed-by: Pali Rohár <pali.rohar@gmail.com>
    Signed-off-by: Darren Hart <dvhart@linux.intel.com>

diff --git a/drivers/platform/x86/dell-smbios.h b/drivers/platform/x86/dell-smbios.h
index 3bc9080e4c5d..ace16c128a77 100644
--- a/drivers/platform/x86/dell-smbios.h
+++ b/drivers/platform/x86/dell-smbios.h
@@ -38,7 +38,7 @@ struct calling_interface_token {
 extern struct calling_interface_buffer *buffer;
 extern struct calling_interface_token *da_tokens;
 
-void get_buffer(void);
+void dell_smbios_get_buffer(void);
 void clear_buffer(void);
 void release_buffer(void);
 struct calling_interface_buffer *

commit 2f9f26bd8614740b3c3b950394d945a99492a28e
Author: Michał Kępień <kernel@kempniu.pl>
Date:   Fri Jan 22 15:27:13 2016 +0100

    dell-laptop: extract SMBIOS-related code to a separate module
    
    Extract SMBIOS-related code from dell-laptop to a new kernel module,
    dell-smbios.  The static specifier is removed from exported symbols,
    otherwise code is just moved around.
    
    Signed-off-by: Michał Kępień <kernel@kempniu.pl>
    Reviewed-by: Pali Rohár <pali.rohar@gmail.com>
    [dvhart: Include linux/io.h in dell-smbios.c as caught by lkp]
    Signed-off-by: Darren Hart <dvhart@linux.intel.com>

diff --git a/drivers/platform/x86/dell-smbios.h b/drivers/platform/x86/dell-smbios.h
new file mode 100644
index 000000000000..3bc9080e4c5d
--- /dev/null
+++ b/drivers/platform/x86/dell-smbios.h
@@ -0,0 +1,50 @@
+/*
+ *  Common functions for kernel modules using Dell SMBIOS
+ *
+ *  Copyright (c) Red Hat <mjg@redhat.com>
+ *  Copyright (c) 2014 Gabriele Mazzotta <gabriele.mzt@gmail.com>
+ *  Copyright (c) 2014 Pali Rohár <pali.rohar@gmail.com>
+ *
+ *  Based on documentation in the libsmbios package:
+ *  Copyright (C) 2005-2014 Dell Inc.
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License version 2 as
+ *  published by the Free Software Foundation.
+ */
+
+#ifndef _DELL_SMBIOS_H_
+#define _DELL_SMBIOS_H_
+
+/* This structure will be modified by the firmware when we enter
+ * system management mode, hence the volatiles */
+
+struct calling_interface_buffer {
+	u16 class;
+	u16 select;
+	volatile u32 input[4];
+	volatile u32 output[4];
+} __packed;
+
+struct calling_interface_token {
+	u16 tokenID;
+	u16 location;
+	union {
+		u16 value;
+		u16 stringlength;
+	};
+};
+
+extern struct calling_interface_buffer *buffer;
+extern struct calling_interface_token *da_tokens;
+
+void get_buffer(void);
+void clear_buffer(void);
+void release_buffer(void);
+struct calling_interface_buffer *
+dell_send_request(struct calling_interface_buffer *buffer,
+		  int class, int select);
+
+int find_token_id(int tokenid);
+int find_token_location(int tokenid);
+#endif
