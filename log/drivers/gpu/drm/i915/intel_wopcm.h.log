commit 6bd0fbe156f1cc5dc97590ce994d1848f593569e
Author: Michal Wajdeczko <michal.wajdeczko@intel.com>
Date:   Fri Aug 2 18:40:55 2019 +0000

    drm/i915/wopcm: Don't fail on WOPCM partitioning failure
    
    We don't have to immediately fail on WOPCM partitioning, we can wait
    until we will start programming WOPCM registers. This should give us
    more options if we decide to restore fallback in case of GuC failures.
    
    v3: rebased
    
    Signed-off-by: Michal Wajdeczko <michal.wajdeczko@intel.com>
    Cc: Daniele Ceraolo Spurio <daniele.ceraolospurio@intel.com>
    Cc: Chris Wilson <chris@chris-wilson.co.uk>
    Reviewed-by: Chris Wilson <chris@chris-wilson.co.uk>
    Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
    Link: https://patchwork.freedesktop.org/patch/msgid/20190802184055.31988-7-michal.wajdeczko@intel.com

diff --git a/drivers/gpu/drm/i915/intel_wopcm.h b/drivers/gpu/drm/i915/intel_wopcm.h
index f9b603205bb1..17d6aa86008a 100644
--- a/drivers/gpu/drm/i915/intel_wopcm.h
+++ b/drivers/gpu/drm/i915/intel_wopcm.h
@@ -55,6 +55,6 @@ static inline u32 intel_wopcm_guc_size(struct intel_wopcm *wopcm)
 }
 
 void intel_wopcm_init_early(struct intel_wopcm *wopcm);
-int intel_wopcm_init(struct intel_wopcm *wopcm);
+void intel_wopcm_init(struct intel_wopcm *wopcm);
 
 #endif

commit 63064d822c964c04107ead05b64eddccfa142005
Author: Daniele Ceraolo Spurio <daniele.ceraolospurio@intel.com>
Date:   Tue Jul 30 16:07:40 2019 -0700

    drm/i915/uc: Move uC WOPCM setup in uc_init_hw
    
    The register we write are not WOPCM regs but uC ones related to how
    GuC and HuC are going to use the WOPCM, so it makes logical sense
    for them to be programmed as part of uc_init_hw. The WOPCM map on the
    other side is not uC-specific (although that is our main use-case), so
    keep that separate.
    
    v2: move write_and_verify to uncore, fix log, re-use err_out tag,
        add intel_wopcm_guc_base, fix log
    
    Signed-off-by: Daniele Ceraolo Spurio <daniele.ceraolospurio@intel.com>
    Cc: Michal Wajdeczko <michal.wajdeczko@intel.com>
    Cc: Chris Wilson <chris@chris-wilson.co.uk>
    Reviewed-by: Chris Wilson <chris@chris-wilson.co.uk>
    Reviewed-by: Michal Wajdeczko <michal.wajdeczko@intel.com>
    Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
    Link: https://patchwork.freedesktop.org/patch/msgid/20190730230743.19542-2-daniele.ceraolospurio@intel.com

diff --git a/drivers/gpu/drm/i915/intel_wopcm.h b/drivers/gpu/drm/i915/intel_wopcm.h
index 56aaed4d64ff..f9b603205bb1 100644
--- a/drivers/gpu/drm/i915/intel_wopcm.h
+++ b/drivers/gpu/drm/i915/intel_wopcm.h
@@ -9,8 +9,6 @@
 
 #include <linux/types.h>
 
-struct intel_gt;
-
 /**
  * struct intel_wopcm - Overall WOPCM info and WOPCM regions.
  * @size: Size of overall WOPCM.
@@ -26,6 +24,21 @@ struct intel_wopcm {
 	} guc;
 };
 
+/**
+ * intel_wopcm_guc_base()
+ * @wopcm:	intel_wopcm structure
+ *
+ * Returns the base of the WOPCM shadowed region.
+ *
+ * Returns:
+ * 0 if GuC is not present or not in use.
+ * Otherwise, the GuC WOPCM base.
+ */
+static inline u32 intel_wopcm_guc_base(struct intel_wopcm *wopcm)
+{
+	return wopcm->guc.base;
+}
+
 /**
  * intel_wopcm_guc_size()
  * @wopcm:	intel_wopcm structure
@@ -43,6 +56,5 @@ static inline u32 intel_wopcm_guc_size(struct intel_wopcm *wopcm)
 
 void intel_wopcm_init_early(struct intel_wopcm *wopcm);
 int intel_wopcm_init(struct intel_wopcm *wopcm);
-int intel_wopcm_init_hw(struct intel_wopcm *wopcm, struct intel_gt *gt);
 
 #endif

commit 6b0a8dfdf27e6d6a180598b6ff6b205d9055d975
Author: Tvrtko Ursulin <tvrtko.ursulin@intel.com>
Date:   Fri Jun 21 08:07:55 2019 +0100

    drm/i915: Stop using I915_READ/WRITE in intel_wopcm_init_hw
    
    More legacy mmio accessor removal. We pass in intel_gt explicitly allowing
    code to use new intel_uncore_read/write helpers.
    
    Signed-off-by: Tvrtko Ursulin <tvrtko.ursulin@intel.com>
    Reviewed-by: Rodrigo Vivi <rodrigo.vivi@intel.com>
    Link: https://patchwork.freedesktop.org/patch/msgid/20190621070811.7006-17-tvrtko.ursulin@linux.intel.com

diff --git a/drivers/gpu/drm/i915/intel_wopcm.h b/drivers/gpu/drm/i915/intel_wopcm.h
index 114401971520..56aaed4d64ff 100644
--- a/drivers/gpu/drm/i915/intel_wopcm.h
+++ b/drivers/gpu/drm/i915/intel_wopcm.h
@@ -9,6 +9,8 @@
 
 #include <linux/types.h>
 
+struct intel_gt;
+
 /**
  * struct intel_wopcm - Overall WOPCM info and WOPCM regions.
  * @size: Size of overall WOPCM.
@@ -41,6 +43,6 @@ static inline u32 intel_wopcm_guc_size(struct intel_wopcm *wopcm)
 
 void intel_wopcm_init_early(struct intel_wopcm *wopcm);
 int intel_wopcm_init(struct intel_wopcm *wopcm);
-int intel_wopcm_init_hw(struct intel_wopcm *wopcm);
+int intel_wopcm_init_hw(struct intel_wopcm *wopcm, struct intel_gt *gt);
 
 #endif

commit 9937e16b2820d141df2ba9845c19d3b7bc31fd7b
Author: Tvrtko Ursulin <tvrtko.ursulin@intel.com>
Date:   Tue Jun 11 12:00:43 2019 +0100

    drm/i915/guc: Move intel_guc_reserved_gtt_size to intel_wopcm_guc_size
    
    Reduces pointer chasing and gets more to the point.
    
    v2:
     * Tidy whitespace.
     * Tidy comment. (Michal)
    
    Signed-off-by: Tvrtko Ursulin <tvrtko.ursulin@intel.com>
    Suggested-by: Michal Wajdeczko <michal.wajdeczko@intel.com>
    Cc: Michal Wajdeczko <michal.wajdeczko@intel.com>
    Reviewed-by: Michal Wajdeczko <michal.wajdeczko@intel.com>
    Link: https://patchwork.freedesktop.org/patch/msgid/20190611110044.7742-1-tvrtko.ursulin@linux.intel.com

diff --git a/drivers/gpu/drm/i915/intel_wopcm.h b/drivers/gpu/drm/i915/intel_wopcm.h
index 6298910a384c..114401971520 100644
--- a/drivers/gpu/drm/i915/intel_wopcm.h
+++ b/drivers/gpu/drm/i915/intel_wopcm.h
@@ -24,6 +24,21 @@ struct intel_wopcm {
 	} guc;
 };
 
+/**
+ * intel_wopcm_guc_size()
+ * @wopcm:	intel_wopcm structure
+ *
+ * Returns size of the WOPCM shadowed region.
+ *
+ * Returns:
+ * 0 if GuC is not present or not in use.
+ * Otherwise, the GuC WOPCM size.
+ */
+static inline u32 intel_wopcm_guc_size(struct intel_wopcm *wopcm)
+{
+	return wopcm->guc.size;
+}
+
 void intel_wopcm_init_early(struct intel_wopcm *wopcm);
 int intel_wopcm_init(struct intel_wopcm *wopcm);
 int intel_wopcm_init_hw(struct intel_wopcm *wopcm);

commit f08e2035cc089caf52ce57e855d96ba6ba90c71a
Author: Jackie Li <yaodong.li@intel.com>
Date:   Tue Mar 13 17:32:53 2018 -0700

    drm/i915/guc: Check the locking status of GuC WOPCM registers
    
    GuC WOPCM registers are write-once registers. Current driver code accesses
    these registers without checking the accessibility to these registers which
    will lead to unpredictable driver behaviors if these registers were touch
    by other components (such as faulty BIOS code).
    
    This patch moves the GuC WOPCM registers updating code into intel_wopcm.c
    and adds check before and after the update to GuC WOPCM registers so that
    we can make sure the driver is in a known state after writing to these
    write-once registers.
    
    v6:
     - Made sure module reloading won't bug the kernel while doing
       locking status checking
    
    v7:
     - Fixed patch format issues
    
    v8:
     - Fixed coding style issue on register lock bit macro definition (Sagar)
    
    v9:
     - Avoided to use redundant !! to cast uint to bool (Chris)
     - Return error code instead of GEM_BUG_ON for locked with invalid register
       values case (Sagar)
     - Updated guc_wopcm_hw_init to use guc_wopcm as first parameter (Michal)
     - Added code to set and validate the HuC_LOADING_AGENT_GUC bit in GuC
       WOPCM offset register based on the presence of HuC firmware (Michal)
     - Use bit fields instead of macros for GuC WOPCM flags (Michal)
    
    v10:
     - Refined variable names, removed redundant comments (Joonas)
     - Introduced lockable_reg to handle the write once register write and
       propagate the write error to caller (Joonas)
     - Used lockable_reg abstraction to avoid locking bit check on generic
       i915_reg_t (Michal)
     - Added log message for error paths (Michal)
     - Removed hw_updated flag and only relies on real hardware status
    
    v11:
     - Replaced lockable_reg with simplified function (Michal)
     - Used new macros for locking bits of WOPCM size/offset registers instead
       of using BIT(0) directly (Michal)
     - use intel_wopcm_init_hw() called from intel_gem_init_hw() to do GuC
       WOPCM register setup instead of calling from intel_uc_init_hw() (Michal)
    
    v12:
     - Updated function kernel-doc to align with code changes (Michal)
     - Updated code to use wopcm pointer directly (Michal)
    
    v13:
     - Updated the ordering of s-o-b/cc/r-b tags (Sagar)
    
    BSpec: 10875, 10833
    
    Signed-off-by: Jackie Li <yaodong.li@intel.com>
    Cc: Michal Wajdeczko <michal.wajdeczko@intel.com>
    Cc: Chris Wilson <chris@chris-wilson.co.uk>
    Cc: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
    Reviewed-by: Michal Wajdeczko <michal.wajdeczko@intel.com> (v11)
    Reviewed-by: Joonas Lahtinen <joonas.lahtinen@linux.intel.com> (v12)
    Reviewed-by: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
    Signed-off-by: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
    Link: https://patchwork.freedesktop.org/patch/msgid/1520987574-19351-5-git-send-email-yaodong.li@intel.com

diff --git a/drivers/gpu/drm/i915/intel_wopcm.h b/drivers/gpu/drm/i915/intel_wopcm.h
index 93c402ca7489..6298910a384c 100644
--- a/drivers/gpu/drm/i915/intel_wopcm.h
+++ b/drivers/gpu/drm/i915/intel_wopcm.h
@@ -26,5 +26,6 @@ struct intel_wopcm {
 
 void intel_wopcm_init_early(struct intel_wopcm *wopcm);
 int intel_wopcm_init(struct intel_wopcm *wopcm);
+int intel_wopcm_init_hw(struct intel_wopcm *wopcm);
 
 #endif

commit 6b0478fb722ae638ad747e17251e90bbf1b7969b
Author: Jackie Li <yaodong.li@intel.com>
Date:   Tue Mar 13 17:32:50 2018 -0700

    drm/i915: Implement dynamic GuC WOPCM offset and size calculation
    
    Hardware may have specific restrictions on GuC WOPCM offset and size. On
    Gen9, the value of the GuC WOPCM size register needs to be larger than the
    value of GuC WOPCM offset register + a Gen9 specific offset (144KB) for
    reserved GuC WOPCM. Fail to enforce such a restriction on GuC WOPCM size
    will lead to GuC firmware execution failures. On the other hand, with
    current static GuC WOPCM offset and size values (512KB for both offset and
    size), the GuC WOPCM size verification will fail on Gen9 even if it can be
    fixed by lowering the GuC WOPCM offset by calculating its value based on
    HuC firmware size (which is likely less than 200KB on Gen9), so that we can
    have a GuC WOPCM size value which is large enough to pass the GuC WOPCM
    size check.
    
    This patch updates the reserved GuC WOPCM size for RC6 context on Gen9 to
    24KB to strictly align with the Gen9 GuC WOPCM layout. It also adds support
    to verify the GuC WOPCM size aganist the Gen9 hardware restrictions. To
    meet all above requirements, let's provide dynamic partitioning of the
    WOPCM that will be based on platform specific HuC/GuC firmware sizes.
    
    v2:
     - Removed intel_wopcm_init (Ville/Sagar/Joonas)
     - Renamed and Moved the intel_wopcm_partition into intel_guc (Sagar)
     - Removed unnecessary function calls (Joonas)
     - Init GuC WOPCM partition as soon as firmware fetching is completed
    
    v3:
     - Fixed indentation issues (Chris)
     - Removed layering violation code (Chris/Michal)
     - Created separat files for GuC wopcm code  (Michal)
     - Used inline function to avoid code duplication (Michal)
    
    v4:
     - Preset the GuC WOPCM top during early GuC init (Chris)
     - Fail intel_uc_init_hw() as soon as GuC WOPCM partitioning failed
    
    v5:
     - Moved GuC DMA WOPCM register updating code into intel_wopcm.c
     - Took care of the locking status before writing to GuC DMA
       Write-Once registers. (Joonas)
    
    v6:
     - Made sure the GuC WOPCM size to be multiple of 4K (4K aligned)
    
    v8:
     - Updated comments and fixed naming issues (Sagar/Joonas)
     - Updated commit message to include more description about the hardware
       restriction on GuC WOPCM size (Sagar)
    
    v9:
     - Minor changes variable names and code comments (Sagar)
     - Added detailed GuC WOPCM layout drawing (Sagar/Michal)
     - Refined macro definitions to be reader friendly (Michal)
     - Removed redundent check to valid flag (Michal)
     - Unified first parameter for exported GuC WOPCM functions (Michal)
     - Refined the name and parameter list of hardware restriction checking
       functions (Michal)
    
    v10:
     - Used shorter function name for internal functions (Joonas)
     - Moved init-ealry function into c file (Joonas)
     - Consolidated and removed redundant size checks (Joonas/Michal)
     - Removed unnecessary unlikely() from code which is only called once
       during boot (Joonas)
     - More fixes to kernel-doc format and content (Michal)
     - Avoided the use of PAGE_MASK for 4K pages (Michal)
     - Added error log messages to error paths (Michal)
    
    v11:
     - Replaced intel_guc_wopcm with more generic intel_wopcm and attached
       intel_wopcm to drm_i915_private instead intel_guc (Michal)
     - dynamic calculation of GuC non-wopcm memory start (a.k.a WOPCM Top
       offset from GuC WOPCM base) (Michal)
     - Moved WOPCM marco definitions into .c source file (Michal)
     - Exported WOPCM layout diagram as kernel-doc (Michal)
    
    v12:
     - Updated naming, function kernel-doc to align with new changes (Michal)
    
    v13:
     - Updated the ordering of s-o-b/cc/r-b tags (Sagar)
     - Corrected one tense error in comment (Sagar)
     - Corrected typos and removed spurious comments (Joonas)
    
    Bspec: 12690
    
    Signed-off-by: Jackie Li <yaodong.li@intel.com>
    Cc: Michal Wajdeczko <michal.wajdeczko@intel.com>
    Cc: Sagar Arun Kamble <sagar.a.kamble@intel.com>
    Cc: Sujaritha Sundaresan <sujaritha.sundaresan@intel.com>
    Cc: Daniele Ceraolo Spurio <daniele.ceraolospurio@intel.com>
    Cc: John Spotswood <john.a.spotswood@intel.com>
    Cc: Oscar Mateo <oscar.mateo@intel.com>
    Cc: Chris Wilson <chris@chris-wilson.co.uk>
    Cc: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
    Reviewed-by: Sagar Arun Kamble <sagar.a.kamble@intel.com> (v8)
    Reviewed-by: Joonas Lahtinen <joonas.lahtinen@linux.intel.com> (v9)
    Reviewed-by: Michal Wajdeczko <michal.wajdeczko@intel.com> (v11)
    Reviewed-by: Joonas Lahtinen <joonas.lahtinen@linux.intel.com> (v12)
    Reviewed-by: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
    Signed-off-by: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
    Link: https://patchwork.freedesktop.org/patch/msgid/1520987574-19351-2-git-send-email-yaodong.li@intel.com

diff --git a/drivers/gpu/drm/i915/intel_wopcm.h b/drivers/gpu/drm/i915/intel_wopcm.h
new file mode 100644
index 000000000000..93c402ca7489
--- /dev/null
+++ b/drivers/gpu/drm/i915/intel_wopcm.h
@@ -0,0 +1,30 @@
+/*
+ * SPDX-License-Identifier: MIT
+ *
+ * Copyright Â© 2017-2018 Intel Corporation
+ */
+
+#ifndef _INTEL_WOPCM_H_
+#define _INTEL_WOPCM_H_
+
+#include <linux/types.h>
+
+/**
+ * struct intel_wopcm - Overall WOPCM info and WOPCM regions.
+ * @size: Size of overall WOPCM.
+ * @guc: GuC WOPCM Region info.
+ * @guc.base: GuC WOPCM base which is offset from WOPCM base.
+ * @guc.size: Size of the GuC WOPCM region.
+ */
+struct intel_wopcm {
+	u32 size;
+	struct {
+		u32 base;
+		u32 size;
+	} guc;
+};
+
+void intel_wopcm_init_early(struct intel_wopcm *wopcm);
+int intel_wopcm_init(struct intel_wopcm *wopcm);
+
+#endif
