commit 419e2f50833661cec15200d5ee7385daee733667
Author: Sylwester Nawrocki <s.nawrocki@samsung.com>
Date:   Fri Sep 20 15:02:12 2019 +0200

    ASoC: wm8994: Add support for setting MCLK clock rate
    
    Extend the set_sysclk() handler so we also set frequency of the MCLK1,
    MCLK2 clocks through clk API when those clocks are specified in DT.
    
    Reviewed-by: Charles Keepax <ckeepax@opensource.cirrus.com>
    Acked-by: Krzysztof Kozlowski <krzk@kernel.org>
    Signed-off-by: Sylwester Nawrocki <s.nawrocki@samsung.com>
    Acked-by: Krzysztof Kozlowski <krzk@kernel.org>
    Link: https://lore.kernel.org/r/20190920130218.32690-4-s.nawrocki@samsung.com
    Signed-off-by: Mark Brown <broonie@kernel.org>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index 1d6f2abe1c11..41c4b126114d 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -6,6 +6,7 @@
 #ifndef _WM8994_H
 #define _WM8994_H
 
+#include <linux/clk.h>
 #include <sound/soc.h>
 #include <linux/firmware.h>
 #include <linux/completion.h>
@@ -14,6 +15,12 @@
 
 #include "wm_hubs.h"
 
+enum {
+	WM8994_MCLK1,
+	WM8994_MCLK2,
+	WM8994_NUM_MCLK
+};
+
 /* Sources for AIF1/2 SYSCLK - use with set_dai_sysclk() */
 #define WM8994_SYSCLK_MCLK1 1
 #define WM8994_SYSCLK_MCLK2 2
@@ -73,9 +80,10 @@ struct wm8994;
 struct wm8994_priv {
 	struct wm_hubs_data hubs;
 	struct wm8994 *wm8994;
+	struct clk_bulk_data mclk[WM8994_NUM_MCLK];
 	int sysclk[2];
 	int sysclk_rate[2];
-	int mclk[2];
+	int mclk_rate[2];
 	int aifclk[2];
 	int aifdiv[2];
 	int channels[2];

commit d2912cb15bdda8ba4a5dd73396ad62641af2f520
Author: Thomas Gleixner <tglx@linutronix.de>
Date:   Tue Jun 4 10:11:33 2019 +0200

    treewide: Replace GPLv2 boilerplate/reference with SPDX - rule 500
    
    Based on 2 normalized pattern(s):
    
      this program is free software you can redistribute it and or modify
      it under the terms of the gnu general public license version 2 as
      published by the free software foundation
    
      this program is free software you can redistribute it and or modify
      it under the terms of the gnu general public license version 2 as
      published by the free software foundation #
    
    extracted by the scancode license scanner the SPDX license identifier
    
      GPL-2.0-only
    
    has been chosen to replace the boilerplate/reference in 4122 file(s).
    
    Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
    Reviewed-by: Enrico Weigelt <info@metux.net>
    Reviewed-by: Kate Stewart <kstewart@linuxfoundation.org>
    Reviewed-by: Allison Randal <allison@lohutok.net>
    Cc: linux-spdx@vger.kernel.org
    Link: https://lkml.kernel.org/r/20190604081206.933168790@linutronix.de
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index a72efb0e6867..1d6f2abe1c11 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -1,9 +1,6 @@
+/* SPDX-License-Identifier: GPL-2.0-only */
 /*
  * wm8994.h  --  WM8994 Soc Audio driver
- *
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License version 2 as
- * published by the Free Software Foundation.
  */
 
 #ifndef _WM8994_H

commit 00a6941c841205fbdade825219a828c81008149b
Author: Kuninori Morimoto <kuninori.morimoto.gx@renesas.com>
Date:   Mon Jan 29 03:12:21 2018 +0000

    ASoC: wm8993/wm8994/wm8958: replace codec to component
    
    Now we can replace Codec to Component. Let's do it.
    
    Becase wm8993/wm8994/wm8958 are using wm_hubs feature,
    we need to update these all related drivers in same time.
    Otherwise compile error/warning happen
    
    wm8993:
            xxx_codec_xxx()         ->      xxx_component_xxx()
            .idle_bias_off = 0      ->      .idle_bias_on = 1
            .ignore_pmdown_time = 0 ->      .use_pmdown_time = 1
            -                       ->      .endianness = 1
            -                       ->      .non_legacy_dai_naming = 1
    
    wm8994:
            xxx_codec_xxx()         ->      xxx_component_xxx()
            .idle_bias_off = 0      ->      .idle_bias_on = 1
            .ignore_pmdown_time = 0 ->      .use_pmdown_time = 1
            -                       ->      .endianness = 1
            -                       ->      .non_legacy_dai_naming = 1
    
    Signed-off-by: Kuninori Morimoto <kuninori.morimoto.gx@renesas.com>
    Signed-off-by: Mark Brown <broonie@kernel.org>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index dd73387b1cc4..a72efb0e6867 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -43,18 +43,18 @@ enum wm8994_vmid_mode {
 typedef void (*wm1811_micdet_cb)(void *data);
 typedef void (*wm1811_mic_id_cb)(void *data, u16 status);
 
-int wm8994_mic_detect(struct snd_soc_codec *codec, struct snd_soc_jack *jack,
+int wm8994_mic_detect(struct snd_soc_component *component, struct snd_soc_jack *jack,
 		      int micbias);
-int wm8958_mic_detect(struct snd_soc_codec *codec, struct snd_soc_jack *jack,
+int wm8958_mic_detect(struct snd_soc_component *component, struct snd_soc_jack *jack,
 		      wm1811_micdet_cb cb, void *det_cb_data,
 		      wm1811_mic_id_cb id_cb, void *id_cb_data);
 
-int wm8994_vmid_mode(struct snd_soc_codec *codec, enum wm8994_vmid_mode mode);
+int wm8994_vmid_mode(struct snd_soc_component *component, enum wm8994_vmid_mode mode);
 
 int wm8958_aif_ev(struct snd_soc_dapm_widget *w,
 		  struct snd_kcontrol *kcontrol, int event);
 
-void wm8958_dsp2_init(struct snd_soc_codec *codec);
+void wm8958_dsp2_init(struct snd_soc_component *component);
 
 struct wm8994_micdet {
 	struct snd_soc_jack *jack;

commit fabfad2f8b23529722c6ef5b3537c457e63d2c82
Author: Lars-Peter Clausen <lars@metafoo.de>
Date:   Sun Nov 9 17:01:02 2014 +0100

    ASoC: wm8958: Move DSP firmware lock to driver level
    
    The wm8958 driver uses the snd_soc_codec mutex to protect the various
    firmware pointers from concurrent assignment. This patch moves this lock to
    the driver level. This will allow us to eventually remove the snd_soc_codec
    mutex.
    
    Signed-off-by: Lars-Peter Clausen <lars@metafoo.de>
    Acked-by: Charles Keepax <ckeepax@opensource.wolfsonmicro.com>
    Signed-off-by: Mark Brown <broonie@kernel.org>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index 6536f8d45ac6..dd73387b1cc4 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -13,6 +13,7 @@
 #include <linux/firmware.h>
 #include <linux/completion.h>
 #include <linux/workqueue.h>
+#include <linux/mutex.h>
 
 #include "wm_hubs.h"
 
@@ -156,6 +157,7 @@ struct wm8994_priv {
 	unsigned int aif1clk_disable:1;
 	unsigned int aif2clk_disable:1;
 
+	struct mutex fw_lock;
 	int dsp_active;
 	const struct firmware *cur_fw;
 	const struct firmware *mbc;

commit 2da1c4bf765cb32024e5db6fa75dab92916fa3b1
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Thu May 30 13:42:29 2013 +0100

    ASoC: wm8994: Allow debounce before MICDET identification
    
    For systems which do not have a jack detection feature allow some debounce
    to be specified before we perform accessory identification, improving
    robustness without impacting button detection responsiveness.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index 9d19a9185d35..6536f8d45ac6 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -135,6 +135,8 @@ struct wm8994_priv {
 	struct wm8994_micdet micdet[2];
 	struct delayed_work mic_work;
 	struct delayed_work open_circuit_work;
+	struct delayed_work mic_complete_work;
+	u16 mic_status;
 	bool mic_detecting;
 	bool jack_mic;
 	int btn_mask;

commit 70bd3b298bbbd5a36c55af957bb3b5f727218918
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Wed May 29 20:28:16 2013 +0100

    ASoC: wm8994: Defer declaration of open circuit microphones
    
    Provide a bit of debounce to handle pathological cases with slow input
    better by allowing the microphone detection to run for a bit longer.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index 55ddf4d57d9b..9d19a9185d35 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -134,6 +134,7 @@ struct wm8994_priv {
 	struct mutex accdet_lock;
 	struct wm8994_micdet micdet[2];
 	struct delayed_work mic_work;
+	struct delayed_work open_circuit_work;
 	bool mic_detecting;
 	bool jack_mic;
 	int btn_mask;

commit da445afe357ae656f6baddd8fd58b01e923f1fc6
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Tue Mar 12 17:46:09 2013 +0000

    ASoC: wm8994: Remove duplicate revision cache
    
    There's already a device revision stored in the core data structure,
    don't duplicate it in the CODEC driver.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index 928e2c256450..55ddf4d57d9b 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -147,8 +147,6 @@ struct wm8994_priv {
 	wm1811_mic_id_cb mic_id_cb;
 	void *mic_id_cb_data;
 
-	int revision;
-
 	unsigned int aif1clk_enable:1;
 	unsigned int aif2clk_enable:1;
 

commit d3725761ee3d4813c6071ea1d952de1094d8b68f
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Tue Jan 29 23:17:12 2013 +0800

    ASoC: wm8994: Restore AIFnCLK after reducing it for low clock rates
    
    This helps to ensure a smooth startup when we restore.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index 45f192702024..928e2c256450 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -79,6 +79,7 @@ struct wm8994_priv {
 	int sysclk_rate[2];
 	int mclk[2];
 	int aifclk[2];
+	int aifdiv[2];
 	int channels[2];
 	struct wm8994_fll_config fll[2], fll_suspend[2];
 	struct completion fll_locked[2];

commit 06f1c66324cc38f0a38e4714f4645758742d7b3f
Merge: 6f5716a214ca 98869f68f2f6
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Mon Dec 10 00:22:37 2012 +0900

    Merge remote-tracking branch 'asoc/topic/wm8994' into asoc-next

commit 98869f68f2f68a9f238f5e96dbc3f838a0ff7136
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Mon Dec 3 16:14:37 2012 +0900

    ASoC: wm8994: Allow microphone identification callback to be overridden
    
    Allow custom accessory identification mechanisms to make use of the MICDET
    support in the device.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index 1a6bb4ed08f8..46a7bdb7d255 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -40,11 +40,13 @@ enum wm8994_vmid_mode {
 };
 
 typedef void (*wm1811_micdet_cb)(void *data);
+typedef void (*wm1811_mic_id_cb)(void *data, u16 status);
 
 int wm8994_mic_detect(struct snd_soc_codec *codec, struct snd_soc_jack *jack,
 		      int micbias);
 int wm8958_mic_detect(struct snd_soc_codec *codec, struct snd_soc_jack *jack,
-		      wm1811_micdet_cb cb, void *cb_data);
+		      wm1811_micdet_cb cb, void *det_cb_data,
+		      wm1811_mic_id_cb id_cb, void *id_cb_data);
 
 int wm8994_vmid_mode(struct snd_soc_codec *codec, enum wm8994_vmid_mode mode);
 
@@ -140,6 +142,8 @@ struct wm8994_priv {
 	int micdet_irq;
 	wm1811_micdet_cb micd_cb;
 	void *micd_cb_data;
+	wm1811_mic_id_cb mic_id_cb;
+	void *mic_id_cb_data;
 
 	int revision;
 

commit 63dd54521f1d143fbc6584ace66ef264a7f867f7
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Thu Nov 22 20:44:32 2012 +0900

    ASoC: wm8994: Support custom accessory identification for WM1811A
    
    Allow the user to override the accessory identification code with their
    own implementation if the system provides an alternative method.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index f5546f242ab1..1a6bb4ed08f8 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -39,12 +39,12 @@ enum wm8994_vmid_mode {
 	WM8994_VMID_FORCE,
 };
 
-typedef void (*wm8958_micdet_cb)(u16 status, void *data);
+typedef void (*wm1811_micdet_cb)(void *data);
 
 int wm8994_mic_detect(struct snd_soc_codec *codec, struct snd_soc_jack *jack,
 		      int micbias);
 int wm8958_mic_detect(struct snd_soc_codec *codec, struct snd_soc_jack *jack,
-		      wm8958_micdet_cb cb, void *cb_data);
+		      wm1811_micdet_cb cb, void *cb_data);
 
 int wm8994_vmid_mode(struct snd_soc_codec *codec, enum wm8994_vmid_mode mode);
 
@@ -138,6 +138,8 @@ struct wm8994_priv {
 	struct delayed_work jackdet_bootstrap;
 
 	int micdet_irq;
+	wm1811_micdet_cb micd_cb;
+	void *micd_cb_data;
 
 	int revision;
 

commit 78b76dbec8da6437e30519e6bbe4fb44d798addf
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Thu Nov 22 17:02:09 2012 +0900

    ASoC: wm8994: Simplify button detection code
    
    Currently the WM8994 driver allows the WM8958 microphone detection code to
    be replaced in its entirety, providing a default implementation. This
    doesn't actually reflect the needs of users well. They generally wish to
    replace only the accessory identification parts of the algorithm (eg,
    using an external GPIO to provide the equivalent of the JACKDET support in
    the WM1811A).
    
    In preparation for supporting these users better refactor the existing code
    so that we have separate identification and button detection callbacks,
    selecting between them rather than using the mic_detecting flag in the
    existing callback. This also simplifies the code by introducing a more
    explicit state machine for the detecting and button states.
    
    In anticipation of future refactoring the callback is left in the signature
    for wm8958_mic_detect(), it will be removed at a later stage.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index f618d16e1a12..f5546f242ab1 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -137,8 +137,6 @@ struct wm8994_priv {
 	int jackdet_mode;
 	struct delayed_work jackdet_bootstrap;
 
-	wm8958_micdet_cb jack_cb;
-	void *jack_cb_data;
 	int micdet_irq;
 
 	int revision;

commit d9dd4ada0edb96eaf3ba9b69fc2ffdd525ee7e0c
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Mon Oct 8 18:36:09 2012 +0900

    ASoC: wm8994: Use pdata cached in MFD driver
    
    This is better style and facilitates implementation of device tree support
    for the driver.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index f142ec198db3..f618d16e1a12 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -142,7 +142,6 @@ struct wm8994_priv {
 	int micdet_irq;
 
 	int revision;
-	struct wm8994_pdata *pdata;
 
 	unsigned int aif1clk_enable:1;
 	unsigned int aif2clk_enable:1;

commit 79748cdb39dbf914bc5f26c75cfd5f91d84d82c9
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Mon Oct 1 15:28:30 2012 +0100

    ASoC: wm8994: Only enable extra BCLK cycles when required
    
    Rather than always assuming the maximum possible BCLK rate will be
    required generate BCLKs for stereo if either one or two channels is
    enabled. In order to support this we also need to ensure that only
    the relevant channels are enabled.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index f142ec198db3..ccbce5791e95 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -77,6 +77,7 @@ struct wm8994_priv {
 	int sysclk_rate[2];
 	int mclk[2];
 	int aifclk[2];
+	int channels[2];
 	struct wm8994_fll_config fll[2], fll_suspend[2];
 	struct completion fll_locked[2];
 	bool fll_locked_irq;

commit 99af79dff5a609fe886d271bbc91e1a95eca3066
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Wed Jul 25 23:03:36 2012 +0100

    ASoC: wm8994: Ensure we get a notification on startup for jackdet
    
    Since jackdet only reports deltas it won't generate an interrupt on startup
    when a jack is not present. This doesn't make a difference to userspace
    but does mean we don't generate a notification via the internal notifier
    chains. Fix that by scheduling a work to poll the chip after the clock is
    enabled. Use an extremely large timeout since there's no urgency and we
    don't want to report a false negative.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index e6d8209b8f29..f142ec198db3 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -81,6 +81,7 @@ struct wm8994_priv {
 	struct completion fll_locked[2];
 	bool fll_locked_irq;
 	bool fll_byp;
+	bool clk_has_run;
 
 	int vmid_refcount;
 	int active_refcount;
@@ -134,6 +135,7 @@ struct wm8994_priv {
 	int btn_mask;
 	bool jackdet;
 	int jackdet_mode;
+	struct delayed_work jackdet_bootstrap;
 
 	wm8958_micdet_cb jack_cb;
 	void *jack_cb_data;

commit 8cb8e83bfa7cb63ad4b3c3b79410766da397124b
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Wed Jul 25 18:10:03 2012 +0100

    ASoC: wm_hubs: Move CODEC stored in private data into wm_hubs
    
    Further wm_hubs code will use this.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index 19068d8fa301..e6d8209b8f29 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -73,7 +73,6 @@ struct wm8994;
 struct wm8994_priv {
 	struct wm_hubs_data hubs;
 	struct wm8994 *wm8994;
-	struct snd_soc_codec *codec;
 	int sysclk[2];
 	int sysclk_rate[2];
 	int mclk[2];

commit fbfe69836c088bcc0c5a0f32e788d3aef5f66aca
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Mon Jul 23 20:14:43 2012 +0100

    ASoC: wm8994: Implement support for self-oscillation mode in the FLL
    
    The FLLs in the WM8994 series devices can be started without any reference
    being supplied, mainly for use in analogue bypass cases. Implement support
    for this mode.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index d77e06f0a675..19068d8fa301 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -28,10 +28,11 @@
 #define WM8994_FLL1 1
 #define WM8994_FLL2 2
 
-#define WM8994_FLL_SRC_MCLK1  1
-#define WM8994_FLL_SRC_MCLK2  2
-#define WM8994_FLL_SRC_LRCLK  3
-#define WM8994_FLL_SRC_BCLK   4
+#define WM8994_FLL_SRC_MCLK1    1
+#define WM8994_FLL_SRC_MCLK2    2
+#define WM8994_FLL_SRC_LRCLK    3
+#define WM8994_FLL_SRC_BCLK     4
+#define WM8994_FLL_SRC_INTERNAL 5
 
 enum wm8994_vmid_mode {
 	WM8994_VMID_NORMAL,

commit e9b54de420bfdd335d66c90b4d68e894677db668
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Wed May 9 19:20:59 2012 +0100

    ASoC: wm8994: Add debounce to wm8994 mic detection
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index 91650bba205e..d77e06f0a675 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -12,6 +12,7 @@
 #include <sound/soc.h>
 #include <linux/firmware.h>
 #include <linux/completion.h>
+#include <linux/workqueue.h>
 
 #include "wm_hubs.h"
 
@@ -127,6 +128,7 @@ struct wm8994_priv {
 
 	struct mutex accdet_lock;
 	struct wm8994_micdet micdet[2];
+	struct delayed_work mic_work;
 	bool mic_detecting;
 	bool jack_mic;
 	int btn_mask;

commit 20dc24a951f4792070803d8f1838c8ed3f4e5d57
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Thu Apr 5 12:55:20 2012 +0100

    ASoC: wm8994: Implement FLL bypass support
    
    Later WM8994 class devices can bypass the FLL from BCLK. Do this
    automatically when the FLL input and output frequencies match up.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index c724112998d8..91650bba205e 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -79,6 +79,7 @@ struct wm8994_priv {
 	struct wm8994_fll_config fll[2], fll_suspend[2];
 	struct completion fll_locked[2];
 	bool fll_locked_irq;
+	bool fll_byp;
 
 	int vmid_refcount;
 	int active_refcount;

commit 22f8d055350066b4a87de4adea8c5213cac54534
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Mon Mar 19 17:32:06 2012 +0000

    ASoC: wm8994: Provide VMID mode control and fix default sequence
    
    The optimal management of VMID depends on a number of factors which vary
    dynamically at runtime, for example the connection to a system docking
    station. In some circumstances it is desirable to keep VMID enabled all
    the time, in others it is desirable to aggressively power it up and down.
    
    Provide a callback allowing machine driver to configure either the normal
    power up/down mode (WM8994_VMID_MODE_NORMAL) or to maintain VMID even
    when idle (WM8994_VMID_MODE_FORCE). This callback, wm8994_vmid_mode(),
    should be called with the CODEC lock.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index 2f4d2d12a452..c724112998d8 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -32,6 +32,11 @@
 #define WM8994_FLL_SRC_LRCLK  3
 #define WM8994_FLL_SRC_BCLK   4
 
+enum wm8994_vmid_mode {
+	WM8994_VMID_NORMAL,
+	WM8994_VMID_FORCE,
+};
+
 typedef void (*wm8958_micdet_cb)(u16 status, void *data);
 
 int wm8994_mic_detect(struct snd_soc_codec *codec, struct snd_soc_jack *jack,
@@ -39,6 +44,8 @@ int wm8994_mic_detect(struct snd_soc_codec *codec, struct snd_soc_jack *jack,
 int wm8958_mic_detect(struct snd_soc_codec *codec, struct snd_soc_jack *jack,
 		      wm8958_micdet_cb cb, void *cb_data);
 
+int wm8994_vmid_mode(struct snd_soc_codec *codec, enum wm8994_vmid_mode mode);
+
 int wm8958_aif_ev(struct snd_soc_dapm_widget *w,
 		  struct snd_kcontrol *kcontrol, int event);
 
@@ -75,6 +82,7 @@ struct wm8994_priv {
 
 	int vmid_refcount;
 	int active_refcount;
+	enum wm8994_vmid_mode vmid_mode;
 
 	int dac_rates[2];
 	int lrclk_shared[2];

commit 4752a887190ff38175be47aae26a821e8941b96e
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Sun Mar 4 02:16:01 2012 +0000

    ASoC: wm8994: Use audio mode for jack detection when system is active
    
    When we are out of system sleep always use audio mode for jack detection
    in order to avoid potential performance issues handing off between modes.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index f996d14766d9..2f4d2d12a452 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -122,6 +122,7 @@ struct wm8994_priv {
 	bool jack_mic;
 	int btn_mask;
 	bool jackdet;
+	int jackdet_mode;
 
 	wm8958_micdet_cb jack_cb;
 	void *jack_cb_data;

commit 87092e3ca4ff7b2c2d7723b3402fe2f74b249bc4
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Mon Feb 6 18:50:39 2012 +0000

    ASoC: wm8994: Bring WM8994 accessory detection up to date
    
    Make the mechanism used for WM8994 more like that for WM1811 and WM8958:
    provide the logic to distinguish between headphone and headset and hard
    code the reporting of sensible SND_JACK values. Should integration with
    other detection mechanisms be required we can add appropriate callbacks
    (though some integrations should be able to use the subsystem ones).
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index c3a42474ab19..f996d14766d9 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -35,7 +35,7 @@
 typedef void (*wm8958_micdet_cb)(u16 status, void *data);
 
 int wm8994_mic_detect(struct snd_soc_codec *codec, struct snd_soc_jack *jack,
-		      int micbias, int det, int shrt);
+		      int micbias);
 int wm8958_mic_detect(struct snd_soc_codec *codec, struct snd_soc_jack *jack,
 		      wm8958_micdet_cb cb, void *cb_data);
 
@@ -46,8 +46,7 @@ void wm8958_dsp2_init(struct snd_soc_codec *codec);
 
 struct wm8994_micdet {
 	struct snd_soc_jack *jack;
-	int det;
-	int shrt;
+	bool detecting;
 };
 
 /* codec private data */

commit cae59c7b2185856522822e40260174c088ca5b11
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Tue Oct 25 16:13:12 2011 +0200

    ASoC: Remove WM8994 register cache
    
    Now that the mfd is using the register map cache there's no need for the
    CODEC driver to do any register cache management or any funny dances to
    interact with the other drivers using the device so just remove the cache
    initialisation and volatility information.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index 6ef3f11878c6..c3a42474ab19 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -39,16 +39,6 @@ int wm8994_mic_detect(struct snd_soc_codec *codec, struct snd_soc_jack *jack,
 int wm8958_mic_detect(struct snd_soc_codec *codec, struct snd_soc_jack *jack,
 		      wm8958_micdet_cb cb, void *cb_data);
 
-#define WM8994_CACHE_SIZE 1570
-
-struct wm8994_access_mask {
-	unsigned short readable;   /* Mask of readable bits */
-	unsigned short writable;   /* Mask of writable bits */
-};
-
-extern const struct wm8994_access_mask wm8994_access_masks[WM8994_CACHE_SIZE];
-extern const u16 wm8994_reg_defaults[WM8994_CACHE_SIZE];
-
 int wm8958_aif_ev(struct snd_soc_dapm_widget *w,
 		  struct snd_kcontrol *kcontrol, int event);
 

commit af6b6fe41c4bc9e7933d66bbbf5106e0e7e6e484
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Wed Nov 30 20:32:05 2011 +0000

    ASoC: Implement support for WM1811A jack detection
    
    The WM1811A features an advanced low power accessory detection subsystem
    which allows the device to be maintained in a very low power state while
    the system is idle without sacrificing any accessory detection features.
    
    Implement software support for this, automatically managing the power
    configuration of the device depending on the detected accessory.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index 8622bc4db2fe..6ef3f11878c6 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -85,6 +85,7 @@ struct wm8994_priv {
 	bool fll_locked_irq;
 
 	int vmid_refcount;
+	int active_refcount;
 
 	int dac_rates[2];
 	int lrclk_shared[2];
@@ -126,10 +127,12 @@ struct wm8994_priv {
 	const char **enh_eq_texts;
 	struct soc_enum enh_eq_enum;
 
+	struct mutex accdet_lock;
 	struct wm8994_micdet micdet[2];
 	bool mic_detecting;
 	bool jack_mic;
 	int btn_mask;
+	bool jackdet;
 
 	wm8958_micdet_cb jack_cb;
 	void *jack_cb_data;

commit 157a75e664f8c811c660de1d1b9abb16a1f72579
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Wed Nov 30 13:43:51 2011 +0000

    ASoC: Rename WM8994 detecting flag to mic_detecting
    
    More specific and avoids confusion with a following change.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index 77e3d8c9eeb8..8622bc4db2fe 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -127,7 +127,7 @@ struct wm8994_priv {
 	struct soc_enum enh_eq_enum;
 
 	struct wm8994_micdet micdet[2];
-	bool detecting;
+	bool mic_detecting;
 	bool jack_mic;
 	int btn_mask;
 

commit 4585790d1cde32a5719c24412e9845e031358e08
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Wed Nov 30 10:55:14 2011 +0000

    ASoC: Allow more WM8958/WM1811 button levels with default handler
    
    The WM8958 and WM1811 support detecting a range of buttons. Allow the
    user to provide platform data enabling more of these levels without
    having to write a custom detection handler.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index c3e71d72eb6a..77e3d8c9eeb8 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -129,6 +129,7 @@ struct wm8994_priv {
 	struct wm8994_micdet micdet[2];
 	bool detecting;
 	bool jack_mic;
+	int btn_mask;
 
 	wm8958_micdet_cb jack_cb;
 	void *jack_cb_data;

commit 2a8a856d427fea68a5d538adf52edae4cdbb246b
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Sun Jul 24 12:20:41 2011 +0100

    ASoC: Don't use control_data to get struct wm8994
    
    This will support refactoring to make use of the regmap API more directly
    in the core.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index 1087425cbac0..c3e71d72eb6a 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -70,10 +70,11 @@ struct wm8994_fll_config {
 #define WM8994_NUM_DRC 3
 #define WM8994_NUM_EQ  3
 
+struct wm8994;
+
 struct wm8994_priv {
 	struct wm_hubs_data hubs;
-	enum snd_soc_control_type control_type;
-	void *control_data;
+	struct wm8994 *wm8994;
 	struct snd_soc_codec *codec;
 	int sysclk[2];
 	int sysclk_rate[2];

commit b00adf76a6fa492c39f8225fc42debc01bbbdc1d
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Sat Aug 13 11:57:18 2011 +0900

    ASoC: Enhance default WM8958 microphone detection
    
    Actively manage the detection rate for microphones with WM8958, providing
    improved power consumption and maximising the benefit from the hardware
    debounce.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index f4f1355efc82..1087425cbac0 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -126,6 +126,8 @@ struct wm8994_priv {
 	struct soc_enum enh_eq_enum;
 
 	struct wm8994_micdet micdet[2];
+	bool detecting;
+	bool jack_mic;
 
 	wm8958_micdet_cb jack_cb;
 	void *jack_cb_data;

commit 4b7ed83aa3c7f4b9fe363875440836e0f2aabbdf
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Wed Aug 10 17:47:33 2011 +0900

    ASoC: Disable WM8994 VMID for digital only paths
    
    On WM8994 class devices only the analogue portions of the CODEC require
    VMID so when running digital only paths we can leave VMID disabled.
    On some earlier devices the FLL uses VMID so we don't use DAPM reference
    counting alone, we maintain an internal reference count which is also
    enabled and disabled by the FLL startup.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>
    Acked-by: Liam Girdwood <lrg@ti.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index 1ab2266039f7..f4f1355efc82 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -83,6 +83,8 @@ struct wm8994_priv {
 	struct completion fll_locked[2];
 	bool fll_locked_irq;
 
+	int vmid_refcount;
+
 	int dac_rates[2];
 	int lrclk_shared[2];
 

commit c7ebf932e5afa9caf8720435519b857b5d6e63bc
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Tue Jul 12 19:47:59 2011 +0900

    ASoC: Use WM8994 FLL lock interrupt
    
    If we have interrupts then wait for the FLL lock interrupt rather than
    using dead reckoning when waiting for the FLL to start.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index 0a1db04b73bd..1ab2266039f7 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -11,6 +11,7 @@
 
 #include <sound/soc.h>
 #include <linux/firmware.h>
+#include <linux/completion.h>
 
 #include "wm_hubs.h"
 
@@ -79,6 +80,8 @@ struct wm8994_priv {
 	int mclk[2];
 	int aifclk[2];
 	struct wm8994_fll_config fll[2], fll_suspend[2];
+	struct completion fll_locked[2];
+	bool fll_locked_irq;
 
 	int dac_rates[2];
 	int lrclk_shared[2];

commit 312158718fe2056703b2744801165a9574560495
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Thu Mar 17 20:23:43 2011 +0000

    ASoC: Add WM8958 enhanced EQ support
    
    DSP2 in the WM8958 can be used to support an upgraded EQ for use in
    demanding applications.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>
    Acked-by: Liam Girdwood <lrg@ti.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index f337f3d50590..0a1db04b73bd 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -87,6 +87,7 @@ struct wm8994_priv {
 	int hpf1_ena[3];
 	int hpf2_ena[3];
 	int vss_ena[3];
+	int enh_eq_ena[3];
 
 	/* Platform dependant DRC configuration */
 	const char **drc_texts;
@@ -114,6 +115,11 @@ struct wm8994_priv {
 	const char **vss_hpf_texts;
 	struct soc_enum vss_hpf_enum;
 
+	/* Platform dependant enhanced EQ configuration */
+	int enh_eq_cfg;
+	const char **enh_eq_texts;
+	struct soc_enum enh_eq_enum;
+
 	struct wm8994_micdet micdet[2];
 
 	wm8958_micdet_cb jack_cb;
@@ -133,6 +139,7 @@ struct wm8994_priv {
 	const struct firmware *cur_fw;
 	const struct firmware *mbc;
 	const struct firmware *mbc_vss;
+	const struct firmware *enh_eq;
 };
 
 #endif

commit 09e10d7fe509408d15818db6a0299f563668a7ba
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Wed Mar 16 22:57:47 2011 +0000

    ASoC: Add WM8958 VSS support
    
    With appropriate firmware the WM8958 can support Virtual Surround Sound or
    VSS, widening the stereo audio image for improved user experience. Enable
    support for this mode of operation when the appropriate firmware can be
    loaded at runtime.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>
    Acked-by: Liam Girdwood <lrg@ti.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index a4bfde83065f..f337f3d50590 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -84,6 +84,9 @@ struct wm8994_priv {
 	int lrclk_shared[2];
 
 	int mbc_ena[3];
+	int hpf1_ena[3];
+	int hpf2_ena[3];
+	int vss_ena[3];
 
 	/* Platform dependant DRC configuration */
 	const char **drc_texts;
@@ -101,6 +104,16 @@ struct wm8994_priv {
 	const char **mbc_texts;
 	struct soc_enum mbc_enum;
 
+	/* Platform dependant VSS configuration */
+	int vss_cfg;
+	const char **vss_texts;
+	struct soc_enum vss_enum;
+
+	/* Platform dependant VSS HPF configuration */
+	int vss_hpf_cfg;
+	const char **vss_hpf_texts;
+	struct soc_enum vss_hpf_enum;
+
 	struct wm8994_micdet micdet[2];
 
 	wm8958_micdet_cb jack_cb;
@@ -119,6 +132,7 @@ struct wm8994_priv {
 	int dsp_active;
 	const struct firmware *cur_fw;
 	const struct firmware *mbc;
+	const struct firmware *mbc_vss;
 };
 
 #endif

commit f20d77ce2663b31c2994462d9ab9143726b67f3e
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Wed Mar 16 20:55:37 2011 +0000

    ASoC: Refactor WM8958 DSP to support additional algorithms
    
    In preparation for the addition of additional WM8958 algorithms
    reorganise the code to make it easier to add such support later.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>
    Acked-by: Liam Girdwood <lrg@ti.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index 1aa365b31b08..a4bfde83065f 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -116,6 +116,7 @@ struct wm8994_priv {
 	unsigned int aif1clk_disable:1;
 	unsigned int aif2clk_disable:1;
 
+	int dsp_active;
 	const struct firmware *cur_fw;
 	const struct firmware *mbc;
 };

commit fbbf592002ee46ed14d5bd88f1150c604b34e705
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Fri Mar 11 18:09:04 2011 +0000

    ASoC: Support download of WM8958 MBC firmware
    
    Allow userspace to supply an update to the ROM firmware. The firmware
    request is non-blocking so userspace can load the firmware at its
    leisure without delaying startup, the driver will begin using the
    firmware the next time MBC is started after it has been supplied.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>
    Acked-by: Liam Girdwood <lrg@ti.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index 93a6cf1e1308..1aa365b31b08 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -10,6 +10,7 @@
 #define _WM8994_H
 
 #include <sound/soc.h>
+#include <linux/firmware.h>
 
 #include "wm_hubs.h"
 
@@ -114,6 +115,9 @@ struct wm8994_priv {
 
 	unsigned int aif1clk_disable:1;
 	unsigned int aif2clk_disable:1;
+
+	const struct firmware *cur_fw;
+	const struct firmware *mbc;
 };
 
 #endif

commit f701a2e594e62b35d895ad5ec1db8d2d0714c158
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Wed Mar 9 19:31:01 2011 +0000

    ASoC: Factor WM8958 DSP2 handling into separate file
    
    DSP2 on the WM8958 has a default ROM which provides a multi-band
    compressor for enhanced performance on mobile devices but can also
    support runtime download of alternative firmware. In preparation for
    more exploiting this functionality refactor the code to split the
    handling of DSP2 into a separate file.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>
    Acked-by: Liam Girdwood <lrg@slimlogic.co.uk>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index 999b8851226b..93a6cf1e1308 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -11,6 +11,8 @@
 
 #include <sound/soc.h>
 
+#include "wm_hubs.h"
+
 /* Sources for AIF1/2 SYSCLK - use with set_dai_sysclk() */
 #define WM8994_SYSCLK_MCLK1 1
 #define WM8994_SYSCLK_MCLK2 2
@@ -45,4 +47,73 @@ struct wm8994_access_mask {
 extern const struct wm8994_access_mask wm8994_access_masks[WM8994_CACHE_SIZE];
 extern const u16 wm8994_reg_defaults[WM8994_CACHE_SIZE];
 
+int wm8958_aif_ev(struct snd_soc_dapm_widget *w,
+		  struct snd_kcontrol *kcontrol, int event);
+
+void wm8958_dsp2_init(struct snd_soc_codec *codec);
+
+struct wm8994_micdet {
+	struct snd_soc_jack *jack;
+	int det;
+	int shrt;
+};
+
+/* codec private data */
+struct wm8994_fll_config {
+	int src;
+	int in;
+	int out;
+};
+
+#define WM8994_NUM_DRC 3
+#define WM8994_NUM_EQ  3
+
+struct wm8994_priv {
+	struct wm_hubs_data hubs;
+	enum snd_soc_control_type control_type;
+	void *control_data;
+	struct snd_soc_codec *codec;
+	int sysclk[2];
+	int sysclk_rate[2];
+	int mclk[2];
+	int aifclk[2];
+	struct wm8994_fll_config fll[2], fll_suspend[2];
+
+	int dac_rates[2];
+	int lrclk_shared[2];
+
+	int mbc_ena[3];
+
+	/* Platform dependant DRC configuration */
+	const char **drc_texts;
+	int drc_cfg[WM8994_NUM_DRC];
+	struct soc_enum drc_enum;
+
+	/* Platform dependant ReTune mobile configuration */
+	int num_retune_mobile_texts;
+	const char **retune_mobile_texts;
+	int retune_mobile_cfg[WM8994_NUM_EQ];
+	struct soc_enum retune_mobile_enum;
+
+	/* Platform dependant MBC configuration */
+	int mbc_cfg;
+	const char **mbc_texts;
+	struct soc_enum mbc_enum;
+
+	struct wm8994_micdet micdet[2];
+
+	wm8958_micdet_cb jack_cb;
+	void *jack_cb_data;
+	int micdet_irq;
+
+	int revision;
+	struct wm8994_pdata *pdata;
+
+	unsigned int aif1clk_enable:1;
+	unsigned int aif2clk_enable:1;
+
+	unsigned int aif1clk_disable:1;
+	unsigned int aif2clk_disable:1;
+};
+
 #endif

commit b993f92b99288d4b3a1a1237f3e40fa6460e4b47
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Mon Mar 7 16:42:20 2011 +0000

    ASoC: Fix section mismatch warnings in WM8994
    
    Annoying as the __devinitdata is actually correct.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>
    Acked-by: Liam Girdwood <lrg@ti.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index 0c355bfc88f1..999b8851226b 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -43,6 +43,6 @@ struct wm8994_access_mask {
 };
 
 extern const struct wm8994_access_mask wm8994_access_masks[WM8994_CACHE_SIZE];
-extern const __devinitdata  u16 wm8994_reg_defaults[WM8994_CACHE_SIZE];
+extern const u16 wm8994_reg_defaults[WM8994_CACHE_SIZE];
 
 #endif

commit ca9aef50727dec76ab12513ba833a1cf5e9d7e83
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Fri Nov 26 17:23:41 2010 +0000

    ASoC: Convert WM8994 to use soc-cache.c cache functions
    
    In the process we convert the driver to read registers one at a time
    when initialising the cache. This has the effect of working around
    limitations in the sizes of I2C transactions which can be done by some
    CPUs. Due to the sparseness of the register map the overhead from this
    should be minimual unless I2C transactions are very expensive to start.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>
    Acked-by: Liam Girdwood <lrg@slimlogic.co.uk>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index 455cae6b4356..0c355bfc88f1 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -43,5 +43,6 @@ struct wm8994_access_mask {
 };
 
 extern const struct wm8994_access_mask wm8994_access_masks[WM8994_CACHE_SIZE];
+extern const __devinitdata  u16 wm8994_reg_defaults[WM8994_CACHE_SIZE];
 
 #endif

commit 821edd2fb5b289b84d715fb744106019fa2e1920
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Fri Nov 26 15:21:09 2010 +0000

    ASoC: Add WM8958 microphone detection support
    
    The WM8958 contains an advanced accessory detection feature which allows
    detection of up to seven different impedence levels on the microphone
    bias output, including detection of video outputs. Since some of the
    more involved accessory interfaces may involve noticable interactions
    with external components a simple detection scheme is provided by
    default with the option to provide custom handling of accessory detect.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>
    Acked-by: Liam Girdwood <lrg@slimlogic.co.uk>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index b8b3166e1f03..455cae6b4356 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -28,8 +28,12 @@
 #define WM8994_FLL_SRC_LRCLK  3
 #define WM8994_FLL_SRC_BCLK   4
 
+typedef void (*wm8958_micdet_cb)(u16 status, void *data);
+
 int wm8994_mic_detect(struct snd_soc_codec *codec, struct snd_soc_jack *jack,
 		      int micbias, int det, int shrt);
+int wm8958_mic_detect(struct snd_soc_codec *codec, struct snd_soc_jack *jack,
+		      wm8958_micdet_cb cb, void *cb_data);
 
 #define WM8994_CACHE_SIZE 1570
 

commit 7b306dae22ca377ea0020261ef13aea85b8f5f3f
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Tue Nov 16 20:11:40 2010 +0000

    ASoC: Move WM8994 read/write access data into separate file
    
    Makes the WM8994 driver file itself substantially smaller.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>
    Acked-by: Liam Girdwood <lrg@slimlogic.co.uk>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index d8dce260c430..b8b3166e1f03 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -31,4 +31,13 @@
 int wm8994_mic_detect(struct snd_soc_codec *codec, struct snd_soc_jack *jack,
 		      int micbias, int det, int shrt);
 
+#define WM8994_CACHE_SIZE 1570
+
+struct wm8994_access_mask {
+	unsigned short readable;   /* Mask of readable bits */
+	unsigned short writable;   /* Mask of writable bits */
+};
+
+extern const struct wm8994_access_mask wm8994_access_masks[WM8994_CACHE_SIZE];
+
 #endif

commit f0fba2ad1b6b53d5360125c41953b7afcd6deff0
Author: Liam Girdwood <lrg@slimlogic.co.uk>
Date:   Wed Mar 17 20:15:21 2010 +0000

    ASoC: multi-component - ASoC Multi-Component Support
    
    This patch extends the ASoC API to allow sound cards to have more than one
    CODEC and more than one platform DMA controller. This is achieved by dividing
    some current ASoC structures that contain both driver data and device data into
    structures that only either contain device data or driver data. i.e.
    
     struct snd_soc_codec    --->  struct snd_soc_codec (device data)
                              +->  struct snd_soc_codec_driver (driver data)
    
     struct snd_soc_platform --->  struct snd_soc_platform (device data)
                              +->  struct snd_soc_platform_driver (driver data)
    
     struct snd_soc_dai      --->  struct snd_soc_dai (device data)
                              +->  struct snd_soc_dai_driver (driver data)
    
     struct snd_soc_device   --->  deleted
    
    This now allows ASoC to be more tightly aligned with the Linux driver model and
    also means that every ASoC codec, platform and (platform) DAI is a kernel
    device. ASoC component private data is now stored as device private data.
    
    The ASoC sound card struct snd_soc_card has also been updated to store lists
    of it's components rather than a pointer to a codec and platform. The PCM
    runtime struct soc_pcm_runtime now has pointers to all its components.
    
    This patch adds DAPM support for ASoC multi-component and removes struct
    snd_soc_socdev from DAPM core. All DAPM calls are now made on a card, codec
    or runtime PCM level basis rather than using snd_soc_socdev.
    
    Other notable multi-component changes:-
    
     * Stream operations now de-reference less structures.
     * close_delayed work() now runs on a DAI basis rather than looping all DAIs
       in a card.
     * PM suspend()/resume() operations can now handle N CODECs and Platforms
       per sound card.
     * Added soc_bind_dai_link() to bind the component devices to the sound card.
     * Added soc_dai_link_probe() and soc_dai_link_remove() to probe and remove
       DAI link components.
     * sysfs entries can now be registered per component per card.
     * snd_soc_new_pcms() functionailty rolled into dai_link_probe().
     * snd_soc_register_codec() now does all the codec list and mutex init.
    
    This patch changes the probe() and remove() of the CODEC drivers as follows:-
    
     o Make CODEC driver a platform driver
     o Moved all struct snd_soc_codec list, mutex, etc initialiasation to core.
     o Removed all static codec pointers (drivers now support > 1 codec dev)
     o snd_soc_register_pcms() now done by core.
     o snd_soc_register_dai() folded into snd_soc_register_codec().
    
    CS4270 portions:
    Acked-by: Timur Tabi <timur@freescale.com>
    
    Some TLV320aic23 and Cirrus platform fixes.
    Signed-off-by: Ryan Mallon <ryan@bluewatersys.com>
    
    TI CODEC and OMAP fixes
    Signed-off-by: Peter Ujfalusi <peter.ujfalusi@nokia.com>
    Signed-off-by: Janusz Krzysztofik <jkrzyszt@tis.icnet.pl>
    Signed-off-by: Jarkko Nikula <jhnikula@gmail.com>
    
    Samsung platform and misc fixes :-
    Signed-off-by: Chanwoo Choi <cw00.choi@samsung.com>
    Signed-off-by: Joonyoung Shim <jy0922.shim@samsung.com>
    Signed-off-by: Kyungmin Park <kyungmin.park@samsung.com>
    Reviewed-by: Jassi Brar <jassi.brar@samsung.com>
    Signed-off-by: Seungwhan Youn <sw.youn@samsung.com>
    
    MPC8610 and PPC fixes.
    Signed-off-by: Timur Tabi <timur@freescale.com>
    
    i.MX fixes and some core fixes.
    Signed-off-by: Sascha Hauer <s.hauer@pengutronix.de>
    
    J4740 platform fixes:-
    Signed-off-by: Lars-Peter Clausen <lars@metafoo.de>
    
    CC: Tony Lindgren <tony@atomide.com>
    CC: Nicolas Ferre <nicolas.ferre@atmel.com>
    CC: Kevin Hilman <khilman@deeprootsystems.com>
    CC: Sascha Hauer <s.hauer@pengutronix.de>
    CC: Atsushi Nemoto <anemo@mba.ocn.ne.jp>
    CC: Kuninori Morimoto <morimoto.kuninori@renesas.com>
    CC: Daniel Gloeckner <dg@emlix.com>
    CC: Manuel Lauss <mano@roarinelk.homelinux.net>
    CC: Mike Frysinger <vapier.adi@gmail.com>
    CC: Arnaud Patard <apatard@mandriva.com>
    CC: Wan ZongShun <mcuos.com@gmail.com>
    
    Acked-by: Mark Brown <broonie@opensource.wolfsonmicro.com>
    Signed-off-by: Liam Girdwood <lrg@slimlogic.co.uk>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index 2e0ca67a8df7..d8dce260c430 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -11,9 +11,6 @@
 
 #include <sound/soc.h>
 
-extern struct snd_soc_codec_device soc_codec_dev_wm8994;
-extern struct snd_soc_dai wm8994_dai[];
-
 /* Sources for AIF1/2 SYSCLK - use with set_dai_sysclk() */
 #define WM8994_SYSCLK_MCLK1 1
 #define WM8994_SYSCLK_MCLK2 2

commit 66b47fdb851924956b6e4696fb43a3496ae2c462
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Thu Jul 8 11:25:43 2010 +0900

    ASoC: Implement WM8994 OPCLK support
    
    The WM8994 can output a clock derived from its internal SYSCLK, called
    OPCLK.  The rate can be selected as a sysclk, with a division from the
    SYSCLK rate specified (multiplied by 10 since a division of 5.5 is
    supported) and the clock can be disabled by specifying a divisor of
    zero.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>
    Acked-by: Liam Girdwood <lrg@slimlogic.co.uk>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index 7072dc539354..2e0ca67a8df7 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -20,6 +20,9 @@ extern struct snd_soc_dai wm8994_dai[];
 #define WM8994_SYSCLK_FLL1  3
 #define WM8994_SYSCLK_FLL2  4
 
+/* OPCLK is also configured with set_dai_sysclk, specify division*10 as rate. */
+#define WM8994_SYSCLK_OPCLK 5
+
 #define WM8994_FLL1 1
 #define WM8994_FLL2 2
 

commit 136ff2a272ad4bee33bf85f8c490ff8a2dd08f96
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Tue Apr 20 12:56:18 2010 +0900

    ASoC: Support FLL input clock selection on WM8994
    
    The WM8994 FLL can be clocked from one of four inputs, the two MCLKs and
    the LRCLK and BCLK of the AIF associated with the FLL. Allow all four
    inputs to be used rather than defaulting to MCLK1.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index 79d5915ae4b3..7072dc539354 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -23,6 +23,11 @@ extern struct snd_soc_dai wm8994_dai[];
 #define WM8994_FLL1 1
 #define WM8994_FLL2 2
 
+#define WM8994_FLL_SRC_MCLK1  1
+#define WM8994_FLL_SRC_MCLK2  2
+#define WM8994_FLL_SRC_LRCLK  3
+#define WM8994_FLL_SRC_BCLK   4
+
 int wm8994_mic_detect(struct snd_soc_codec *codec, struct snd_soc_jack *jack,
 		      int micbias, int det, int shrt);
 

commit 8876698406147986a9a7748586a54c4b14514c0e
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Mon Mar 29 20:57:12 2010 +0100

    ASoC: Implement interrupt based WM8994 microphone detection
    
    Support interrupt based microphone bias detection. The WM8994 has two
    microphone bias supplies, with detection supported on both. Detection
    using GPIOs together with the standard GPIO based jack framework is
    already supported via the platform data for the WM8994 core driver.
    
    Note that as well as the microphone bias itself the system clock and
    whichever AIF clock is supplying the system clock will need to be
    enabled for detection to function.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
index 0a5e1424dea0..79d5915ae4b3 100644
--- a/sound/soc/codecs/wm8994.h
+++ b/sound/soc/codecs/wm8994.h
@@ -23,4 +23,7 @@ extern struct snd_soc_dai wm8994_dai[];
 #define WM8994_FLL1 1
 #define WM8994_FLL2 2
 
+int wm8994_mic_detect(struct snd_soc_codec *codec, struct snd_soc_jack *jack,
+		      int micbias, int det, int shrt);
+
 #endif

commit 9e6e96a197a03752d39a63e4f83e0b707ccedad7
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Fri Jan 29 17:47:12 2010 +0000

    ASoC: Add WM8994 CODEC driver
    
    The WM8994 is a highly integrated ultra-low power hi-fi audio subsystem
    designed for smartphones and other portable devices rich in multimedia
    features.  It provides advanced digital mixing facilities enabling low
    power high quality interconnection of CPU, baseband and other audio
    sources through flexible digital and analogue routing, and integrates
    a class W headphone driver and stereo class D speaker drivers.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>

diff --git a/sound/soc/codecs/wm8994.h b/sound/soc/codecs/wm8994.h
new file mode 100644
index 000000000000..0a5e1424dea0
--- /dev/null
+++ b/sound/soc/codecs/wm8994.h
@@ -0,0 +1,26 @@
+/*
+ * wm8994.h  --  WM8994 Soc Audio driver
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License version 2 as
+ * published by the Free Software Foundation.
+ */
+
+#ifndef _WM8994_H
+#define _WM8994_H
+
+#include <sound/soc.h>
+
+extern struct snd_soc_codec_device soc_codec_dev_wm8994;
+extern struct snd_soc_dai wm8994_dai[];
+
+/* Sources for AIF1/2 SYSCLK - use with set_dai_sysclk() */
+#define WM8994_SYSCLK_MCLK1 1
+#define WM8994_SYSCLK_MCLK2 2
+#define WM8994_SYSCLK_FLL1  3
+#define WM8994_SYSCLK_FLL2  4
+
+#define WM8994_FLL1 1
+#define WM8994_FLL2 2
+
+#endif
