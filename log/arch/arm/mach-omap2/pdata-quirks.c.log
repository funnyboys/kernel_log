commit feaa8baee82ababa46af95b03cfc28680ad647a6
Author: Tony Lindgren <tony@atomide.com>
Date:   Mon Feb 24 12:58:03 2020 -0800

    bus: ti-sysc: Implement SoC revision handling
    
    We need to know SoC type and features for cases where the same SoC
    may be installed in various versions on the same board and would need
    a separate dts file otherwise for the different variants.
    
    For example, am3703 is pin compatible with omap3630, but has sgx and
    iva accelerators disabled. We must not try to access the sgx or iva
    module registers on am3703, and need to set the unavailable devices
    disabled early.
    
    Let's also detect omap3430 as that is needed for display subsystem
    (DSS) reset later on, and GP vs EMU or HS devices. Further SoC
    specific disabled device detection can be added as needed, such as
    dra71x vs dra76x rtc and usb4.
    
    Cc: Adam Ford <aford173@gmail.com>
    Cc: André Hentschel <nerv@dawncrow.de>
    Cc: H. Nikolaus Schaller <hns@goldelico.com>
    Cc: Keerthy <j-keerthy@ti.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index dbb7c2acef31..2a4fe3e68b82 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -397,10 +397,16 @@ static int ti_sysc_shutdown_module(struct device *dev,
 	return omap_hwmod_shutdown(cookie->data);
 }
 
+static bool ti_sysc_soc_type_gp(void)
+{
+	return omap_type() == OMAP2_DEVICE_TYPE_GP;
+}
+
 static struct of_dev_auxdata omap_auxdata_lookup[];
 
 static struct ti_sysc_platform_data ti_sysc_pdata = {
 	.auxdata = omap_auxdata_lookup,
+	.soc_type_gp = ti_sysc_soc_type_gp,
 	.init_clockdomain = ti_sysc_clkdm_init,
 	.clkdm_deny_idle = ti_sysc_clkdm_deny_idle,
 	.clkdm_allow_idle = ti_sysc_clkdm_allow_idle,

commit e052860d11810f085c1fff88057241243baef08f
Merge: 785ca50f8e61 9fc85a7124b5
Author: Olof Johansson <olof@lixom.net>
Date:   Tue Jan 7 11:25:28 2020 -0800

    Merge tag 'omap-for-v5.6/ti-sysc-drop-pdata-signed' of git://git.kernel.org/pub/scm/linux/kernel/git/tmlind/linux-omap into arm/dt
    
    Drop more legacy platform data for omaps for v5.6 merge window
    
    We can now probe devices with ti-sysc interconnect driver and dts
    data, and can continue dropping the related platform data and custom
    ti,hwmods dts property for various devices.
    
    And related to that, we finally can remove the legacy sdma support in
    favor of using the dmaengine driver only. I was planning to send the
    sdma changes separately, but that would have produced a pile of
    pointless merge conflicts, so I decided it's best to resolve it locally.
    After all, the sdma series also ends up removing the related platform
    data.
    
    Note that this series is based on omap-for-v5.6/ti-sysc-dt-signed branch
    as it depends for dts data being in place.
    
    * tag 'omap-for-v5.6/ti-sysc-drop-pdata-signed' of git://git.kernel.org/pub/scm/linux/kernel/git/tmlind/linux-omap: (56 commits)
      ARM: OMAP2+: Drop legacy platform data for sdma
      ARM: OMAP2+: Drop legacy init for sdma
      dmaengine: ti: omap-dma: Use cpu notifier to block idle for omap2
      dmaengine: ti: omap-dma: Allocate channels directly
      dmaengine: ti: omap-dma: Pass sdma auxdata to driver and use it
      dmaengine: ti: omap-dma: Configure global priority register directly
      ARM: OMAP5: hwmod-data: remove OMAP5 IOMMU hwmod data
      ARM: OMAP4: hwmod-data: remove OMAP4 IOMMU hwmod data
      ARM: OMAP2+: Drop legacy platform data for omap4 fdif
      ARM: OMAP2+: Drop legacy platform data for omap4 slimbus
      ARM: OMAP2+: Drop legacy platform data for omap5 kbd
      ARM: OMAP2+: Drop legacy platform data for omap4 kbd
      ARM: OMAP2+: Drop legacy platform data for dra7 smartreflex
      ARM: OMAP2+: Drop legacy platform data for omap4 smartreflex
      ARM: OMAP2+: Drop legacy platform data for omap4 hsi
      ARM: OMAP2+: Drop legacy platform data for am4 vpfe
      ARM: OMAP2+: Drop legacy platform data for dra7 ocp2scp
      ARM: OMAP2+: Drop legacy platform data for omap5 ocp2scp
      ARM: OMAP2+: Drop legacy platform data for omap4 ocp2scp
      ARM: OMAP2+: Drop legacy platform data for am4 ocp2scp
      ...
    
    Link: https://lore.kernel.org/r/pull-1578420398-290837@atomide.com-4
    Signed-off-by: Olof Johansson <olof@lixom.net>

commit 785ca50f8e616b27417436fac517687a81fff5b0
Merge: 8a6c3e88bb7a 4601832f4050
Author: Olof Johansson <olof@lixom.net>
Date:   Tue Jan 7 11:22:43 2020 -0800

    Merge branch 'omap/soc' into arm/dt
    
    Bringing in to resolve soc -> add/add conflicts locally
    
    * omap/soc:
      ARM: OMAP2+: use separate IOMMU pdata to fix DRA7 IPU1 boot
      ARM: OMAP2+: omap-iommu.c conversion to ti-sysc
      ARM: OMAP2+: Add workaround for DRA7 DSP MStandby errata i879
      ARM: OMAP4+: remove pdata quirks for omap4+ iommus
      ARM: OMAP2+: pdata-quirks: add PRM data for reset support
      ARM: OMAP2+: am43xx: Add lcdc clockdomain
    Signed-off-by: Olof Johansson <olof@lixom.net>

commit 211010aeb097d7932809c3bb2144163900a91738
Author: Tony Lindgren <tony@atomide.com>
Date:   Mon Dec 16 14:41:53 2019 -0800

    dmaengine: ti: omap-dma: Pass sdma auxdata to driver and use it
    
    We can now start passing sdma auxdata to the dmaengine driver to start
    removing the platform based sdma init.
    
    Cc: Aaro Koskinen <aaro.koskinen@iki.fi>
    Cc: Arnd Bergmann <arnd@arndb.de>
    Cc: Peter Ujfalusi <peter.ujfalusi@ti.com>
    Cc: Russell King <rmk+kernel@armlinux.org.uk>
    Cc: Vinod Koul <vkoul@kernel.org>
    Acked-by: Peter Ujfalusi <peter.ujfalusi@ti.com>
    Tested-by: Peter Ujfalusi <peter.ujfalusi@ti.com>
    Acked-by: Vinod Koul <vkoul@kernel.org>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index e95c224ffc4d..922ee10a1630 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -514,6 +514,7 @@ static struct of_dev_auxdata omap_auxdata_lookup[] = {
 	/* Common auxdata */
 	OF_DEV_AUXDATA("ti,sysc", 0, NULL, &ti_sysc_pdata),
 	OF_DEV_AUXDATA("pinctrl-single", 0, NULL, &pcs_pdata),
+	OF_DEV_AUXDATA("ti,omap-sdma", 0, NULL, &dma_plat_info),
 	{ /* sentinel */ },
 };
 

commit 4601832f40501efc3c2fd264a5a69bd1ac17d520
Author: Suman Anna <s-anna@ti.com>
Date:   Thu Dec 12 15:05:41 2019 +0200

    ARM: OMAP2+: use separate IOMMU pdata to fix DRA7 IPU1 boot
    
    The IPU1 MMU has been using common IOMMU pdata quirks defined and
    used by all IPU IOMMU devices on OMAP4 and beyond. Separate out the
    pdata for IPU1 MMU with the additional .set_pwrdm_constraint ops
    plugged in, so that the IPU1 power domain can be restricted to ON
    state during the boot and active period of the IPU1 remote processor.
    This eliminates the pre-conditions for the IPU1 boot issue as
    described in commit afe518400bdb ("iommu/omap: fix boot issue on
    remoteprocs with AMMU/Unicache").
    
    NOTE:
    1. RET is not a valid target power domain state on DRA7 platforms,
       and IPU power domain is normally programmed for OFF. The IPU1
       still fails to boot though, and an unclearable l3_noc error is
       thrown currently on 4.14 kernel without this fix. This behavior
       is slightly different from previous 4.9 LTS kernel.
    2. The fix is currently applied only to IPU1 on DRA7xx SoC, as the
       other affected processors on OMAP4/OMAP5/DRA7 are in domains
       that are not entering RET. IPU2 on DRA7 is in CORE power domain
       which is only programmed for ON power state. The fix can be easily
       scaled if these domains do hit RET in the future.
    3. The issue was not seen on current DRA7 platforms if any of the
       DSP remote processors were booted and using one of the GPTimers
       5, 6, 7 or 8 on previous 4.9 LTS kernel. This was due to the
       errata fix for i874 implemented in commit 1cbabcb9807e ("ARM:
       DRA7: clockdomain: Implement timer workaround for errata i874")
       which keeps the IPU1 power domain from entering RET when the
       timers are active. But the timer workaround did not make any
       difference on 4.14 kernel, and an l3_noc error was seen still
       without this fix.
    
    Signed-off-by: Suman Anna <s-anna@ti.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 88ca7f82510a..7c6e57e4bcb2 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -43,6 +43,17 @@ struct pdata_init {
 static struct of_dev_auxdata omap_auxdata_lookup[];
 static struct twl4030_gpio_platform_data twl_gpio_auxdata;
 
+#if IS_ENABLED(CONFIG_OMAP_IOMMU)
+int omap_iommu_set_pwrdm_constraint(struct platform_device *pdev, bool request,
+				    u8 *pwrst);
+#else
+static inline int omap_iommu_set_pwrdm_constraint(struct platform_device *pdev,
+						  bool request, u8 *pwrst)
+{
+	return 0;
+}
+#endif
+
 #ifdef CONFIG_MACH_NOKIA_N8X0
 static void __init omap2420_n8x0_legacy_init(void)
 {
@@ -276,6 +287,10 @@ static void __init omap5_uevm_legacy_init(void)
 #endif
 
 #ifdef CONFIG_SOC_DRA7XX
+static struct iommu_platform_data dra7_ipu1_dsp_iommu_pdata = {
+	.set_pwrdm_constraint = omap_iommu_set_pwrdm_constraint,
+};
+
 static struct omap_hsmmc_platform_data dra7_hsmmc_data_mmc1;
 static struct omap_hsmmc_platform_data dra7_hsmmc_data_mmc2;
 static struct omap_hsmmc_platform_data dra7_hsmmc_data_mmc3;
@@ -499,6 +514,12 @@ static struct of_dev_auxdata omap_auxdata_lookup[] = {
 		       &dra7_hsmmc_data_mmc2),
 	OF_DEV_AUXDATA("ti,dra7-hsmmc", 0x480ad000, "480ad000.mmc",
 		       &dra7_hsmmc_data_mmc3),
+	OF_DEV_AUXDATA("ti,dra7-dsp-iommu", 0x40d01000, "40d01000.mmu",
+		       &dra7_ipu1_dsp_iommu_pdata),
+	OF_DEV_AUXDATA("ti,dra7-dsp-iommu", 0x41501000, "41501000.mmu",
+		       &dra7_ipu1_dsp_iommu_pdata),
+	OF_DEV_AUXDATA("ti,dra7-iommu", 0x58882000, "58882000.mmu",
+		       &dra7_ipu1_dsp_iommu_pdata),
 #endif
 	/* Common auxdata */
 	OF_DEV_AUXDATA("ti,sysc", 0, NULL, &ti_sysc_pdata),

commit e4c4b540e1e6c21ff8b987e92b2bd170ee006a94
Author: Tero Kristo <t-kristo@ti.com>
Date:   Thu Dec 12 15:05:38 2019 +0200

    ARM: OMAP4+: remove pdata quirks for omap4+ iommus
    
    IOMMU driver will be using ti-sysc bus driver for power management control
    going forward, and the pdata quirks are not needed for anything anymore.
    
    Signed-off-by: Tero Kristo <t-kristo@ti.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index d8260e61ef92..88ca7f82510a 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -261,16 +261,6 @@ static void __init omap3_pandora_legacy_init(void)
 }
 #endif /* CONFIG_ARCH_OMAP3 */
 
-#if defined(CONFIG_ARCH_OMAP4) || defined(CONFIG_SOC_OMAP5)
-static struct iommu_platform_data omap4_iommu_pdata = {
-	.reset_name = "mmu_cache",
-	.assert_reset = omap_device_assert_hardreset,
-	.deassert_reset = omap_device_deassert_hardreset,
-	.device_enable = omap_device_enable,
-	.device_idle = omap_device_idle,
-};
-#endif
-
 #if defined(CONFIG_SOC_AM33XX) || defined(CONFIG_SOC_AM43XX)
 static struct wkup_m3_platform_data wkup_m3_data = {
 	.reset_name = "wkup_m3",
@@ -495,10 +485,6 @@ static struct of_dev_auxdata omap_auxdata_lookup[] = {
 		       &wkup_m3_data),
 #endif
 #if defined(CONFIG_ARCH_OMAP4) || defined(CONFIG_SOC_OMAP5)
-	OF_DEV_AUXDATA("ti,omap4-iommu", 0x4a066000, "4a066000.mmu",
-		       &omap4_iommu_pdata),
-	OF_DEV_AUXDATA("ti,omap4-iommu", 0x55082000, "55082000.mmu",
-		       &omap4_iommu_pdata),
 	OF_DEV_AUXDATA("ti,omap4-smartreflex-iva", 0x4a0db000,
 		       "4a0db000.smartreflex", &omap_sr_pdata[OMAP_SR_IVA]),
 	OF_DEV_AUXDATA("ti,omap4-smartreflex-core", 0x4a0dd000,

commit 8de44fb70659a5bc0c53a443e6129ea1bf00fd8b
Author: Tero Kristo <t-kristo@ti.com>
Date:   Thu Dec 12 15:05:37 2019 +0200

    ARM: OMAP2+: pdata-quirks: add PRM data for reset support
    
    The parent clockdomain for reset must be in force wakeup mode, otherwise
    the reset may never complete. Add pdata quirks for this purpose for PRM
    driver.
    
    Signed-off-by: Tero Kristo <t-kristo@ti.com>
    Acked-by: Tony Lindgren <tony@atomide.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index ca52271de5a8..d8260e61ef92 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -23,6 +23,7 @@
 #include <linux/platform_data/ti-sysc.h>
 #include <linux/platform_data/wkup_m3.h>
 #include <linux/platform_data/asoc-ti-mcbsp.h>
+#include <linux/platform_data/ti-prm.h>
 
 #include "clockdomain.h"
 #include "common.h"
@@ -408,6 +409,12 @@ void omap_pcs_legacy_init(int irq, void (*rearm)(void))
 	pcs_pdata.rearm = rearm;
 }
 
+static struct ti_prm_platform_data ti_prm_pdata = {
+	.clkdm_deny_idle = clkdm_deny_idle,
+	.clkdm_allow_idle = clkdm_allow_idle,
+	.clkdm_lookup = clkdm_lookup,
+};
+
 /*
  * GPIOs for TWL are initialized by the I2C bus and need custom
  * handing until DSS has device tree bindings.
@@ -510,6 +517,7 @@ static struct of_dev_auxdata omap_auxdata_lookup[] = {
 	/* Common auxdata */
 	OF_DEV_AUXDATA("ti,sysc", 0, NULL, &ti_sysc_pdata),
 	OF_DEV_AUXDATA("pinctrl-single", 0, NULL, &pcs_pdata),
+	OF_DEV_AUXDATA("ti,omap-prm-inst", 0, NULL, &ti_prm_pdata),
 	{ /* sentinel */ },
 };
 

commit 90bdfa0b05e3cc809a7c1aa3b1f162b46ea1b330
Author: Tony Lindgren <tony@atomide.com>
Date:   Mon Dec 16 14:41:53 2019 -0800

    ARM: OMAP2+: Fix ti_sysc_find_one_clockdomain to check for to_clk_hw_omap
    
    We must bail out early if the clock is not hw_omap. Otherwise we will
    try to access invalid address with hwclk->clkdm_name:
    
    Unable to handle kernel paging request at virtual address ffffffff
    Internal error: Oops: 27 [#1] ARM
    ...
    (strcmp) from [<c011b348>] (clkdm_lookup+0x40/0x60)
    [<c011b348>] (clkdm_lookup) from [<c011cb84>] (ti_sysc_clkdm_init+0x5c/0x64)
    [<c011cb84>] (ti_sysc_clkdm_init) from [<c03680a8>] (sysc_probe+0x948/0x117c)
    [<c03680a8>] (sysc_probe) from [<c03d0af4>] (platform_drv_probe+0x48/0x98)
    ...
    
    Fixes: 2b2f7def058a ("bus: ti-sysc: Add support for missing clockdomain handling")
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index ca52271de5a8..e95c224ffc4d 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -306,10 +306,14 @@ static void __init dra7x_evm_mmc_quirk(void)
 
 static struct clockdomain *ti_sysc_find_one_clockdomain(struct clk *clk)
 {
+	struct clk_hw *hw = __clk_get_hw(clk);
 	struct clockdomain *clkdm = NULL;
 	struct clk_hw_omap *hwclk;
 
-	hwclk = to_clk_hw_omap(__clk_get_hw(clk));
+	hwclk = to_clk_hw_omap(hw);
+	if (!omap2_clk_is_hw_omap(hw))
+		return NULL;
+
 	if (hwclk && hwclk->clkdm_name)
 		clkdm = clkdm_lookup(hwclk->clkdm_name);
 

commit 38206c24ab09b4f4c2a57de5c1af0bb2e69cf5b6
Merge: d9e48dc2a71a ab818f0999dc
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu Dec 5 11:38:40 2019 -0800

    Merge tag 'armsoc-soc' of git://git.kernel.org/pub/scm/linux/kernel/git/soc/soc
    
    Pull ARM SoC platform updates from Olof Johansson:
     "Most of these are for MMP (seeing a bunch of cleanups and refactorings
      for the first time in a while), and for OMAP (a bunch of cleanups and
      added support for voltage controller on OMAP4430)"
    
    * tag 'armsoc-soc' of git://git.kernel.org/pub/scm/linux/kernel/git/soc/soc: (51 commits)
      ARM: OMAP2+: Add missing put_device() call in omapdss_init_of()
      OMAP2: fixup doc comments in omap_device
      ARM: OMAP1: drop duplicated dependency on ARCH_OMAP1
      ARM: ASPEED: update default ARCH_NR_GPIO for ARCH_ASPEED
      ARM: imx: use generic function to exit coherency
      ARM: tegra: Use WFE for power-gating on Tegra30
      ARM: tegra: Fix FLOW_CTLR_HALT register clobbering by tegra_resume()
      ARM: exynos: Enable exynos-asv driver for ARCH_EXYNOS
      ARM: s3c: Rename s5p_usb_phy functions
      ARM: s3c: Rename s3c64xx_spi_setname() function
      ARM: imx: Add serial number support for i.MX6/7 SoCs
      ARM: imx: Drop imx_anatop_usb_chrg_detect_disable()
      arm64: Introduce config for S32
      ARM: hisi: drop useless depend on ARCH_MULTI_V7
      arm64: realtek: Select reset controller
      ARM: shmobile: rcar-gen2: Drop legacy DT clock support
      ARM: OMAP2+: Remove duplicated include from pmic-cpcap.c
      ARM: OMAP1: ams-delta FIQ: Fix a typo ("Initiaize")
      MAINTAINERS: Add logicpd-som-lv and logicpd-torpedo to OMAP TREE
      ARM: OMAP2+: pdata-quirks: drop TI_ST/KIM support
      ...

commit 0e45384cecccaa950783e67e7a29ed470133f19d
Merge: dc5fa4656864 def7bd940f8c
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Nov 27 10:03:52 2019 -0800

    Merge tag 'mmc-v5.5' of git://git.kernel.org/pub/scm/linux/kernel/git/ulfh/mmc
    
    Pull MMC updates from Ulf Hansson:
     "These are the updates for MMC and MEMSTICK for v5.5.
    
      Note that this also contains quite some additional changes reaching
      beyond both the MMC and MEMSTICK subsystems. This is primarily because
      of fixing an old regression for a WiFi driver based on the SDIO
      interface on an OMAP openpandora board
    
      MMC core:
       - Add CMD13 polling for MMC IOCTLS with R1B response.
       - Add common DT properties for clk-phase-delays for various speed
         modes.
       - Fix size overflow for mmc gp-partitions.
       - Re-work HW reset for SDIO cards, which also includes a re-work for
         Marvell's WiFi mwifiex SDIO func driver.
    
      MMC host:
       - jz4740: Add support for X1000 and JZ4760.
       - jz4740: Add support for 8-bit bus and for low power mode.
       - mmci: Add support for HW busy timeout for the stm32_sdmmc variant.
       - owl-mmc: Add driver for Actions Semi Owl SoCs SD/MMC controller.
       - renesas_sdhi: Add support for r8a774b1.
       - sdhci_am654: Add support for Command Queuing Engine for J721E.
       - sdhci-milbeaut: Add driver for the Milbeaut SD controller.
       - sdhci-of-arasan: Add support for ZynqMP tap-delays.
       - sdhci-of-arasan: Add support for clk-phase-delays for SD cards.
       - sdhci-of-arasan: Add support for Intel LGM SDXC.
       - sdhci-of-aspeed: Allow inversion of the internal card detect
         signal.
       - sdhci-of-esdhc: Fixup workaround for erratum A-008171 for tunings.
       - sdhci-of-at91: Improve support for calibration.
       - sdhci-pci: Add support for Intel JSL.
       - sdhci-pci: Add quirk for AMD SDHC Device 0x7906.
       - tmio: Enable support for erase/discard/trim requests.
    
      MMC/OMAP/pandora/wl1251:
    
      The TI wl1251 WiFi driver for SDIO on the OMAP openpandora board has
      been broken since v4.7. To fix the problems, changes have been made
      cross subsystems, but also to OMAP2 machine code and to openpandora
      DTS files, as summarized below. Relevant changes have been tagged for
      stable.
    
       - mmc/wl1251: Re-introduce lost SDIO quirks and vendor-id for wl1251
       - omap/omap_hsmmc: Remove redundant platform config for openpandora
       - omap_hsmmc: Initialize non-std SDIO card for wl1251 for pandora
       - omap/dts/pandora: Specify wl1251 through a child node of mmc3
       - wl1251: Add devicetree support for TI wl1251 SDIO"
    
    * tag 'mmc-v5.5' of git://git.kernel.org/pub/scm/linux/kernel/git/ulfh/mmc: (73 commits)
      dt-bindings: mmc: Correct the type of the clk phase properties
      Revert "mmc: tmio: remove workaround for NON_REMOVABLE"
      memstick: Fix Kconfig indentation
      mmc: sdhci-of-arasan: Add support for ZynqMP Platform Tap Delays Setup
      dt-bindings: mmc: arasan: Document 'xlnx,zynqmp-8.9a' controller
      firmware: xilinx: Add SDIO Tap Delay nodes
      mmc: sdhci-of-arasan: Add support to set clock phase delays for SD
      dt-bindings: mmc: Add optional generic properties for mmc
      mmc: sdhci-of-arasan: Add sampling clock for a phy to use
      dt-bindings: mmc: arasan: Update Documentation for the input clock
      mmc: sdhci-of-arasan: Separate out clk related data to another structure
      mmc: sdhci: Fix grammar in warning message
      mmc: sdhci-of-aspeed: add inversion signal presence
      mmc: sdhci-of-aspeed: enable CONFIG_MMC_SDHCI_IO_ACCESSORS
      mmc: sdhci_am654: Add Support for Command Queuing Engine to J721E
      mmc: core: Fix size overflow for mmc partitions
      mmc: tmio: Add MMC_CAP_ERASE to allow erase/discard/trim requests
      net: wireless: ti: remove local VENDOR_ID and DEVICE_ID definitions
      net: wireless: ti: wl1251 use new SDIO_VENDOR_ID_TI_WL1251 definition
      mmc: core: fix wl1251 sdio quirks
      ...

commit 642356cb5f4a8c82b5ca5ebac288c327d10df236
Merge: f838767555d4 4ee812f6143d
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Mon Nov 25 19:49:58 2019 -0800

    Merge git://git.kernel.org/pub/scm/linux/kernel/git/herbert/crypto-2.6
    
    Pull crypto updates from Herbert Xu:
     "API:
       - Add library interfaces of certain crypto algorithms for WireGuard
       - Remove the obsolete ablkcipher and blkcipher interfaces
       - Move add_early_randomness() out of rng_mutex
    
      Algorithms:
       - Add blake2b shash algorithm
       - Add blake2s shash algorithm
       - Add curve25519 kpp algorithm
       - Implement 4 way interleave in arm64/gcm-ce
       - Implement ciphertext stealing in powerpc/spe-xts
       - Add Eric Biggers's scalar accelerated ChaCha code for ARM
       - Add accelerated 32r2 code from Zinc for MIPS
       - Add OpenSSL/CRYPTOGRAMS poly1305 implementation for ARM and MIPS
    
      Drivers:
       - Fix entropy reading failures in ks-sa
       - Add support for sam9x60 in atmel
       - Add crypto accelerator for amlogic GXL
       - Add sun8i-ce Crypto Engine
       - Add sun8i-ss cryptographic offloader
       - Add a host of algorithms to inside-secure
       - Add NPCM RNG driver
       - add HiSilicon HPRE accelerator
       - Add HiSilicon TRNG driver"
    
    * git://git.kernel.org/pub/scm/linux/kernel/git/herbert/crypto-2.6: (285 commits)
      crypto: vmx - Avoid weird build failures
      crypto: lib/chacha20poly1305 - use chacha20_crypt()
      crypto: x86/chacha - only unregister algorithms if registered
      crypto: chacha_generic - remove unnecessary setkey() functions
      crypto: amlogic - enable working on big endian kernel
      crypto: sun8i-ce - enable working on big endian
      crypto: mips/chacha - select CRYPTO_SKCIPHER, not CRYPTO_BLKCIPHER
      hwrng: ks-sa - Enable COMPILE_TEST
      crypto: essiv - remove redundant null pointer check before kfree
      crypto: atmel-aes - Change data type for "lastc" buffer
      crypto: atmel-tdes - Set the IV after {en,de}crypt
      crypto: sun4i-ss - fix big endian issues
      crypto: sun4i-ss - hide the Invalid keylen message
      crypto: sun4i-ss - use crypto_ahash_digestsize
      crypto: sun4i-ss - remove dependency on not 64BIT
      crypto: sun4i-ss - Fix 64-bit size_t warnings on sun4i-ss-hash.c
      MAINTAINERS: Add maintainer for HiSilicon SEC V2 driver
      crypto: hisilicon - add DebugFS for HiSilicon SEC
      Documentation: add DebugFS doc for HiSilicon SEC
      crypto: hisilicon - add SRIOV for HiSilicon SEC
      ...

commit 5d6bed6f48110d98bf3f5083ea8d6fde389c5de3
Author: H. Nikolaus Schaller <hns@goldelico.com>
Date:   Thu Nov 7 11:30:40 2019 +0100

    omap: remove omap2_hsmmc_info in old hsmmc.[ch] and update Makefile
    
    There is a new driver in drivers/mmc/host/omap_hsmmc.c
    configured by CONFIG_MMC_OMAP_HS and the last user
    was the pdata-quirks for pandora.
    
    Suggested-by: Tony Lindgren <tony@atomide.com>
    Signed-off-by: H. Nikolaus Schaller <hns@goldelico.com>
    Acked-by: Tony Lindgren <tony@atomide.com>
    Signed-off-by: Ulf Hansson <ulf.hansson@linaro.org>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 1b7cf81ff035..ad0e00724578 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -32,7 +32,6 @@
 #include "omap_device.h"
 #include "omap-secure.h"
 #include "soc.h"
-#include "hsmmc.h"
 
 static struct omap_hsmmc_platform_data __maybe_unused mmc_pdata[2];
 

commit 2398c41d64321e62af54424fd399964f3d48cdc2
Author: H. Nikolaus Schaller <hns@goldelico.com>
Date:   Thu Nov 7 11:30:39 2019 +0100

    omap: pdata-quirks: remove openpandora quirks for mmc3 and wl1251
    
    With a wl1251 child node of mmc3 in the device tree decoded
    in omap_hsmmc.c to handle special wl1251 initialization, we do
    no longer need to instantiate the mmc3 through pdata quirks.
    
    We also can remove the wlan regulator and reset/interrupt definitions
    and do them through device tree.
    
    Fixes: 81eef6ca9201 ("mmc: omap_hsmmc: Use dma_request_chan() for requesting DMA channel")
    Signed-off-by: H. Nikolaus Schaller <hns@goldelico.com>
    Cc: <stable@vger.kernel.org> # v4.7+
    Acked-by: Tony Lindgren <tony@atomide.com>
    Signed-off-by: Ulf Hansson <ulf.hansson@linaro.org>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 800a602c06ec..1b7cf81ff035 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -310,108 +310,15 @@ static void __init omap3_logicpd_torpedo_init(void)
 }
 
 /* omap3pandora legacy devices */
-#define PANDORA_WIFI_IRQ_GPIO		21
-#define PANDORA_WIFI_NRESET_GPIO	23
 
 static struct platform_device pandora_backlight = {
 	.name	= "pandora-backlight",
 	.id	= -1,
 };
 
-static struct regulator_consumer_supply pandora_vmmc3_supply[] = {
-	REGULATOR_SUPPLY("vmmc", "omap_hsmmc.2"),
-};
-
-static struct regulator_init_data pandora_vmmc3 = {
-	.constraints = {
-		.valid_ops_mask		= REGULATOR_CHANGE_STATUS,
-	},
-	.num_consumer_supplies	= ARRAY_SIZE(pandora_vmmc3_supply),
-	.consumer_supplies	= pandora_vmmc3_supply,
-};
-
-static struct fixed_voltage_config pandora_vwlan = {
-	.supply_name		= "vwlan",
-	.microvolts		= 1800000, /* 1.8V */
-	.gpio			= PANDORA_WIFI_NRESET_GPIO,
-	.startup_delay		= 50000, /* 50ms */
-	.enable_high		= 1,
-	.init_data		= &pandora_vmmc3,
-};
-
-static struct platform_device pandora_vwlan_device = {
-	.name		= "reg-fixed-voltage",
-	.id		= 1,
-	.dev = {
-		.platform_data = &pandora_vwlan,
-	},
-};
-
-static void pandora_wl1251_init_card(struct mmc_card *card)
-{
-	/*
-	 * We have TI wl1251 attached to MMC3. Pass this information to
-	 * SDIO core because it can't be probed by normal methods.
-	 */
-	if (card->type == MMC_TYPE_SDIO || card->type == MMC_TYPE_SD_COMBO) {
-		card->quirks |= MMC_QUIRK_NONSTD_SDIO;
-		card->cccr.wide_bus = 1;
-		card->cis.vendor = 0x104c;
-		card->cis.device = 0x9066;
-		card->cis.blksize = 512;
-		card->cis.max_dtr = 24000000;
-		card->ocr = 0x80;
-	}
-}
-
-static struct omap2_hsmmc_info pandora_mmc3[] = {
-	{
-		.mmc		= 3,
-		.caps		= MMC_CAP_4_BIT_DATA | MMC_CAP_POWER_OFF_CARD,
-		.gpio_cd	= -EINVAL,
-		.gpio_wp	= -EINVAL,
-		.init_card	= pandora_wl1251_init_card,
-	},
-	{}	/* Terminator */
-};
-
-static void __init pandora_wl1251_init(void)
-{
-	struct wl1251_platform_data pandora_wl1251_pdata;
-	int ret;
-
-	memset(&pandora_wl1251_pdata, 0, sizeof(pandora_wl1251_pdata));
-
-	pandora_wl1251_pdata.power_gpio = -1;
-
-	ret = gpio_request_one(PANDORA_WIFI_IRQ_GPIO, GPIOF_IN, "wl1251 irq");
-	if (ret < 0)
-		goto fail;
-
-	pandora_wl1251_pdata.irq = gpio_to_irq(PANDORA_WIFI_IRQ_GPIO);
-	if (pandora_wl1251_pdata.irq < 0)
-		goto fail_irq;
-
-	pandora_wl1251_pdata.use_eeprom = true;
-	ret = wl1251_set_platform_data(&pandora_wl1251_pdata);
-	if (ret < 0)
-		goto fail_irq;
-
-	return;
-
-fail_irq:
-	gpio_free(PANDORA_WIFI_IRQ_GPIO);
-fail:
-	pr_err("wl1251 board initialisation failed\n");
-}
-
 static void __init omap3_pandora_legacy_init(void)
 {
 	platform_device_register(&pandora_backlight);
-	platform_device_register(&pandora_vwlan_device);
-	omap_hsmmc_init(pandora_mmc3);
-	omap_hsmmc_late_init(pandora_mmc3);
-	pandora_wl1251_init();
 }
 #endif /* CONFIG_ARCH_OMAP3 */
 

commit 4e8fad98171babe019db51c15055ec74697e9525
Author: H. Nikolaus Schaller <hns@goldelico.com>
Date:   Thu Nov 7 11:30:38 2019 +0100

    omap: pdata-quirks: revert pandora specific gpiod additions
    
    This partly reverts the commit efdfeb079cc3 ("regulator: fixed: Convert to
    use GPIO descriptor only").
    
    We must remove this from mainline first, so that the following patch
    to remove the openpandora quirks for mmc3 and wl1251 cleanly applies
    to stable v4.9, v4.14, v4.19 where the above mentioned patch is not yet
    present.
    
    Since the code affected is removed (no pandora gpios in pdata-quirks
    and more), there will be no matching revert-of-the-revert.
    
    Signed-off-by: H. Nikolaus Schaller <hns@goldelico.com>
    Acked-by: Tony Lindgren <tony@atomide.com>
    Signed-off-by: Ulf Hansson <ulf.hansson@linaro.org>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 2efd18e8824c..800a602c06ec 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -7,7 +7,6 @@
 #include <linux/clk.h>
 #include <linux/davinci_emac.h>
 #include <linux/gpio.h>
-#include <linux/gpio/machine.h>
 #include <linux/init.h>
 #include <linux/kernel.h>
 #include <linux/of_platform.h>
@@ -334,7 +333,9 @@ static struct regulator_init_data pandora_vmmc3 = {
 static struct fixed_voltage_config pandora_vwlan = {
 	.supply_name		= "vwlan",
 	.microvolts		= 1800000, /* 1.8V */
+	.gpio			= PANDORA_WIFI_NRESET_GPIO,
 	.startup_delay		= 50000, /* 50ms */
+	.enable_high		= 1,
 	.init_data		= &pandora_vmmc3,
 };
 
@@ -346,19 +347,6 @@ static struct platform_device pandora_vwlan_device = {
 	},
 };
 
-static struct gpiod_lookup_table pandora_vwlan_gpiod_table = {
-	.dev_id = "reg-fixed-voltage.1",
-	.table = {
-		/*
-		 * As this is a low GPIO number it should be at the first
-		 * GPIO bank.
-		 */
-		GPIO_LOOKUP("gpio-0-31", PANDORA_WIFI_NRESET_GPIO,
-			    NULL, GPIO_ACTIVE_HIGH),
-		{ },
-	},
-};
-
 static void pandora_wl1251_init_card(struct mmc_card *card)
 {
 	/*
@@ -380,6 +368,8 @@ static struct omap2_hsmmc_info pandora_mmc3[] = {
 	{
 		.mmc		= 3,
 		.caps		= MMC_CAP_4_BIT_DATA | MMC_CAP_POWER_OFF_CARD,
+		.gpio_cd	= -EINVAL,
+		.gpio_wp	= -EINVAL,
 		.init_card	= pandora_wl1251_init_card,
 	},
 	{}	/* Terminator */
@@ -418,7 +408,6 @@ static void __init pandora_wl1251_init(void)
 static void __init omap3_pandora_legacy_init(void)
 {
 	platform_device_register(&pandora_backlight);
-	gpiod_add_lookup_table(&pandora_vwlan_gpiod_table);
 	platform_device_register(&pandora_vwlan_device);
 	omap_hsmmc_init(pandora_mmc3);
 	omap_hsmmc_late_init(pandora_mmc3);

commit 1994ebd1f746fcfaee316875ef13118e9df0d2a3
Author: Sebastian Reichel <sebastian.reichel@collabora.com>
Date:   Thu Oct 3 15:41:46 2019 +0200

    ARM: OMAP2+: pdata-quirks: drop TI_ST/KIM support
    
    All TI_ST users have been migrated to the new serdev based HCILL
    bluetooth driver. That driver is initialized from DT and does not
    need any platform quirks.
    
    Signed-off-by: Sebastian Reichel <sebastian.reichel@collabora.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index d942a3357090..02abeb44cab2 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -11,7 +11,6 @@
 #include <linux/init.h>
 #include <linux/kernel.h>
 #include <linux/of_platform.h>
-#include <linux/ti_wilink_st.h>
 #include <linux/wl12xx.h>
 #include <linux/mmc/card.h>
 #include <linux/mmc/host.h>
@@ -139,53 +138,6 @@ static void __init omap3_sbc_t3530_legacy_init(void)
 	omap3_sbc_t3x_usb_hub_init(167, "sb-t35 usb hub");
 }
 
-static struct ti_st_plat_data wilink_pdata = {
-	.nshutdown_gpio = 137,
-	.dev_name = "/dev/ttyO1",
-	.flow_cntrl = 1,
-	.baud_rate = 300000,
-};
-
-static struct platform_device wl18xx_device = {
-	.name	= "kim",
-	.id	= -1,
-	.dev	= {
-		.platform_data = &wilink_pdata,
-	}
-};
-
-static struct ti_st_plat_data wilink7_pdata = {
-	.nshutdown_gpio = 162,
-	.dev_name = "/dev/ttyO1",
-	.flow_cntrl = 1,
-	.baud_rate = 3000000,
-};
-
-static struct platform_device wl128x_device = {
-	.name	= "kim",
-	.id	= -1,
-	.dev	= {
-		.platform_data = &wilink7_pdata,
-	}
-};
-
-static struct platform_device btwilink_device = {
-	.name	= "btwilink",
-	.id	= -1,
-};
-
-static void __init omap3_igep0020_rev_f_legacy_init(void)
-{
-	platform_device_register(&wl18xx_device);
-	platform_device_register(&btwilink_device);
-}
-
-static void __init omap3_igep0030_rev_g_legacy_init(void)
-{
-	platform_device_register(&wl18xx_device);
-	platform_device_register(&btwilink_device);
-}
-
 static void __init omap3_evm_legacy_init(void)
 {
 	hsmmc2_internal_input_clk();
@@ -299,8 +251,6 @@ static void __init omap3_tao3530_legacy_init(void)
 static void __init omap3_logicpd_torpedo_init(void)
 {
 	omap3_gpio126_127_129();
-	platform_device_register(&wl128x_device);
-	platform_device_register(&btwilink_device);
 }
 
 /* omap3pandora legacy devices */
@@ -679,8 +629,6 @@ static struct pdata_init pdata_quirks[] __initdata = {
 	{ "nokia,omap3-n900", nokia_n900_legacy_init, },
 	{ "nokia,omap3-n9", hsmmc2_internal_input_clk, },
 	{ "nokia,omap3-n950", hsmmc2_internal_input_clk, },
-	{ "isee,omap3-igep0020-rev-f", omap3_igep0020_rev_f_legacy_init, },
-	{ "isee,omap3-igep0030-rev-g", omap3_igep0030_rev_g_legacy_init, },
 	{ "logicpd,dm3730-torpedo-devkit", omap3_logicpd_torpedo_init, },
 	{ "ti,omap3-evm-37xx", omap3_evm_legacy_init, },
 	{ "ti,am3517-evm", am3517_evm_legacy_init, },

commit 0af3e1a491dde06dfcb0b063d5b543dfebded0f9
Author: Suman Anna <s-anna@ti.com>
Date:   Mon Aug 26 19:14:52 2019 -0500

    ARM: OMAP2+: Add pdata for OMAP3 ISP IOMMU
    
    The OMAP3 ISP IOMMU does not have any reset lines, so it didn't
    need any pdata previously. The OMAP IOMMU driver now requires the
    platform data ops for device_enable/idle on all the IOMMU devices
    after commit db8918f61d51 ("iommu/omap: streamline enable/disable
    through runtime pm callbacks") to enable/disable the clocks properly
    and maintain the reference count and the omap_hwmod state machine.
    So, add these callbacks through iommu pdata quirks for the OMAP3
    ISP IOMMU.
    
    Signed-off-by: Suman Anna <s-anna@ti.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index ac5da6ad2017..2efd18e8824c 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -93,6 +93,11 @@ static struct iommu_platform_data omap3_iommu_pdata = {
 	.device_idle = omap_device_idle,
 };
 
+static struct iommu_platform_data omap3_iommu_isp_pdata = {
+	.device_enable = omap_device_enable,
+	.device_idle = omap_device_idle,
+};
+
 static int omap3_sbc_t3730_twl_callback(struct device *dev,
 					   unsigned gpio,
 					   unsigned ngpio)
@@ -621,6 +626,8 @@ static struct of_dev_auxdata omap_auxdata_lookup[] = {
 #ifdef CONFIG_ARCH_OMAP3
 	OF_DEV_AUXDATA("ti,omap2-iommu", 0x5d000000, "5d000000.mmu",
 		       &omap3_iommu_pdata),
+	OF_DEV_AUXDATA("ti,omap2-iommu", 0x480bd400, "480bd400.mmu",
+		       &omap3_iommu_isp_pdata),
 	OF_DEV_AUXDATA("ti,omap3-smartreflex-core", 0x480cb000,
 		       "480cb000.smartreflex", &omap_sr_pdata[OMAP_SR_CORE]),
 	OF_DEV_AUXDATA("ti,omap3-smartreflex-mpu-iva", 0x480c9000,

commit 19feeee5c5af114f3cb8ad2772680b7a1d16f043
Author: Suman Anna <s-anna@ti.com>
Date:   Mon Aug 26 19:14:51 2019 -0500

    ARM: OMAP2+: Plug in device_enable/idle ops for IOMMUs
    
    The OMAP IOMMU driver requires the device_enable/idle platform
    data ops on all the IOMMU devices to be able to enable and disable
    the clocks after commit db8918f61d51 ("iommu/omap: streamline
    enable/disable through runtime pm callbacks"). Plug in these
    pdata ops for all the existing IOMMUs through pdata quirks to
    maintain functionality.
    
    Signed-off-by: Suman Anna <s-anna@ti.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index d942a3357090..ac5da6ad2017 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -89,6 +89,8 @@ static struct iommu_platform_data omap3_iommu_pdata = {
 	.reset_name = "mmu",
 	.assert_reset = omap_device_assert_hardreset,
 	.deassert_reset = omap_device_deassert_hardreset,
+	.device_enable = omap_device_enable,
+	.device_idle = omap_device_idle,
 };
 
 static int omap3_sbc_t3730_twl_callback(struct device *dev,
@@ -424,6 +426,8 @@ static struct iommu_platform_data omap4_iommu_pdata = {
 	.reset_name = "mmu_cache",
 	.assert_reset = omap_device_assert_hardreset,
 	.deassert_reset = omap_device_deassert_hardreset,
+	.device_enable = omap_device_enable,
+	.device_idle = omap_device_idle,
 };
 #endif
 

commit 0c0ef9ea6f3f0d5979dc7b094b0a184c1a94716b
Author: Tony Lindgren <tony@atomide.com>
Date:   Sat Sep 14 14:02:55 2019 -0700

    hwrng: omap3-rom - Fix missing clock by probing with device tree
    
    Commit 0ed266d7ae5e ("clk: ti: omap3: cleanup unnecessary clock aliases")
    removed old omap3 clock framework aliases but caused omap3-rom-rng to
    stop working with clock not found error.
    
    Based on discussions on the mailing list it was requested by Tero Kristo
    that it would be best to fix this issue by probing omap3-rom-rng using
    device tree to provide a proper clk property. The other option would be
    to add back the missing clock alias, but that does not help moving things
    forward with removing old legacy platform_data.
    
    Let's also add a proper device tree binding and keep it together with
    the fix.
    
    Cc: devicetree@vger.kernel.org
    Cc: Aaro Koskinen <aaro.koskinen@iki.fi>
    Cc: Adam Ford <aford173@gmail.com>
    Cc: Pali Rohár <pali.rohar@gmail.com>
    Cc: Rob Herring <robh+dt@kernel.org>
    Cc: Sebastian Reichel <sre@kernel.org>
    Cc: Tero Kristo <t-kristo@ti.com>
    Fixes: 0ed266d7ae5e ("clk: ti: omap3: cleanup unnecessary clock aliases")
    Reported-by: Aaro Koskinen <aaro.koskinen@iki.fi>
    Signed-off-by: Tony Lindgren <tony@atomide.com>
    Acked-by: Rob Herring <robh@kernel.org>
    Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index b49ec3fbee4c..62cc90722848 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -262,14 +262,6 @@ static void __init am3517_evm_legacy_init(void)
 	am35xx_emac_reset();
 }
 
-static struct platform_device omap3_rom_rng_device = {
-	.name		= "omap3-rom-rng",
-	.id		= -1,
-	.dev	= {
-		.platform_data	= rx51_secure_rng_call,
-	},
-};
-
 static void __init nokia_n900_legacy_init(void)
 {
 	hsmmc2_internal_input_clk();
@@ -285,9 +277,6 @@ static void __init nokia_n900_legacy_init(void)
 			pr_warn("RX-51: Not enabling ARM errata 430973 workaround\n");
 			pr_warn("Thumb binaries may crash randomly without this workaround\n");
 		}
-
-		pr_info("RX-51: Registering OMAP3 HWRNG device\n");
-		platform_device_register(&omap3_rom_rng_device);
 	}
 }
 
@@ -627,6 +616,7 @@ static struct of_dev_auxdata omap_auxdata_lookup[] = {
 	OF_DEV_AUXDATA("ti,davinci_mdio", 0x5c030000, "davinci_mdio.0", NULL),
 	OF_DEV_AUXDATA("ti,am3517-emac", 0x5c000000, "davinci_emac.0",
 		       &am35xx_emac_pdata),
+	OF_DEV_AUXDATA("nokia,n900-rom-rng", 0, NULL, rx51_secure_rng_call),
 	/* McBSP modules with sidetone core */
 #if IS_ENABLED(CONFIG_SND_SOC_OMAP_MCBSP)
 	OF_DEV_AUXDATA("ti,omap3-mcbsp", 0x49022000, "49022000.mcbsp", &mcbsp_pdata),

commit 7fb61afb7b5b4389e0f6e78c3a822d5991d4edef
Author: Tony Lindgren <tony@atomide.com>
Date:   Sat Sep 14 14:02:54 2019 -0700

    ARM: OMAP2+: Check omap3-rom-rng for GP device instead of HS device
    
    In general we should check for GP device instead of HS device unless
    the other options such as EMU are also checked. Otherwise omap3-rom-rng
    won't probe on few of the old n900 macro boards still in service in
    automated build and boot test systems.
    
    Cc: Aaro Koskinen <aaro.koskinen@iki.fi>
    Cc: Adam Ford <aford173@gmail.com>
    Cc: Pali Rohár <pali.rohar@gmail.com>
    Cc: Sebastian Reichel <sre@kernel.org>
    Cc: Tero Kristo <t-kristo@ti.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>
    Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index d942a3357090..b49ec3fbee4c 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -276,7 +276,7 @@ static void __init nokia_n900_legacy_init(void)
 	mmc_pdata[0].name = "external";
 	mmc_pdata[1].name = "internal";
 
-	if (omap_type() == OMAP2_DEVICE_TYPE_SEC) {
+	if (omap_type() != OMAP2_DEVICE_TYPE_GP) {
 		if (IS_ENABLED(CONFIG_ARM_ERRATA_430973)) {
 			pr_info("RX-51: Enabling ARM errata 430973 workaround\n");
 			/* set IBE to 1 */

commit 2783d0638a51e8dba6319d9f4a2b445995a4fad1
Author: Tony Lindgren <tony@atomide.com>
Date:   Thu Sep 5 13:01:29 2019 -0700

    bus: ti-sysc: Fix handling of invalid clocks
    
    We can currently get "Unable to handle kernel paging request at
    virtual address" for invalid clocks with dts node but no driver:
    
    (__clk_get_hw) from [<c0138ebc>] (ti_sysc_find_one_clockdomain+0x18/0x34)
    (ti_sysc_find_one_clockdomain) from [<c0138f0c>] (ti_sysc_clkdm_init+0x34/0xdc)
    (ti_sysc_clkdm_init) from [<c0584660>] (sysc_probe+0xa50/0x10e8)
    (sysc_probe) from [<c065c6ac>] (platform_drv_probe+0x58/0xa8)
    
    Let's add IS_ERR checks to ti_sysc_clkdm_init() as And let's start treating
    clk_get() with -ENOENT as a proper error. If the clock name is specified
    in device tree we must succeed with clk_get() to continue. For modules with
    no clock names specified in device tree we will just ignore the clocks.
    
    Fixes: 2b2f7def058a ("bus: ti-sysc: Add support for missing clockdomain handling")
    Acked-by: Roger Quadros <rogerq@ti.com>
    Tested-by: Keerthy <j-keerthy@ti.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 6c6f8fce854e..d942a3357090 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -491,11 +491,11 @@ static int ti_sysc_clkdm_init(struct device *dev,
 			      struct clk *fck, struct clk *ick,
 			      struct ti_sysc_cookie *cookie)
 {
-	if (fck)
+	if (!IS_ERR(fck))
 		cookie->clkdm = ti_sysc_find_one_clockdomain(fck);
 	if (cookie->clkdm)
 		return 0;
-	if (ick)
+	if (!IS_ERR(ick))
 		cookie->clkdm = ti_sysc_find_one_clockdomain(ick);
 	if (cookie->clkdm)
 		return 0;

commit 8362fd64f07eaef7155c94fca8dee91c4f99a666
Merge: 24e44913aa74 8c0993621c3e
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Fri Jul 19 17:13:56 2019 -0700

    Merge tag 'armsoc-drivers' of git://git.kernel.org/pub/scm/linux/kernel/git/soc/soc
    
    Pull ARM SoC-related driver updates from Olof Johansson:
     "Various driver updates for platforms and a couple of the small driver
      subsystems we merge through our tree:
    
       - A driver for SCU (system control) on NXP i.MX8QXP
    
       - Qualcomm Always-on Subsystem messaging driver (AOSS QMP)
    
       - Qualcomm PM support for MSM8998
    
       - Support for a newer version of DRAM PHY driver for Broadcom (DPFE)
    
       - Reset controller support for Bitmain BM1880
    
       - TI SCI (System Control Interface) support for CPU control on AM654
         processors
    
       - More TI sysc refactoring and rework"
    
    * tag 'armsoc-drivers' of git://git.kernel.org/pub/scm/linux/kernel/git/soc/soc: (84 commits)
      reset: remove redundant null check on pointer dev
      soc: rockchip: work around clang warning
      dt-bindings: reset: imx7: Fix the spelling of 'indices'
      soc: imx: Add i.MX8MN SoC driver support
      soc: aspeed: lpc-ctrl: Fix probe error handling
      soc: qcom: geni: Add support for ACPI
      firmware: ti_sci: Fix gcc unused-but-set-variable warning
      firmware: ti_sci: Use the correct style for SPDX License Identifier
      soc: imx8: Use existing of_root directly
      soc: imx8: Fix potential kernel dump in error path
      firmware/psci: psci_checker: Park kthreads before stopping them
      memory: move jedec_ddr.h from include/memory to drivers/memory/
      memory: move jedec_ddr_data.c from lib/ to drivers/memory/
      MAINTAINERS: Remove myself as qcom maintainer
      soc: aspeed: lpc-ctrl: make parameter optional
      soc: qcom: apr: Don't use reg for domain id
      soc: qcom: fix QCOM_AOSS_QMP dependency and build errors
      memory: tegra: Fix -Wunused-const-variable
      firmware: tegra: Early resume BPMP
      soc/tegra: Select pinctrl for Tegra194
      ...

commit d2912cb15bdda8ba4a5dd73396ad62641af2f520
Author: Thomas Gleixner <tglx@linutronix.de>
Date:   Tue Jun 4 10:11:33 2019 +0200

    treewide: Replace GPLv2 boilerplate/reference with SPDX - rule 500
    
    Based on 2 normalized pattern(s):
    
      this program is free software you can redistribute it and or modify
      it under the terms of the gnu general public license version 2 as
      published by the free software foundation
    
      this program is free software you can redistribute it and or modify
      it under the terms of the gnu general public license version 2 as
      published by the free software foundation #
    
    extracted by the scancode license scanner the SPDX license identifier
    
      GPL-2.0-only
    
    has been chosen to replace the boilerplate/reference in 4122 file(s).
    
    Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
    Reviewed-by: Enrico Weigelt <info@metux.net>
    Reviewed-by: Kate Stewart <kstewart@linuxfoundation.org>
    Reviewed-by: Allison Randal <allison@lohutok.net>
    Cc: linux-spdx@vger.kernel.org
    Link: https://lkml.kernel.org/r/20190604081206.933168790@linutronix.de
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index a2ecc5e69abb..b0f8c9a70c68 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -1,11 +1,8 @@
+// SPDX-License-Identifier: GPL-2.0-only
 /*
  * Legacy platform_data quirks
  *
  * Copyright (C) 2013 Texas Instruments
- *
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License version 2 as
- * published by the Free Software Foundation.
  */
 #include <linux/clk.h>
 #include <linux/davinci_emac.h>

commit 2b2f7def058a5386838ef4dba70a860285f79e66
Author: Tony Lindgren <tony@atomide.com>
Date:   Mon May 27 04:51:53 2019 -0700

    bus: ti-sysc: Add support for missing clockdomain handling
    
    We need to let ti-sysc driver manage clockdomain autoidle for the
    duration of of reset, enable and idle. And we need to do it before we
    enable the clock and after we disable it. Currently we are still
    relying on platform callbacks indirectly managing clockdomain autoidle.
    But I noticed that for device tree only probed drivers it now happens
    only after we enabling the clocks and before we disable the clocks,
    while it should be the other way around. So far I have not noticed
    any issues with this though.
    
    Let's add new ti_sysc_clkdm_deny_idle() and ti_sysc_clkdm_allow_idle()
    functions for ti-sysc driver to use to manage clockdomains directly via
    platform data callbacks. Note that we can implement the clockdomain
    functions in pdata-quirks.c as for probing devices without "ti,hwmods"
    custom property we don't need to use the other platform data callbacks.
    
    Let's do this in one patch as there's is still an unlikely chance we
    may need to apply this as a fix for v5.2 for dropping legacy platform
    data for some devices. We also do have the option of adding back the
    platform data if needed in case of trouble.
    
    Tested-by: Keerthy <j-keerthy@ti.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index a2ecc5e69abb..b09cc4e8d240 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -29,6 +29,7 @@
 #include <linux/platform_data/wkup_m3.h>
 #include <linux/platform_data/asoc-ti-mcbsp.h>
 
+#include "clockdomain.h"
 #include "common.h"
 #include "common-board-devices.h"
 #include "control.h"
@@ -463,6 +464,62 @@ static void __init dra7x_evm_mmc_quirk(void)
 }
 #endif
 
+static struct clockdomain *ti_sysc_find_one_clockdomain(struct clk *clk)
+{
+	struct clockdomain *clkdm = NULL;
+	struct clk_hw_omap *hwclk;
+
+	hwclk = to_clk_hw_omap(__clk_get_hw(clk));
+	if (hwclk && hwclk->clkdm_name)
+		clkdm = clkdm_lookup(hwclk->clkdm_name);
+
+	return clkdm;
+}
+
+/**
+ * ti_sysc_clkdm_init - find clockdomain based on clock
+ * @fck: device functional clock
+ * @ick: device interface clock
+ * @dev: struct device
+ *
+ * Populate clockdomain based on clock. It is needed for
+ * clkdm_deny_idle() and clkdm_allow_idle() for blocking clockdomain
+ * clockdomain idle during reset, enable and idle.
+ *
+ * Note that we assume interconnect driver manages the clocks
+ * and do not need to populate oh->_clk for dynamically
+ * allocated modules.
+ */
+static int ti_sysc_clkdm_init(struct device *dev,
+			      struct clk *fck, struct clk *ick,
+			      struct ti_sysc_cookie *cookie)
+{
+	if (fck)
+		cookie->clkdm = ti_sysc_find_one_clockdomain(fck);
+	if (cookie->clkdm)
+		return 0;
+	if (ick)
+		cookie->clkdm = ti_sysc_find_one_clockdomain(ick);
+	if (cookie->clkdm)
+		return 0;
+
+	return -ENODEV;
+}
+
+static void ti_sysc_clkdm_deny_idle(struct device *dev,
+				    const struct ti_sysc_cookie *cookie)
+{
+	if (cookie->clkdm)
+		clkdm_deny_idle(cookie->clkdm);
+}
+
+static void ti_sysc_clkdm_allow_idle(struct device *dev,
+				     const struct ti_sysc_cookie *cookie)
+{
+	if (cookie->clkdm)
+		clkdm_allow_idle(cookie->clkdm);
+}
+
 static int ti_sysc_enable_module(struct device *dev,
 				 const struct ti_sysc_cookie *cookie)
 {
@@ -494,6 +551,9 @@ static struct of_dev_auxdata omap_auxdata_lookup[];
 
 static struct ti_sysc_platform_data ti_sysc_pdata = {
 	.auxdata = omap_auxdata_lookup,
+	.init_clockdomain = ti_sysc_clkdm_init,
+	.clkdm_deny_idle = ti_sysc_clkdm_deny_idle,
+	.clkdm_allow_idle = ti_sysc_clkdm_allow_idle,
 	.init_module = omap_hwmod_init_module,
 	.enable_module = ti_sysc_enable_module,
 	.idle_module = ti_sysc_idle_module,

commit 01dc79cd6fe7d25b0eba84009634f5435cbdb4e6
Author: Linus Walleij <linus.walleij@linaro.org>
Date:   Tue Jan 29 11:31:53 2019 +0100

    regulator: fixed/gpio: Pull inversion/OD into gpiolib
    
    This pushes the handling of inversion semantics and open drain
    settings to the GPIO descriptor and gpiolib. All affected board
    files are also augmented.
    
    This is especially nice since we don't have to have any
    confusing flags passed around to the left and right littering
    the fixed and GPIO regulator drivers and the regulator core.
    It is all just very straight-forward: the core asks the GPIO
    line to be asserted or deasserted and gpiolib deals with the
    rest depending on how the platform is configured: if the line
    is active low, it deals with that, if the line is open drain,
    it deals with that too.
    
    Cc: Alexander Shiyan <shc_work@mail.ru> # i.MX boards user
    Cc: Haojian Zhuang <haojian.zhuang@gmail.com> # MMP2 maintainer
    Cc: Aaro Koskinen <aaro.koskinen@iki.fi> # OMAP1 maintainer
    Cc: Tony Lindgren <tony@atomide.com> # OMAP1,2,3 maintainer
    Cc: Mike Rapoport <rppt@linux.vnet.ibm.com> # EM-X270 maintainer
    Cc: Robert Jarzmik <robert.jarzmik@free.fr> # EZX maintainer
    Cc: Philipp Zabel <philipp.zabel@gmail.com> # Magician maintainer
    Cc: Petr Cvek <petr.cvek@tul.cz> # Magician
    Cc: Robert Jarzmik <robert.jarzmik@free.fr> # PXA
    Cc: Paul Parsons <lost.distance@yahoo.com> # hx4700
    Cc: Daniel Mack <zonque@gmail.com> # Raumfeld maintainer
    Cc: Marc Zyngier <marc.zyngier@arm.com> # Zeus maintainer
    Cc: Geert Uytterhoeven <geert+renesas@glider.be> # SuperH pinctrl/GPIO maintainer
    Cc: Russell King <rmk+kernel@armlinux.org.uk> # SA1100
    Tested-by: Marek Szyprowski <m.szyprowski@samsung.com>
    Tested-by: Janusz Krzysztofik <jmkrzyszt@gmail.com> #OMAP1 Amstrad Delta
    Signed-off-by: Linus Walleij <linus.walleij@linaro.org>
    Signed-off-by: Mark Brown <broonie@kernel.org>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 8a5b6ed4ec36..a2ecc5e69abb 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -330,7 +330,6 @@ static struct fixed_voltage_config pandora_vwlan = {
 	.supply_name		= "vwlan",
 	.microvolts		= 1800000, /* 1.8V */
 	.startup_delay		= 50000, /* 50ms */
-	.enable_high		= 1,
 	.init_data		= &pandora_vmmc3,
 };
 

commit 558eb0bfb271323cfd9f864f34d3253a65f352dd
Author: Peter Ujfalusi <peter.ujfalusi@ti.com>
Date:   Mon Dec 17 14:21:37 2018 +0200

    ARM: OMAP2: Update for new MCBSP Kconfig option
    
    The MCBSP config option has been changed.
    
    Signed-off-by: Peter Ujfalusi <peter.ujfalusi@ti.com>
    Acked-by: Tony Lindgren <tony@atomide.com>
    Signed-off-by: Mark Brown <broonie@kernel.org>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 9fec5f84bf77..8a5b6ed4ec36 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -524,7 +524,7 @@ void omap_auxdata_legacy_init(struct device *dev)
 	dev->platform_data = &twl_gpio_auxdata;
 }
 
-#if IS_ENABLED(CONFIG_SND_OMAP_SOC_MCBSP)
+#if IS_ENABLED(CONFIG_SND_SOC_OMAP_MCBSP)
 static struct omap_mcbsp_platform_data mcbsp_pdata;
 static void __init omap3_mcbsp_init(void)
 {
@@ -572,7 +572,7 @@ static struct of_dev_auxdata omap_auxdata_lookup[] = {
 	OF_DEV_AUXDATA("ti,am3517-emac", 0x5c000000, "davinci_emac.0",
 		       &am35xx_emac_pdata),
 	/* McBSP modules with sidetone core */
-#if IS_ENABLED(CONFIG_SND_OMAP_SOC_MCBSP)
+#if IS_ENABLED(CONFIG_SND_SOC_OMAP_MCBSP)
 	OF_DEV_AUXDATA("ti,omap3-mcbsp", 0x49022000, "49022000.mcbsp", &mcbsp_pdata),
 	OF_DEV_AUXDATA("ti,omap3-mcbsp", 0x49024000, "49024000.mcbsp", &mcbsp_pdata),
 #endif

commit 1650ac53066577a5e83fe3e9d992c9311597ff8c
Merge: ca9eb48fe01f fd82cc3020a0
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Tue Oct 23 08:36:15 2018 +0100

    Merge tag 'mmc-v4.20' of git://git.kernel.org/pub/scm/linux/kernel/git/ulfh/mmc
    
    Pull MMC updates from Ulf Hansson:
     "MMC core:
       - Introduce a host helper function to share re-tuning progress
    
      MMC host:
       - sdhci: Add support for v4 host mode
       - sdhci-of-arasan: Add Support for AM654 MMC and PHY
       - sdhci-sprd: Add support for Spreadtrum's host controller
       - sdhci-tegra: Add support for HS400 enhanced strobe
       - sdhci-tegra: Enable UHS/HS200 modes for Tegra186/210
       - sdhci-tegra: Add support for HS400 delay line calibration
       - sdhci-tegra: Add support for pad calibration
       - sdhci-of-dwcmshc: Address 128MB DMA boundary limitation
       - sdhci-of-esdhc: Add support for tuning erratum A008171
       - sdhci-iproc: Add ACPI support
       - mediatek: Add support for MT8183
       - mediatek: Improve the support for tuning
       - mediatek: Add bus clock control for MT2712
       - jz4740: Add support for the JZ4725B
       - mmci: Add support for the stm32 sdmmc variant
       - mmci: Add support for an optional reset control
       - mmci: Add some new variant specific properties/callbacks
       - mmci: Re-structure DMA code to prepare for new variants
       - renesas_sdhi: Add support for r8a77470, r8a7744 and r8a774a1
       - renesas_sdhi_internal_dmac: Whitelist r8a77970 and r8a774a1
       - tmio/uniphier-sd: Add new UniPhier SD/eMMC controller driver
       - tmio/renesas_sdhi: Deal properly with SCC detection during re-tune
       - tmio/renesas_sdhi: Refactor/consolidate clock management
       - omap_hsmmc: Drop cover detection and some unused platform data
       - dw_mmc-exynos: Enable tuning for more speed modes
       - sunxi: Clarify the new timing mode and enable it for the A64 controller
       - various: Convert to slot GPIO descriptors"
    
    * tag 'mmc-v4.20' of git://git.kernel.org/pub/scm/linux/kernel/git/ulfh/mmc: (129 commits)
      mmc: mediatek: drop too much code of tuning method
      mmc: mediatek: add MT8183 MMC driver support
      mmc: mediatek: tune CMD/DATA together
      mmc: mediatek: fix cannot receive new request when msdc_cmd_is_ready fail
      mmc: mediatek: fill the actual clock for mmc debugfs
      mmc: dt-bindings: add support for MT8183 SoC
      mmc: uniphier-sd: avoid using broken DMA RX channel
      mmc: uniphier-sd: fix DMA disabling
      mmc: tmio: simplify the DMA mode test
      mmc: tmio: remove TMIO_MMC_HAVE_HIGH_REG flag
      mmc: tmio: move MFD variant reset to a platform hook
      mmc: renesas_sdhi: Add r8a77470 SDHI1 support
      dt-bindings: mmc: renesas_sdhi: Add r8a77470 support
      mmc: mmci: add stm32 sdmmc variant
      dt-bindings: mmci: add stm32 sdmmc variant
      mmc: mmci: add stm32 sdmmc registers
      mmc: mmci: add clock divider for stm32 sdmmc
      mmc: mmci: add optional reset property
      dt-bindings: mmci: add optional reset property
      mmc: mmci: add variant property to not read datacnt
      ...

commit e63201f19438372fcb45977d8e14c6ab5807d55b
Author: Linus Walleij <linus.walleij@linaro.org>
Date:   Mon Sep 24 13:30:51 2018 +0200

    mmc: omap_hsmmc: Delete platform data GPIO CD and WP
    
    The OMAP HSMMC driver has some elaborate and hairy handling for
    passing GPIO card detect and write protect lines from a boardfile
    into the driver: the machine defines a struct omap2_hsmmc_info
    that is copied into struct omap_hsmmc_platform_data by
    omap_hsmmc_pdata_init() in arch/arm/mach-omap2/hsmmc.c.
    
    However the .gpio_cd and .gpio_wp fields are not copied from
    omap2_hsmmc_info to omap_hsmmc_platform_data by
    omap_hsmmc_pdata_init() so they remain unused. The only platform
    defining omap2_hsmmc_info also define both to -1, unused.
    
    It turn out there are no boardfiles passing any valid GPIO
    lines into the OMAP HSMMC driver at all. And since we are not
    going to add any more OMAP2 boardfiles, we can delete this
    card detect and write protect handling altogether.
    
    This seems to also fix a bug: the card detect callback
    mmc_gpio_get_cd() in the slot GPIO core needs to be called
    by drivers utilizing slot GPIO. It appears the the boardfile
    quirks were not doing this right, so this would only get
    called for boardfiles, i.e. since no boardfile was using it,
    never.
    
    Just assign mmc_gpio_get_cd() unconditionally to omap_hsmmc_ops
    .get_cd() so card detects from the device tree works.
    AFAICT card detect with GPIO lines assigned from
    mmc_of_parse() are not working at the moment, but that is
    no regression since it probably never worked.
    
    Cc: Tony Lindgren <tony@atomide.com>
    Cc: linux-omap@vger.kernel.org
    Signed-off-by: Linus Walleij <linus.walleij@linaro.org>
    Acked-by: Tony Lindgren <tony@atomide.com>
    Signed-off-by: Ulf Hansson <ulf.hansson@linaro.org>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 7f02743edbe4..fe7c1fdb51d8 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -363,8 +363,6 @@ static struct omap2_hsmmc_info pandora_mmc3[] = {
 	{
 		.mmc		= 3,
 		.caps		= MMC_CAP_4_BIT_DATA | MMC_CAP_POWER_OFF_CARD,
-		.gpio_cd	= -EINVAL,
-		.gpio_wp	= -EINVAL,
 		.init_card	= pandora_wl1251_init_card,
 	},
 	{}	/* Terminator */

commit efdfeb079cc3b6c7d9c19959c5ed65ce2510dd1d
Author: Linus Walleij <linus.walleij@linaro.org>
Date:   Thu Sep 6 14:24:36 2018 +0200

    regulator: fixed: Convert to use GPIO descriptor only
    
    As we augmented the regulator core to accept a GPIO descriptor instead
    of a GPIO number, we can augment the fixed GPIO regulator to look up
    and pass that descriptor directly from device tree or board GPIO
    descriptor look up tables.
    
    Some boards just auto-enumerate their fixed regulator platform devices
    and I have assumed they get names like "fixed-regulator.0" but it's
    pretty hard to guess this. I need some testing from board maintainers to
    be sure. Other boards are straight forward, using just plain
    "fixed-regulator" (ID -1) or "fixed-regulator.1" hammering down the
    device ID.
    
    It seems the da9055 and da9211 has never got around to actually passing
    any enable gpio into its platform data (not the in-tree code anyway) so we
    can just decide to simply pass a descriptor instead.
    
    The fixed GPIO-controlled regulator in mach-pxa/ezx.c was confusingly named
    "*_dummy_supply_device" while it is a very real device backed by a GPIO
    line. There is nothing dummy about it at all, so I renamed it with the
    infix *_regulator_* as part of this patch set.
    
    Intel MID portions tested by Andy.
    
    Tested-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com> # Check the x86 BCM stuff
    Acked-by: Tony Lindgren <tony@atomide.com> # OMAP1,2,3 maintainer
    Signed-off-by: Linus Walleij <linus.walleij@linaro.org>
    Reviewed-by: Janusz Krzysztofik <jmkrzyszt@gmail.com>
    Reviewed-by: Mike Rapoport <rppt@linux.vnet.ibm.com>
    Signed-off-by: Mark Brown <broonie@kernel.org>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 7f02743edbe4..d0f7a7cc70cb 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -10,6 +10,7 @@
 #include <linux/clk.h>
 #include <linux/davinci_emac.h>
 #include <linux/gpio.h>
+#include <linux/gpio/machine.h>
 #include <linux/init.h>
 #include <linux/kernel.h>
 #include <linux/of_platform.h>
@@ -328,7 +329,6 @@ static struct regulator_init_data pandora_vmmc3 = {
 static struct fixed_voltage_config pandora_vwlan = {
 	.supply_name		= "vwlan",
 	.microvolts		= 1800000, /* 1.8V */
-	.gpio			= PANDORA_WIFI_NRESET_GPIO,
 	.startup_delay		= 50000, /* 50ms */
 	.enable_high		= 1,
 	.init_data		= &pandora_vmmc3,
@@ -342,6 +342,19 @@ static struct platform_device pandora_vwlan_device = {
 	},
 };
 
+static struct gpiod_lookup_table pandora_vwlan_gpiod_table = {
+	.dev_id = "reg-fixed-voltage.1",
+	.table = {
+		/*
+		 * As this is a low GPIO number it should be at the first
+		 * GPIO bank.
+		 */
+		GPIO_LOOKUP("gpio-0-31", PANDORA_WIFI_NRESET_GPIO,
+			    NULL, GPIO_ACTIVE_HIGH),
+		{ },
+	},
+};
+
 static void pandora_wl1251_init_card(struct mmc_card *card)
 {
 	/*
@@ -403,6 +416,7 @@ static void __init pandora_wl1251_init(void)
 static void __init omap3_pandora_legacy_init(void)
 {
 	platform_device_register(&pandora_backlight);
+	gpiod_add_lookup_table(&pandora_vwlan_gpiod_table);
 	platform_device_register(&pandora_vwlan_device);
 	omap_hsmmc_init(pandora_mmc3);
 	omap_hsmmc_late_init(pandora_mmc3);

commit 44773ba170a6f969620221a6d87d03feae5e464f
Author: Tony Lindgren <tony@atomide.com>
Date:   Mon Apr 16 10:22:01 2018 -0700

    ARM: OMAP2+: Drop unused pm-noop
    
    Looks like these functions don't do anything in the mainline kernel so
    we can just drop it.
    
    Note that we must now also remove ir-rx51 pdata as it relies on the dummy
    platform data that does not do anything. And ir-rx51 is calling a pdata
    callback that doesn't do anything without checking if it exists first.
    
    For configuring device specific minimal latencies, the interface to use
    is pm_qos_add_request(). For an example, see what was done in commit
    9834ffd1ecc3 ("ASoC: omap-mcbsp: Add PM QoS support for McBSP to prevent
    glitches"). I've added some comments to ir-rx51 so people using it can
    add pm_qos support and test it.
    
    Cc: Ivaylo Dimitrov <ivo.g.dimitrov.75@gmail.com>
    Cc: Kevin Hilman <khilman@kernel.org>
    Cc: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
    Cc: Tomi Valkeinen <tomi.valkeinen@ti.com>
    Acked-by: Mauro Carvalho Chehab <mchehab+samsung@kernel.org>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 6459816c2879..7f02743edbe4 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -26,14 +26,12 @@
 #include <linux/platform_data/iommu-omap.h>
 #include <linux/platform_data/ti-sysc.h>
 #include <linux/platform_data/wkup_m3.h>
-#include <linux/platform_data/media/ir-rx51.h>
 #include <linux/platform_data/asoc-ti-mcbsp.h>
 
 #include "common.h"
 #include "common-board-devices.h"
 #include "control.h"
 #include "omap_device.h"
-#include "omap-pm.h"
 #include "omap-secure.h"
 #include "soc.h"
 #include "hsmmc.h"
@@ -514,18 +512,6 @@ void omap_auxdata_legacy_init(struct device *dev)
 	dev->platform_data = &twl_gpio_auxdata;
 }
 
-static struct ir_rx51_platform_data __maybe_unused rx51_ir_data = {
-	.set_max_mpu_wakeup_lat = omap_pm_set_max_mpu_wakeup_lat,
-};
-
-static struct platform_device __maybe_unused rx51_ir_device = {
-	.name           = "ir_rx51",
-	.id             = -1,
-	.dev            = {
-		.platform_data = &rx51_ir_data,
-	},
-};
-
 #if IS_ENABLED(CONFIG_SND_OMAP_SOC_MCBSP)
 static struct omap_mcbsp_platform_data mcbsp_pdata;
 static void __init omap3_mcbsp_init(void)
@@ -569,7 +555,6 @@ static struct of_dev_auxdata omap_auxdata_lookup[] = {
 		       "480c9000.smartreflex", &omap_sr_pdata[OMAP_SR_MPU]),
 	OF_DEV_AUXDATA("ti,omap3-hsmmc", 0x4809c000, "4809c000.mmc", &mmc_pdata[0]),
 	OF_DEV_AUXDATA("ti,omap3-hsmmc", 0x480b4000, "480b4000.mmc", &mmc_pdata[1]),
-	OF_DEV_AUXDATA("nokia,n900-ir", 0, "n900-ir", &rx51_ir_data),
 	/* Only on am3517 */
 	OF_DEV_AUXDATA("ti,davinci_mdio", 0x5c030000, "davinci_mdio.0", NULL),
 	OF_DEV_AUXDATA("ti,am3517-emac", 0x5c000000, "davinci_emac.0",

commit 3bf5c70d06ce1d91cc73cee68bc6c4f850192cb0
Merge: 18b4788badea 695eea3d2c7f
Author: Arnd Bergmann <arnd@arndb.de>
Date:   Wed Mar 7 16:26:43 2018 +0100

    Merge tag 'omap-for-v4.17/ti-sysc-signed' of ssh://gitolite.kernel.org/pub/scm/linux/kernel/git/tmlind/linux-omap into next/soc
    
    Pull "Driver changes for ti-sysc for v4.17" from Tony Lindgren:
    
    This series of changes enables the use device tree based sysconfig
    data for ti-sysc driver. As we already have SmartReflex data configured,
    we use that as the first driver to enable. To do that in a way where
    SmartReflex is not probed twice, we need to prepare the SmartReflex
    driver before flipping dts data on for it in the last patch of the
    series.
    
    To avoid regressions, we are checking the passed dts data against
    existing platform data since we still have it available. Then after the
    dts files are converted, we can simply drop the related platform data
    at some point in the future.
    
    * tag 'omap-for-v4.17/ti-sysc-signed' of ssh://gitolite.kernel.org/pub/scm/linux/kernel/git/tmlind/linux-omap:
      ARM: OMAP2+: Enable ti-sysc to use device tree data for smartreflex
      PM / AVS: SmartReflex: Prepare to use device tree based probing
      ARM: OMAP2+: Try to parse earlycon from parent too
      ARM: OMAP2+: Add checks for device tree based sysconfig data
      ARM: OMAP2+: Add functions to allocate module data from device tree
      bus: ti-sysc: Handle some devices in omap_device compatible way
      bus: ti-sysc: Add support for platform data callbacks
      bus: ti-sysc: Remove unnecessary debugging statements
      bus: ti-sysc: Improve handling for no-reset-on-init and no-idle-on-init
      bus: ti-sysc: Handle stdout-path for debug console
      bus: ti-sysc: Add suspend and resume handling
      bus: ti-sysc: Add fck clock alias for children with notifier_block
      ARM: OMAP2+: Prepare to pass auxdata for smartreflex

commit 695eea3d2c7f3e70e852226c338d464a6251c70b
Author: Tony Lindgren <tony@atomide.com>
Date:   Thu Feb 22 14:05:31 2018 -0800

    ARM: OMAP2+: Enable ti-sysc to use device tree data for smartreflex
    
    Let's enable ti-sysc probing of child devices. So far we have only used
    ti-sysc to probe interconnect target modules to idle them for cases where
    the SoC does not have any child devices configured for the module, such
    as smartreflex on dra7.
    
    As we have smartreflex driver configured in the device tree for some SoCs,
    we need to flip things on with a single patch to prevent both omap_device
    and ti-sysc to probe smartreflex. So let's stop probing smartreflex with
    omap_device and probe it with ti-sysc by enabling passing the auxdata.
    
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index eea82c31ee77..67e2fcdfe3f0 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -487,6 +487,7 @@ static struct of_dev_auxdata omap_auxdata_lookup[];
 
 static struct ti_sysc_platform_data ti_sysc_pdata = {
 	.auxdata = omap_auxdata_lookup,
+	.init_module = omap_hwmod_init_module,
 	.enable_module = ti_sysc_enable_module,
 	.idle_module = ti_sysc_idle_module,
 	.shutdown_module = ti_sysc_shutdown_module,

commit ef70b0bdeaf893dd6d9c3a8d05d9b65d395506c0
Author: Tony Lindgren <tony@atomide.com>
Date:   Thu Feb 22 14:00:25 2018 -0800

    bus: ti-sysc: Add support for platform data callbacks
    
    We want to pass the device tree configuration for interconnect target
    modules from ti-sysc driver to the existing platform hwmod code.
    
    This allows us to first validate the dts data against the existing
    platform data before we start dropping the platform data in favor of
    device tree data.
    
    To do this, let's add platform data callbacks for PM runtime functions
    to call for the interconnect target modules if platform data is
    available.
    
    Note that as ti-sysc driver can rebind, omap_auxdata_lookup and related
    functions can no longer be __init.
    
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 1cca66ad68b5..eea82c31ee77 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -24,6 +24,7 @@
 #include <linux/platform_data/pinctrl-single.h>
 #include <linux/platform_data/hsmmc-omap.h>
 #include <linux/platform_data/iommu-omap.h>
+#include <linux/platform_data/ti-sysc.h>
 #include <linux/platform_data/wkup_m3.h>
 #include <linux/platform_data/pwm_omap_dmtimer.h>
 #include <linux/platform_data/media/ir-rx51.h>
@@ -455,6 +456,42 @@ static void __init dra7x_evm_mmc_quirk(void)
 }
 #endif
 
+static int ti_sysc_enable_module(struct device *dev,
+				 const struct ti_sysc_cookie *cookie)
+{
+	if (!cookie->data)
+		return -EINVAL;
+
+	return omap_hwmod_enable(cookie->data);
+}
+
+static int ti_sysc_idle_module(struct device *dev,
+			       const struct ti_sysc_cookie *cookie)
+{
+	if (!cookie->data)
+		return -EINVAL;
+
+	return omap_hwmod_idle(cookie->data);
+}
+
+static int ti_sysc_shutdown_module(struct device *dev,
+				   const struct ti_sysc_cookie *cookie)
+{
+	if (!cookie->data)
+		return -EINVAL;
+
+	return omap_hwmod_shutdown(cookie->data);
+}
+
+static struct of_dev_auxdata omap_auxdata_lookup[];
+
+static struct ti_sysc_platform_data ti_sysc_pdata = {
+	.auxdata = omap_auxdata_lookup,
+	.enable_module = ti_sysc_enable_module,
+	.idle_module = ti_sysc_idle_module,
+	.shutdown_module = ti_sysc_shutdown_module,
+};
+
 static struct pcs_pdata pcs_pdata;
 
 void omap_pcs_legacy_init(int irq, void (*rearm)(void))
@@ -545,7 +582,7 @@ static struct pdata_init auxdata_quirks[] __initdata = {
 
 struct omap_sr_data __maybe_unused omap_sr_pdata[OMAP_SR_NR];
 
-static struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
+static struct of_dev_auxdata omap_auxdata_lookup[] = {
 #ifdef CONFIG_MACH_NOKIA_N8X0
 	OF_DEV_AUXDATA("ti,omap2420-mmc", 0x4809c000, "mmci-omap.0", NULL),
 	OF_DEV_AUXDATA("menelaus", 0x72, "1-0072", &n8x0_menelaus_platform_data),
@@ -603,6 +640,7 @@ static struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
 		       &dra7_hsmmc_data_mmc3),
 #endif
 	/* Common auxdata */
+	OF_DEV_AUXDATA("ti,sysc", 0, NULL, &ti_sysc_pdata),
 	OF_DEV_AUXDATA("pinctrl-single", 0, NULL, &pcs_pdata),
 	{ /* sentinel */ },
 };

commit d060b40523dcd91428c7fb2aaa307de37887484a
Author: Tony Lindgren <tony@atomide.com>
Date:   Thu Feb 22 13:57:30 2018 -0800

    ARM: OMAP2+: Prepare to pass auxdata for smartreflex
    
    We are still initializing smartreflex with platform data using
    omap_device_build(). We can instead pass the platform data in
    with auxdata in pdata-quirks.c and make the driver use that
    in later patches.
    
    Note that we cannot enable the auxdata use yet, this is done
    in the last patch of the series.
    
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 6b433fce65a5..1cca66ad68b5 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -17,6 +17,7 @@
 #include <linux/wl12xx.h>
 #include <linux/mmc/card.h>
 #include <linux/mmc/host.h>
+#include <linux/power/smartreflex.h>
 #include <linux/regulator/machine.h>
 #include <linux/regulator/fixed.h>
 
@@ -542,6 +543,8 @@ static struct pdata_init auxdata_quirks[] __initdata = {
 	{ /* sentinel */ },
 };
 
+struct omap_sr_data __maybe_unused omap_sr_pdata[OMAP_SR_NR];
+
 static struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
 #ifdef CONFIG_MACH_NOKIA_N8X0
 	OF_DEV_AUXDATA("ti,omap2420-mmc", 0x4809c000, "mmci-omap.0", NULL),
@@ -551,6 +554,10 @@ static struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
 #ifdef CONFIG_ARCH_OMAP3
 	OF_DEV_AUXDATA("ti,omap2-iommu", 0x5d000000, "5d000000.mmu",
 		       &omap3_iommu_pdata),
+	OF_DEV_AUXDATA("ti,omap3-smartreflex-core", 0x480cb000,
+		       "480cb000.smartreflex", &omap_sr_pdata[OMAP_SR_CORE]),
+	OF_DEV_AUXDATA("ti,omap3-smartreflex-mpu-iva", 0x480c9000,
+		       "480c9000.smartreflex", &omap_sr_pdata[OMAP_SR_MPU]),
 	OF_DEV_AUXDATA("ti,omap3-hsmmc", 0x4809c000, "4809c000.mmc", &mmc_pdata[0]),
 	OF_DEV_AUXDATA("ti,omap3-hsmmc", 0x480b4000, "480b4000.mmc", &mmc_pdata[1]),
 	OF_DEV_AUXDATA("nokia,n900-ir", 0, "n900-ir", &rx51_ir_data),
@@ -580,6 +587,12 @@ static struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
 		       &omap4_iommu_pdata),
 	OF_DEV_AUXDATA("ti,omap4-iommu", 0x55082000, "55082000.mmu",
 		       &omap4_iommu_pdata),
+	OF_DEV_AUXDATA("ti,omap4-smartreflex-iva", 0x4a0db000,
+		       "4a0db000.smartreflex", &omap_sr_pdata[OMAP_SR_IVA]),
+	OF_DEV_AUXDATA("ti,omap4-smartreflex-core", 0x4a0dd000,
+		       "4a0dd000.smartreflex", &omap_sr_pdata[OMAP_SR_CORE]),
+	OF_DEV_AUXDATA("ti,omap4-smartreflex-mpu", 0x4a0d9000,
+		       "4a0d9000.smartreflex", &omap_sr_pdata[OMAP_SR_MPU]),
 #endif
 #ifdef CONFIG_SOC_DRA7XX
 	OF_DEV_AUXDATA("ti,dra7-hsmmc", 0x4809c000, "4809c000.mmc",

commit ac30751df953c298ee86e4f97a61347544833de8
Author: Keerthy <j-keerthy@ti.com>
Date:   Thu Feb 15 11:31:51 2018 +0530

    ARM: OMAP: pdata-quirks: Remove unused timer pdata
    
    Remove unused timer pdata.
    
    Signed-off-by: Keerthy <j-keerthy@ti.com>
    Reviewed-by: Sebastian Reichel <sebastian.reichel@collabora.co.uk>
    Tested-by: Ladislav Michl <ladis@linux-mips.org>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 2455020db3dd..e7d7fc7ddaa2 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -24,10 +24,8 @@
 #include <linux/platform_data/hsmmc-omap.h>
 #include <linux/platform_data/iommu-omap.h>
 #include <linux/platform_data/wkup_m3.h>
-#include <linux/platform_data/pwm_omap_dmtimer.h>
 #include <linux/platform_data/media/ir-rx51.h>
 #include <linux/platform_data/asoc-ti-mcbsp.h>
-#include <clocksource/timer-ti-dm.h>
 
 #include "common.h"
 #include "common-board-devices.h"
@@ -477,33 +475,6 @@ void omap_auxdata_legacy_init(struct device *dev)
 	dev->platform_data = &twl_gpio_auxdata;
 }
 
-/* Dual mode timer PWM callbacks platdata */
-#if IS_ENABLED(CONFIG_OMAP_DM_TIMER)
-static struct pwm_omap_dmtimer_pdata pwm_dmtimer_pdata = {
-	.request_by_node = omap_dm_timer_request_by_node,
-	.request_specific = omap_dm_timer_request_specific,
-	.request = omap_dm_timer_request,
-	.set_source = omap_dm_timer_set_source,
-	.get_irq = omap_dm_timer_get_irq,
-	.set_int_enable = omap_dm_timer_set_int_enable,
-	.set_int_disable = omap_dm_timer_set_int_disable,
-	.free = omap_dm_timer_free,
-	.enable = omap_dm_timer_enable,
-	.disable = omap_dm_timer_disable,
-	.get_fclk = omap_dm_timer_get_fclk,
-	.start = omap_dm_timer_start,
-	.stop = omap_dm_timer_stop,
-	.set_load = omap_dm_timer_set_load,
-	.set_match = omap_dm_timer_set_match,
-	.set_pwm = omap_dm_timer_set_pwm,
-	.set_prescaler = omap_dm_timer_set_prescaler,
-	.read_counter = omap_dm_timer_read_counter,
-	.write_counter = omap_dm_timer_write_counter,
-	.read_status = omap_dm_timer_read_status,
-	.write_status = omap_dm_timer_write_status,
-};
-#endif
-
 static struct ir_rx51_platform_data __maybe_unused rx51_ir_data = {
 	.set_max_mpu_wakeup_lat = omap_pm_set_max_mpu_wakeup_lat,
 };
@@ -572,9 +543,6 @@ static struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
 	OF_DEV_AUXDATA("ti,am4372-wkup-m3", 0x44d00000, "44d00000.wkup_m3",
 		       &wkup_m3_data),
 #endif
-#if IS_ENABLED(CONFIG_OMAP_DM_TIMER)
-	OF_DEV_AUXDATA("ti,omap-dmtimer-pwm", 0, NULL, &pwm_dmtimer_pdata),
-#endif
 #if defined(CONFIG_ARCH_OMAP4) || defined(CONFIG_SOC_OMAP5)
 	OF_DEV_AUXDATA("ti,omap4-iommu", 0x4a066000, "4a066000.mmu",
 		       &omap4_iommu_pdata),

commit 5ca467c40c2e557af5675b6a6cf0e7d326349751
Author: Keerthy <j-keerthy@ti.com>
Date:   Thu Feb 15 11:31:44 2018 +0530

    ARM: OMAP: Move dmtimer.h out of plat-omap
    
    The header file is currently under plat-omap directory
    under arch/omap. Move this out to an accessible place.
    
    No Code changes done to the header file and renamed to timer-ti-dm.h.
    
    Signed-off-by: Keerthy <j-keerthy@ti.com>
    Reviewed-by: Sebastian Reichel <sebastian.reichel@collabora.co.uk>
    Tested-by: Ladislav Michl <ladis@linux-mips.org>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 6b433fce65a5..2455020db3dd 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -27,7 +27,7 @@
 #include <linux/platform_data/pwm_omap_dmtimer.h>
 #include <linux/platform_data/media/ir-rx51.h>
 #include <linux/platform_data/asoc-ti-mcbsp.h>
-#include <plat/dmtimer.h>
+#include <clocksource/timer-ti-dm.h>
 
 #include "common.h"
 #include "common-board-devices.h"

commit fc66ce0b72046318c4c4a66e67a2362193df6de1
Author: Sekhar Nori <nsekhar@ti.com>
Date:   Thu Aug 10 09:02:37 2017 -0700

    ARM: OMAP2+: Add pdata-quirks for MMC/SD on DRA74x EVM
    
    DRA74x EVM Rev H EVM comes with revision 2.0 silicon.
    However, earlier versions of EVM can come with either
    revision 1.1 or revision 1.0 of silicon.
    
    The device-tree file is written to support rev 2.0 of
    silicon. pdata quirks are used to then override the
    settings needed for PG 1.1 silicon.
    
    PG 1.1 silicon has limitations w.r.t frequencies at
    which MMC1/2/3 can operate as well as different IOdelay
    numbers.
    
    Signed-off-by: Kishon Vijay Abraham I <kishon@ti.com>
    Signed-off-by: Sekhar Nori <nsekhar@ti.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 9700a8ef0f16..6b433fce65a5 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -434,6 +434,26 @@ static void __init omap5_uevm_legacy_init(void)
 }
 #endif
 
+#ifdef CONFIG_SOC_DRA7XX
+static struct omap_hsmmc_platform_data dra7_hsmmc_data_mmc1;
+static struct omap_hsmmc_platform_data dra7_hsmmc_data_mmc2;
+static struct omap_hsmmc_platform_data dra7_hsmmc_data_mmc3;
+
+static void __init dra7x_evm_mmc_quirk(void)
+{
+	if (omap_rev() == DRA752_REV_ES1_1 || omap_rev() == DRA752_REV_ES1_0) {
+		dra7_hsmmc_data_mmc1.version = "rev11";
+		dra7_hsmmc_data_mmc1.max_freq = 96000000;
+
+		dra7_hsmmc_data_mmc2.version = "rev11";
+		dra7_hsmmc_data_mmc2.max_freq = 48000000;
+
+		dra7_hsmmc_data_mmc3.version = "rev11";
+		dra7_hsmmc_data_mmc3.max_freq = 48000000;
+	}
+}
+#endif
+
 static struct pcs_pdata pcs_pdata;
 
 void omap_pcs_legacy_init(int irq, void (*rearm)(void))
@@ -560,6 +580,14 @@ static struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
 		       &omap4_iommu_pdata),
 	OF_DEV_AUXDATA("ti,omap4-iommu", 0x55082000, "55082000.mmu",
 		       &omap4_iommu_pdata),
+#endif
+#ifdef CONFIG_SOC_DRA7XX
+	OF_DEV_AUXDATA("ti,dra7-hsmmc", 0x4809c000, "4809c000.mmc",
+		       &dra7_hsmmc_data_mmc1),
+	OF_DEV_AUXDATA("ti,dra7-hsmmc", 0x480b4000, "480b4000.mmc",
+		       &dra7_hsmmc_data_mmc2),
+	OF_DEV_AUXDATA("ti,dra7-hsmmc", 0x480ad000, "480ad000.mmc",
+		       &dra7_hsmmc_data_mmc3),
 #endif
 	/* Common auxdata */
 	OF_DEV_AUXDATA("pinctrl-single", 0, NULL, &pcs_pdata),
@@ -589,6 +617,9 @@ static struct pdata_init pdata_quirks[] __initdata = {
 #endif
 #ifdef CONFIG_SOC_OMAP5
 	{ "ti,omap5-uevm", omap5_uevm_legacy_init, },
+#endif
+#ifdef CONFIG_SOC_DRA7XX
+	{ "ti,dra7-evm", dra7x_evm_mmc_quirk, },
 #endif
 	{ /* sentinel */ },
 };

commit af8999f672421776417977101c3e1f334414c065
Merge: 60e8d3e11645 92f3e6ebf6e4
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Thu Feb 23 15:28:04 2017 -0800

    Merge tag 'armsoc-fixes-nc' of git://git.kernel.org/pub/scm/linux/kernel/git/arm/arm-soc
    
    Pull ARM SoC non-urgent fixes from Arnd Bergmann:
     "We sometimes collect non-critical fixes that come in during the later
      part of the merge window in a branch for the next release instead, and
      this is that contents for v4.11.
    
      Most of these are OMAP fixes, dealing with OMAP36/37 detection, quirks
      and setup. There's also some fixes for Davinci and a Kconfig fix for
      SCPI to only enable on ARM{,64}"
    
    * tag 'armsoc-fixes-nc' of git://git.kernel.org/pub/scm/linux/kernel/git/arm/arm-soc:
      firmware: arm_scpi: Add hardware dependencies
      ARM: OMAP3: Fix SoC detection of OMAP36/37 Family
      ARM: OMAP5: Add HWMOD_SWSUP_SIDLE_ACT flag for UART
      ARM: dts: Fix compatible for ti81xx uarts for 8250
      ARM: dts: Fix am335x and dm814x scm syscon to probe children
      ARM: OMAP2+: Fix init for multiple quirks for the same SoC
      ARM: dts: Fix omap3 off mode pull defines
      bus: da850-mstpri: fix my e-mail address
      ARM: davinci: da850: fix da850_set_pll0rate()
      ARM: davinci: da850: coding style fix

commit ff58d005cd10fcd372787cceac547e11cf706ff6
Merge: 5ab356626f3c 9eeb0ed0f309
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Tue Feb 21 16:58:32 2017 -0800

    Merge tag 'media/v4.11-1' of git://git.kernel.org/pub/scm/linux/kernel/git/mchehab/linux-media
    
    Pull media updates from Mauro Carvalho Chehab:
    
     - new drivers:
           - i.MX6 Video Data Order Adapter's (VDOA)
           - Toshiba et8ek8 5MP sensor
           - STM DELTA multi-format video decoder V4L2 driver
           - SPI connected IR LED
           - Mediatek IR remote receiver
           - ZyDAS ZD1301 DVB USB interface driver
    
     - new RC keymaps
    
     - some very old LIRC drivers got removed from staging
    
     - RC core gained support encoding IR scan codes
    
     - DVB si2168 gained support for DVBv5 statistics
    
     - lirc_sir driver ported to rc-core and promoted from staging
    
     - other bug fixes, board additions and driver improvements
    
    * tag 'media/v4.11-1' of git://git.kernel.org/pub/scm/linux/kernel/git/mchehab/linux-media: (230 commits)
      [media] mtk-vcodec: fix build warnings without DEBUG
      [media] zd1301: fix building interface driver without demodulator
      [media] usbtv: add sharpness control
      [media] cxusb: Use a dma capable buffer also for reading
      [media] ttpci: address stringop overflow warning
      [media] dvb-usb-v2: avoid use-after-free
      [media] add Hama Hybrid DVB-T Stick support
      [media] et8ek8: Fix compiler / Coccinelle warnings
      [media] media: fix semicolon.cocci warnings
      [media] media: exynos4-is: add flags to dummy Exynos IS i2c adapter
      [media] v4l: of: check for unique lanes in data-lanes and clock-lanes
      [media] coda/imx-vdoa: constify structs
      [media] st-delta: debug: trace stream/frame information & summary
      [media] st-delta: add mjpeg support
      [media] st-delta: EOS (End Of Stream) support
      [media] st-delta: rpmsg ipc support
      [media] st-delta: add memory allocator helper functions
      [media] st-delta: STiH4xx multi-format video decoder v4l2 driver
      [media] MAINTAINERS: add st-delta driver
      [media] ARM: multi_v7_defconfig: enable STMicroelectronics DELTA Support
      ...

commit 922ee72da7c739157ed02ea04a5c100d19f67226
Author: Sean Young <sean@mess.org>
Date:   Mon Jan 30 17:58:19 2017 -0200

    [media] rx51: broken build
    
    As reported by kernel build test:
    
       In file included from arch/arm/mach-omap2/pdata-quirks.c:15:0:
    >> arch/arm/mach-omap2/pdata-quirks.c:536:49: error: 'rx51_lirc_data' undeclared here (not in a function)
         OF_DEV_AUXDATA("nokia,n900-ir", 0, "n900-ir", &rx51_lirc_data),
                                                        ^
       include/linux/of_platform.h:52:21: note: in definition of macro 'OF_DEV_AUXDATA'
           .platform_data = _pdata }
                            ^~~~~~
    
    Since "a92def1 [media] ir-rx51: port to rc-core" the build fails on
    some arm configurations.
    
    Reported-by: kbuild test robot <fengguang.wu@intel.com>
    Signed-off-by: Sean Young <sean@mess.org>
    Signed-off-by: Mauro Carvalho Chehab <mchehab@s-opensource.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 9f060748df5d..dc3b6c857938 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -533,7 +533,7 @@ static struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
 		       &omap3_iommu_pdata),
 	OF_DEV_AUXDATA("ti,omap3-hsmmc", 0x4809c000, "4809c000.mmc", &mmc_pdata[0]),
 	OF_DEV_AUXDATA("ti,omap3-hsmmc", 0x480b4000, "480b4000.mmc", &mmc_pdata[1]),
-	OF_DEV_AUXDATA("nokia,n900-ir", 0, "n900-ir", &rx51_lirc_data),
+	OF_DEV_AUXDATA("nokia,n900-ir", 0, "n900-ir", &rx51_ir_data),
 	/* Only on am3517 */
 	OF_DEV_AUXDATA("ti,davinci_mdio", 0x5c030000, "davinci_mdio.0", NULL),
 	OF_DEV_AUXDATA("ti,am3517-emac", 0x5c000000, "davinci_emac.0",

commit a92def1becf33e91fc460c7ae575aa9210ba8f40
Author: Sean Young <sean@mess.org>
Date:   Mon Dec 19 18:48:29 2016 -0200

    [media] ir-rx51: port to rc-core
    
    This driver was written using lirc since rc-core did not support
    transmitter-only hardware at that time. Now that it does, port
    this driver.
    
    Compile tested only.
    
    Signed-off-by: Sean Young <sean@mess.org>
    Cc: Timo Kokkonen <timo.t.kokkonen@iki.fi>
    Cc: Ivaylo Dimitrov <ivo.g.dimitrov.75@gmail.com>
    Signed-off-by: Mauro Carvalho Chehab <mchehab@s-opensource.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 477910a48448..9f060748df5d 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -484,15 +484,15 @@ static struct pwm_omap_dmtimer_pdata pwm_dmtimer_pdata = {
 };
 #endif
 
-static struct lirc_rx51_platform_data __maybe_unused rx51_lirc_data = {
+static struct ir_rx51_platform_data __maybe_unused rx51_ir_data = {
 	.set_max_mpu_wakeup_lat = omap_pm_set_max_mpu_wakeup_lat,
 };
 
-static struct platform_device __maybe_unused rx51_lirc_device = {
-	.name           = "lirc_rx51",
+static struct platform_device __maybe_unused rx51_ir_device = {
+	.name           = "ir_rx51",
 	.id             = -1,
 	.dev            = {
-		.platform_data = &rx51_lirc_data,
+		.platform_data = &rx51_ir_data,
 	},
 };
 

commit 6e613ebf4405fc09e2a8c16ed193b47f80a3cbed
Author: Tony Lindgren <tony@atomide.com>
Date:   Thu Jan 5 11:08:20 2017 -0800

    ARM: OMAP2+: Fix init for multiple quirks for the same SoC
    
    It's possible that there are multiple quirks that need to be initialized
    for the same SoC. Fix the issue by not returning on the first match.
    
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 477910a48448..58d87a78cb90 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -599,7 +599,6 @@ static void pdata_quirks_check(struct pdata_init *quirks)
 		if (of_machine_is_compatible(quirks->compatible)) {
 			if (quirks->fn)
 				quirks->fn();
-			break;
 		}
 		quirks++;
 	}

commit a3ac350793d90d1da631c8beeee9352387974ed5
Author: Adam Ford <aford173@gmail.com>
Date:   Tue Jan 3 11:37:48 2017 -0600

    ARM: OMAP2+: Fix WL1283 Bluetooth Baud Rate
    
    Commit 485fa1261f78 ("ARM: OMAP2+: LogicPD Torpedo + Wireless: Add Bluetooth")
    set the wrong baud rate for the UART. The Baud rate was 300,000 and it should
    be 3,000,000 for WL1283.
    
    Signed-off-by: Adam Ford <aford173@gmail.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 477910a48448..70c004794880 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -161,7 +161,7 @@ static struct ti_st_plat_data wilink7_pdata = {
 	.nshutdown_gpio = 162,
 	.dev_name = "/dev/ttyO1",
 	.flow_cntrl = 1,
-	.baud_rate = 300000,
+	.baud_rate = 3000000,
 };
 
 static struct platform_device wl128x_device = {

commit dbf828ec4c765623dfd1ff91ca9c1dccbe7a3da3
Author: Tony Lindgren <tony@atomide.com>
Date:   Thu Nov 10 15:46:13 2016 -0700

    ARM: OMAP2+: Drop legacy ads7846 init

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 05e20aaf68dd..477910a48448 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -31,7 +31,6 @@
 
 #include "common.h"
 #include "common-board-devices.h"
-#include "dss-common.h"
 #include "control.h"
 #include "omap_device.h"
 #include "omap-pm.h"

commit 43a0a98aa8da71583f84b84fd72e265c24d4c5f8
Merge: 6911a5281430 f8c6d88b2c87
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Mon Aug 1 18:36:01 2016 -0400

    Merge tag 'armsoc-drivers' of git://git.kernel.org/pub/scm/linux/kernel/git/arm/arm-soc
    
    Pull ARM SoC driver updates from Olof Johansson:
     "Driver updates for ARM SoCs.
    
      A slew of changes this release cycle.  The reset driver tree, that we
      merge through arm-soc for historical reasons, is also sizable this
      time around.
    
      Among the changes:
    
       - clps711x: Treewide changes to compatible strings, merged here for simplicity.
       - Qualcomm: SCM firmware driver cleanups, move to platform driver
       - ux500: Major cleanups, removal of old mach-specific infrastructure.
       - Atmel external bus memory driver
       - Move of brcmstb platform to the rest of bcm
       - PMC driver updates for tegra, various fixes and improvements
       - Samsung platform driver updates to support 64-bit Exynos platforms
       - Reset controller cleanups moving to devm_reset_controller_register() APIs
       - Reset controller driver for Amlogic Meson
       - Reset controller driver for Hisilicon hi6220
       - ARM SCPI power domain support"
    
    * tag 'armsoc-drivers' of git://git.kernel.org/pub/scm/linux/kernel/git/arm/arm-soc: (100 commits)
      ARM: ux500: consolidate base platform files
      ARM: ux500: move soc_id driver to drivers/soc
      ARM: ux500: call ux500_setup_id later
      ARM: ux500: consolidate soc_device code in id.c
      ARM: ux500: remove cpu_is_u* helpers
      ARM: ux500: use CLK_OF_DECLARE()
      ARM: ux500: move l2x0 init to .init_irq
      mfd: db8500 stop passing around platform data
      ASoC: ab8500-codec: remove platform data based probe
      ARM: ux500: move ab8500_regulator_plat_data into driver
      ARM: ux500: remove unused regulator data
      soc: raspberrypi-power: add CONFIG_OF dependency
      firmware: scpi: add CONFIG_OF dependency
      video: clps711x-fb: Changing the compatibility string to match with the smallest supported chip
      input: clps711x-keypad: Changing the compatibility string to match with the smallest supported chip
      pwm: clps711x: Changing the compatibility string to match with the smallest supported chip
      serial: clps711x: Changing the compatibility string to match with the smallest supported chip
      irqchip: clps711x: Changing the compatibility string to match with the smallest supported chip
      clocksource: clps711x: Changing the compatibility string to match with the smallest supported chip
      clk: clps711x: Changing the compatibility string to match with the smallest supported chip
      ...

commit 79cdad3635b3a253d712aba115fa274ef94a8c6b
Author: Ivaylo Dimitrov <ivo.g.dimitrov.75@gmail.com>
Date:   Wed Jun 22 22:22:21 2016 +0300

    ir-rx51: use hrtimer instead of dmtimer
    
    Drop dmtimer usage for pulse timer in favor of hrtimer. That allows
    removing PWM dmitimer platform data usage.
    
    Signed-off-by: Ivaylo Dimitrov <ivo.g.dimitrov.75@gmail.com>
    Acked-by: Pali Rohár <pali.rohar@gmail.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 0d7b05a36b99..7cc672b33e0c 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -486,9 +486,6 @@ static struct pwm_omap_dmtimer_pdata pwm_dmtimer_pdata = {
 
 static struct lirc_rx51_platform_data __maybe_unused rx51_lirc_data = {
 	.set_max_mpu_wakeup_lat = omap_pm_set_max_mpu_wakeup_lat,
-#if IS_ENABLED(CONFIG_OMAP_DM_TIMER)
-	.dmtimer = &pwm_dmtimer_pdata,
-#endif
 };
 
 static struct platform_device __maybe_unused rx51_lirc_device = {

commit b5406176989da601736db862643d3d7ee8335815
Author: Ivaylo Dimitrov <ivo.g.dimitrov.75@gmail.com>
Date:   Wed Jun 22 22:22:20 2016 +0300

    ir-rx51: add DT support to driver
    
    With the upcoming removal of legacy boot, lets add support to one of the
    last N900 drivers remaining without it. As the driver still uses omap
    dmtimer, add auxdata as well.
    
    Signed-off-by: Ivaylo Dimitrov <ivo.g.dimitrov.75@gmail.com>
    Acked-by: Rob Herring <robh@kernel.org>
    Acked-by: Pali Rohár <pali.rohar@gmail.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 278bb8f3b77b..0d7b05a36b99 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -273,8 +273,6 @@ static struct platform_device omap3_rom_rng_device = {
 	},
 };
 
-static struct platform_device rx51_lirc_device;
-
 static void __init nokia_n900_legacy_init(void)
 {
 	hsmmc2_internal_input_clk();
@@ -293,10 +291,7 @@ static void __init nokia_n900_legacy_init(void)
 
 		pr_info("RX-51: Registering OMAP3 HWRNG device\n");
 		platform_device_register(&omap3_rom_rng_device);
-
 	}
-
-	platform_device_register(&rx51_lirc_device);
 }
 
 static void __init omap3_tao3530_legacy_init(void)
@@ -531,6 +526,7 @@ static struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
 		       &omap3_iommu_pdata),
 	OF_DEV_AUXDATA("ti,omap3-hsmmc", 0x4809c000, "4809c000.mmc", &mmc_pdata[0]),
 	OF_DEV_AUXDATA("ti,omap3-hsmmc", 0x480b4000, "480b4000.mmc", &mmc_pdata[1]),
+	OF_DEV_AUXDATA("nokia,n900-ir", 0, "n900-ir", &rx51_lirc_data),
 	/* Only on am3517 */
 	OF_DEV_AUXDATA("ti,davinci_mdio", 0x5c030000, "davinci_mdio.0", NULL),
 	OF_DEV_AUXDATA("ti,am3517-emac", 0x5c000000, "davinci_emac.0",

commit 3fdd1526e6c5ceadd4e91906d223e2d382fb72ca
Author: Ivaylo Dimitrov <ivo.g.dimitrov.75@gmail.com>
Date:   Wed Jun 22 22:22:19 2016 +0300

    ir-rx51: use PWM framework instead of OMAP dmtimer
    
    Convert driver to use PWM framework instead of calling dmtimer functions
    directly for PWM timer. Remove paragraph about writing to the Free Software
    Foundation's mailing address while at it.
    
    Signed-off-by: Ivaylo Dimitrov <ivo.g.dimitrov.75@gmail.com>
    Acked-by: Pali Rohár <pali.rohar@gmail.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 6571ad959908..278bb8f3b77b 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -491,7 +491,6 @@ static struct pwm_omap_dmtimer_pdata pwm_dmtimer_pdata = {
 
 static struct lirc_rx51_platform_data __maybe_unused rx51_lirc_data = {
 	.set_max_mpu_wakeup_lat = omap_pm_set_max_mpu_wakeup_lat,
-	.pwm_timer = 9, /* Use GPT 9 for CIR */
 #if IS_ENABLED(CONFIG_OMAP_DM_TIMER)
 	.dmtimer = &pwm_dmtimer_pdata,
 #endif

commit c26c84c92ba8907402faaab760dc0e4ecec89dd0
Author: Peter Ujfalusi <peter.ujfalusi@ti.com>
Date:   Mon May 30 11:23:47 2016 +0300

    ARM: OMAP3: pdata-quirks: Add support for McBSP2/3 sidetone handling
    
    McBSP2/3 module's sidetone module operates using the module's ICLK clock.
    When the Sidetone is in use the interface clock of the module must not
    idle. To prevent the iclk idling the driver expects to have pdata callback
    to call. With this patch the callback is going to be set up for DT boot
    also.
    
    Signed-off-by: Peter Ujfalusi <peter.ujfalusi@ti.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 6571ad959908..ab2b2b2b90e5 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -26,6 +26,7 @@
 #include <linux/platform_data/wkup_m3.h>
 #include <linux/platform_data/pwm_omap_dmtimer.h>
 #include <linux/platform_data/media/ir-rx51.h>
+#include <linux/platform_data/asoc-ti-mcbsp.h>
 #include <plat/dmtimer.h>
 
 #include "common.h"
@@ -505,6 +506,16 @@ static struct platform_device __maybe_unused rx51_lirc_device = {
 	},
 };
 
+#if IS_ENABLED(CONFIG_SND_OMAP_SOC_MCBSP)
+static struct omap_mcbsp_platform_data mcbsp_pdata;
+static void __init omap3_mcbsp_init(void)
+{
+	omap3_mcbsp_init_pdata_callback(&mcbsp_pdata);
+}
+#else
+static void __init omap3_mcbsp_init(void) {}
+#endif
+
 /*
  * Few boards still need auxdata populated before we populate
  * the dev entries in of_platform_populate().
@@ -536,6 +547,11 @@ static struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
 	OF_DEV_AUXDATA("ti,davinci_mdio", 0x5c030000, "davinci_mdio.0", NULL),
 	OF_DEV_AUXDATA("ti,am3517-emac", 0x5c000000, "davinci_emac.0",
 		       &am35xx_emac_pdata),
+	/* McBSP modules with sidetone core */
+#if IS_ENABLED(CONFIG_SND_OMAP_SOC_MCBSP)
+	OF_DEV_AUXDATA("ti,omap3-mcbsp", 0x49022000, "49022000.mcbsp", &mcbsp_pdata),
+	OF_DEV_AUXDATA("ti,omap3-mcbsp", 0x49024000, "49024000.mcbsp", &mcbsp_pdata),
+#endif
 #endif
 #ifdef CONFIG_SOC_AM33XX
 	OF_DEV_AUXDATA("ti,am3352-wkup-m3", 0x44d00000, "44d00000.wkup_m3",
@@ -608,6 +624,8 @@ void __init pdata_quirks_init(const struct of_device_id *omap_dt_match_table)
 	    of_machine_is_compatible("ti,omap3"))
 		omap_sdrc_init(NULL, NULL);
 
+	if (of_machine_is_compatible("ti,omap3"))
+		omap3_mcbsp_init();
 	pdata_quirks_check(auxdata_quirks);
 	of_platform_populate(NULL, omap_dt_match_table,
 			     omap_auxdata_lookup, NULL);

commit ff628a4dbdc4867ef9706b306fb1e8b1abbe8062
Merge: 11c3aead8287 d4f414e559ca
Author: Arnd Bergmann <arnd@arndb.de>
Date:   Mon May 9 16:42:14 2016 +0200

    Merge tag 'omap-for-v4.7/auxdata-signed' of git://git.kernel.org/pub/scm/linux/kernel/git/tmlind/linux-omap into next/fixes-non-critical
    
    Merge "non urgent auxdata fix for v4.7 merge window" from Tony Lindgren:
    
    Device tree auxdata handling fix that allows a match based on the
    compatible string if no exact match based on the IO address is found.
    
    This leaves out the need to patch auxdata for each driver when adding
    new SoCs. And it also reprotedly fixes the issue of passing auxdata
    to a child if the parent instantiates the child from DT as discussed
    in the "[PATCH] of/platform: Allow secondary compatible match in
    of_dev_lookup" mailing list thread.
    
    As a minimal use case, let's also convert omap pinctrl auxdatato
    use a generic match.
    
    There is no need to get this in to the v4.6-rc cycle and it can wait
    for v4.7 merge window. Note that these changes have now been sitting
    in Linux next for about two weeks so far as I wanted to make sure no
    new issues are popping up.
    
    * tag 'omap-for-v4.7/auxdata-signed' of git://git.kernel.org/pub/scm/linux/kernel/git/tmlind/linux-omap:
      ARM: OMAP2+: Simplify auxdata by using the generic match
      of/platform: Allow secondary compatible match in of_dev_lookup

commit 10c1f7d32bf451d4309850c15ab1fdadccf92620
Author: Tony Lindgren <tony@atomide.com>
Date:   Thu Apr 28 08:20:53 2016 -0700

    ARM: OMAP2+: n900 needs MMC slot names for legacy user space
    
    Let's pass the slot names in pdata like the legacy code does.
    Once we have a generic DT binding for the slot names we can
    switch to that.
    
    Tested-by: Ivaylo Dimitrov <ivo.g.dimitrov.75@gmail.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index f8d389d031ba..ea3a7d550ea9 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -21,6 +21,7 @@
 #include <linux/regulator/fixed.h>
 
 #include <linux/platform_data/pinctrl-single.h>
+#include <linux/platform_data/hsmmc-omap.h>
 #include <linux/platform_data/iommu-omap.h>
 #include <linux/platform_data/wkup_m3.h>
 #include <linux/platform_data/pwm_omap_dmtimer.h>
@@ -37,6 +38,8 @@
 #include "soc.h"
 #include "hsmmc.h"
 
+static struct omap_hsmmc_platform_data __maybe_unused mmc_pdata[2];
+
 struct pdata_init {
 	const char *compatible;
 	void (*fn)(void);
@@ -275,6 +278,8 @@ static struct platform_device rx51_lirc_device;
 static void __init nokia_n900_legacy_init(void)
 {
 	hsmmc2_internal_input_clk();
+	mmc_pdata[0].name = "external";
+	mmc_pdata[1].name = "internal";
 
 	if (omap_type() == OMAP2_DEVICE_TYPE_SEC) {
 		if (IS_ENABLED(CONFIG_ARM_ERRATA_430973)) {
@@ -528,6 +533,8 @@ static struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
 	OF_DEV_AUXDATA("ti,omap3-padconf", 0x48002a00, "48002a00.pinmux", &pcs_pdata),
 	OF_DEV_AUXDATA("ti,omap2-iommu", 0x5d000000, "5d000000.mmu",
 		       &omap3_iommu_pdata),
+	OF_DEV_AUXDATA("ti,omap3-hsmmc", 0x4809c000, "4809c000.mmc", &mmc_pdata[0]),
+	OF_DEV_AUXDATA("ti,omap3-hsmmc", 0x480b4000, "480b4000.mmc", &mmc_pdata[1]),
 	/* Only on am3517 */
 	OF_DEV_AUXDATA("ti,davinci_mdio", 0x5c030000, "davinci_mdio.0", NULL),
 	OF_DEV_AUXDATA("ti,am3517-emac", 0x5c000000, "davinci_emac.0",

commit 8453c5cafd32c4d6bd13ec4a62d4b639f4edb222
Author: Tony Lindgren <tony@atomide.com>
Date:   Thu Apr 28 08:21:03 2016 -0700

    ARM: OMAP2+: Add more functions to pwm pdata for ir-rx51
    
    Before we start removing omap3 legacy booting support, let's make n900
    DT booting behave the same way for ir-rx51 as the legacy booting does.
    
    For now, we need to pass pdata to the ir-rx51 driver. This means that
    the n900 tree can move to using DT based booting without having to carry
    all the legacy platform data with it when it gets dropped from the mainline
    tree.
    
    Note that the ir-rx51 driver is currently disabled because of the
    dependency to !ARCH_MULTIPLATFORM. This will get sorted out later
    with the help of drivers/pwm/pwm-omap-dmtimer.c. But first we need
    to add chained IRQ support to dmtimer code to avoid introducing new
    custom frameworks.
    
    So let's just pass the necessary dmtimer functions to ir-rx51 so we
    can get it working in the following patch.
    
    Cc: Neil Armstrong <narmstrong@baylibre.com>
    Tested-by: Ivaylo Dimitrov <ivo.g.dimitrov.75@gmail.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index a935d28443da..f8d389d031ba 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -24,6 +24,7 @@
 #include <linux/platform_data/iommu-omap.h>
 #include <linux/platform_data/wkup_m3.h>
 #include <linux/platform_data/pwm_omap_dmtimer.h>
+#include <linux/platform_data/media/ir-rx51.h>
 #include <plat/dmtimer.h>
 
 #include "common.h"
@@ -31,6 +32,7 @@
 #include "dss-common.h"
 #include "control.h"
 #include "omap_device.h"
+#include "omap-pm.h"
 #include "omap-secure.h"
 #include "soc.h"
 #include "hsmmc.h"
@@ -268,6 +270,8 @@ static struct platform_device omap3_rom_rng_device = {
 	},
 };
 
+static struct platform_device rx51_lirc_device;
+
 static void __init nokia_n900_legacy_init(void)
 {
 	hsmmc2_internal_input_clk();
@@ -286,6 +290,8 @@ static void __init nokia_n900_legacy_init(void)
 		platform_device_register(&omap3_rom_rng_device);
 
 	}
+
+	platform_device_register(&rx51_lirc_device);
 }
 
 static void __init omap3_tao3530_legacy_init(void)
@@ -453,8 +459,14 @@ void omap_auxdata_legacy_init(struct device *dev)
 
 /* Dual mode timer PWM callbacks platdata */
 #if IS_ENABLED(CONFIG_OMAP_DM_TIMER)
-struct pwm_omap_dmtimer_pdata pwm_dmtimer_pdata = {
+static struct pwm_omap_dmtimer_pdata pwm_dmtimer_pdata = {
 	.request_by_node = omap_dm_timer_request_by_node,
+	.request_specific = omap_dm_timer_request_specific,
+	.request = omap_dm_timer_request,
+	.set_source = omap_dm_timer_set_source,
+	.get_irq = omap_dm_timer_get_irq,
+	.set_int_enable = omap_dm_timer_set_int_enable,
+	.set_int_disable = omap_dm_timer_set_int_disable,
 	.free = omap_dm_timer_free,
 	.enable = omap_dm_timer_enable,
 	.disable = omap_dm_timer_disable,
@@ -465,10 +477,29 @@ struct pwm_omap_dmtimer_pdata pwm_dmtimer_pdata = {
 	.set_match = omap_dm_timer_set_match,
 	.set_pwm = omap_dm_timer_set_pwm,
 	.set_prescaler = omap_dm_timer_set_prescaler,
+	.read_counter = omap_dm_timer_read_counter,
 	.write_counter = omap_dm_timer_write_counter,
+	.read_status = omap_dm_timer_read_status,
+	.write_status = omap_dm_timer_write_status,
 };
 #endif
 
+static struct lirc_rx51_platform_data __maybe_unused rx51_lirc_data = {
+	.set_max_mpu_wakeup_lat = omap_pm_set_max_mpu_wakeup_lat,
+	.pwm_timer = 9, /* Use GPT 9 for CIR */
+#if IS_ENABLED(CONFIG_OMAP_DM_TIMER)
+	.dmtimer = &pwm_dmtimer_pdata,
+#endif
+};
+
+static struct platform_device __maybe_unused rx51_lirc_device = {
+	.name           = "lirc_rx51",
+	.id             = -1,
+	.dev            = {
+		.platform_data = &rx51_lirc_data,
+	},
+};
+
 /*
  * Few boards still need auxdata populated before we populate
  * the dev entries in of_platform_populate().

commit d4f414e559caf36d811213e56b56e9b6957caab1
Author: Tony Lindgren <tony@atomide.com>
Date:   Fri Apr 15 08:45:33 2016 -0700

    ARM: OMAP2+: Simplify auxdata by using the generic match
    
    We can now just use the compatible if there's no need to have
    device instance specific auxdata.
    
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index a935d28443da..6ae132aadf6a 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -492,9 +492,6 @@ static struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
 	OF_DEV_AUXDATA("tlv320aic3x", 0x18, "2-0018", &n810_aic33_data),
 #endif
 #ifdef CONFIG_ARCH_OMAP3
-	OF_DEV_AUXDATA("ti,omap3-padconf", 0x48002030, "48002030.pinmux", &pcs_pdata),
-	OF_DEV_AUXDATA("ti,omap3-padconf", 0x480025a0, "480025a0.pinmux", &pcs_pdata),
-	OF_DEV_AUXDATA("ti,omap3-padconf", 0x48002a00, "48002a00.pinmux", &pcs_pdata),
 	OF_DEV_AUXDATA("ti,omap2-iommu", 0x5d000000, "5d000000.mmu",
 		       &omap3_iommu_pdata),
 	/* Only on am3517 */
@@ -506,19 +503,7 @@ static struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
 	OF_DEV_AUXDATA("ti,am3352-wkup-m3", 0x44d00000, "44d00000.wkup_m3",
 		       &wkup_m3_data),
 #endif
-#ifdef CONFIG_ARCH_OMAP4
-	OF_DEV_AUXDATA("ti,omap4-padconf", 0x4a100040, "4a100040.pinmux", &pcs_pdata),
-	OF_DEV_AUXDATA("ti,omap4-padconf", 0x4a31e040, "4a31e040.pinmux", &pcs_pdata),
-#endif
-#ifdef CONFIG_SOC_OMAP5
-	OF_DEV_AUXDATA("ti,omap5-padconf", 0x4a002840, "4a002840.pinmux", &pcs_pdata),
-	OF_DEV_AUXDATA("ti,omap5-padconf", 0x4ae0c840, "4ae0c840.pinmux", &pcs_pdata),
-#endif
-#ifdef CONFIG_SOC_DRA7XX
-	OF_DEV_AUXDATA("ti,dra7-padconf", 0x4a003400, "4a003400.pinmux", &pcs_pdata),
-#endif
 #ifdef CONFIG_SOC_AM43XX
-	OF_DEV_AUXDATA("ti,am437-padconf", 0x44e10800, "44e10800.pinmux", &pcs_pdata),
 	OF_DEV_AUXDATA("ti,am4372-wkup-m3", 0x44d00000, "44d00000.wkup_m3",
 		       &wkup_m3_data),
 #endif
@@ -531,6 +516,8 @@ static struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
 	OF_DEV_AUXDATA("ti,omap4-iommu", 0x55082000, "55082000.mmu",
 		       &omap4_iommu_pdata),
 #endif
+	/* Common auxdata */
+	OF_DEV_AUXDATA("pinctrl-single", 0, NULL, &pcs_pdata),
 	{ /* sentinel */ },
 };
 

commit 20437f79f6627a31752f422688a6047c25cefcf1
Author: Neil Armstrong <narmstrong@baylibre.com>
Date:   Fri Jan 22 17:15:51 2016 +0100

    ARM: OMAP: Add PWM dmtimer platform data quirks
    
    In order to set the currently platform dependent dmtimer
    functions pointers as platform data for the pwm-omap-dmtimer
    platform driver, add it to plat-omap auxdata_lookup table.
    
    Suggested-by: Tony Lindgren <tony@atomide.com>
    Signed-off-by: Neil Armstrong <narmstrong@baylibre.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index e781e4fae13a..a935d28443da 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -23,6 +23,8 @@
 #include <linux/platform_data/pinctrl-single.h>
 #include <linux/platform_data/iommu-omap.h>
 #include <linux/platform_data/wkup_m3.h>
+#include <linux/platform_data/pwm_omap_dmtimer.h>
+#include <plat/dmtimer.h>
 
 #include "common.h"
 #include "common-board-devices.h"
@@ -449,6 +451,24 @@ void omap_auxdata_legacy_init(struct device *dev)
 	dev->platform_data = &twl_gpio_auxdata;
 }
 
+/* Dual mode timer PWM callbacks platdata */
+#if IS_ENABLED(CONFIG_OMAP_DM_TIMER)
+struct pwm_omap_dmtimer_pdata pwm_dmtimer_pdata = {
+	.request_by_node = omap_dm_timer_request_by_node,
+	.free = omap_dm_timer_free,
+	.enable = omap_dm_timer_enable,
+	.disable = omap_dm_timer_disable,
+	.get_fclk = omap_dm_timer_get_fclk,
+	.start = omap_dm_timer_start,
+	.stop = omap_dm_timer_stop,
+	.set_load = omap_dm_timer_set_load,
+	.set_match = omap_dm_timer_set_match,
+	.set_pwm = omap_dm_timer_set_pwm,
+	.set_prescaler = omap_dm_timer_set_prescaler,
+	.write_counter = omap_dm_timer_write_counter,
+};
+#endif
+
 /*
  * Few boards still need auxdata populated before we populate
  * the dev entries in of_platform_populate().
@@ -502,6 +522,9 @@ static struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
 	OF_DEV_AUXDATA("ti,am4372-wkup-m3", 0x44d00000, "44d00000.wkup_m3",
 		       &wkup_m3_data),
 #endif
+#if IS_ENABLED(CONFIG_OMAP_DM_TIMER)
+	OF_DEV_AUXDATA("ti,omap-dmtimer-pwm", 0, NULL, &pwm_dmtimer_pdata),
+#endif
 #if defined(CONFIG_ARCH_OMAP4) || defined(CONFIG_SOC_OMAP5)
 	OF_DEV_AUXDATA("ti,omap4-iommu", 0x4a066000, "4a066000.mmu",
 		       &omap4_iommu_pdata),

commit 6d1c244803f2c013fb9c31b0904c01f1830b73ab
Merge: 1305eda751d7 4dd041b6f68a
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Jan 20 18:16:29 2016 -0800

    Merge tag 'armsoc-dt' of git://git.kernel.org/pub/scm/linux/kernel/git/arm/arm-soc
    
    Pull ARM DT updates from Olof Johansson:
     "As usual, the bulk of this release is again DT file contents.
    
      There's a huge number of changes here, and it's challenging to give a
      crisp overview of just what is in here.  To start with:
    
      New boards:
    
       - TI-based DM3730 from LogicPD (Torpedo)
       - Cosmic+ M4 (nommu) initial support (Freescale Vybrid)
       - Raspberry Pi 2 DT files
       - Watchdog on Meson8b
       - Veyron-mickey (ASUS Chromebit) DTS
       - Rockchip rk3228 SoC and eval board
       - Sigma Designs Tango4
    
      Improvements:
    
       - Improved support for Qualcomm APQ8084, including Sony Xperia Z DT files
       - Misc new devices for Rockchip rk3036 and rk3288
       - Allwinner updates for misc SoCs and systems
    
      ... and a _large_ number of other changes across the field.  Devices
      added to SoC DTSI and board DTS files for a number of SoC vendors, new
      product boards on already-supported SoCs, cleanups and refactorings of
      existing DTS/DTSI files and a bunch of other changes"
    
    * tag 'armsoc-dt' of git://git.kernel.org/pub/scm/linux/kernel/git/arm/arm-soc: (469 commits)
      ARM: dts: compulab: add new board description
      ARM: versatile: add the syscon LEDs to the DT
      dts: vt8500: Fix errors in SDHC node for WM8505
      ARM: dts: imx6q: clean up unused ipu2grp
      ARM: dts: silk: Add compatible property to "partitions" node
      ARM: dts: gose: Add compatible property to "partitions" node
      ARM: dts: porter: Add compatible property to "partitions" node
      ARM: dts: koelsch: Add compatible property to "partitions" node
      ARM: dts: lager: Add compatible property to "partitions" node
      ARM: dts: bockw: Add compatible property to "partitions" node
      ARM: dts: meson8b: Add watchdog node
      Documentation: watchdog: Add new bindings for meson8b
      ARM: meson: Add status LED for Odroid-C1
      ARM: dts: uniphier: fix a typo in comment block
      ARM: bcm2835: Add the auxiliary clocks to the device tree.
      ARM: bcm2835: Add devicetree for bcm2836 and Raspberry Pi 2 B
      ARM: bcm2835: Move the CPU/peripheral include out of common RPi DT.
      ARM: bcm2835: Split the DT for peripherals from the DT for the CPU
      ARM: realview: set up cache correctly on the PB11MPCore
      ARM: dts: Unify G2D device node with other devices on exynos4
      ...

commit a6dcb2626483929466aeed6347a1e6504b2c20f2
Merge: ab7f0bbba4fa 6c95771f8c71
Author: Olof Johansson <olof@lixom.net>
Date:   Tue Dec 22 14:55:02 2015 -0800

    Merge tag 'omap-for-v4.5/dt-pt2' of git://git.kernel.org/pub/scm/linux/kernel/git/tmlind/linux-omap into next/dt
    
    Second set of omap device tree changes for v4.5 merge window. This series
    updates the EDMA bindings based on the various fixes to split EDMA into
    separate independent devices. It also adds support for more devices on the
    CompuLab cm-t335 and LogicPD Torpedo boards, and enables the new bindings
    for qspi for am437x and dra7. There are also few dra7 regulator fixes, and
    change of gpoi-key,wakeup to wakeup-source.
    
    These depend on commit ae0add740cd0 ("dmaengine: edma: DT: Change reserved
    slot array from 16bit to 32bit type") already merged into mainline.
    
    * tag 'omap-for-v4.5/dt-pt2' of git://git.kernel.org/pub/scm/linux/kernel/git/tmlind/linux-omap:
      ARM: OMAP2+: LogicPD Torpedo: Add Touchscreen Support
      ARM: dts: DRA7-EVM: Add regulator-allow-bypass property for ldo9
      ARM: dts: DRA72-EVM: Add regulator-allow-bypass property for ldo1 and ldo2
      ARM: dts: AM4372: add entry for qspi mmap region
      ARM: dts: DRA7: add entry for qspi mmap region
      ARM: OMAP2+: LogicPD Torpedo: Revert Duplicative Entries
      ARM: OMAP2+: LogicPD Torpedo + Wireless: Add Bluetooth
      ARM: OMAP2+: LogicPD Torpedo: Add LCD Type 15 Support
      ARM: dts: cm-t335: add support for bluetooth
      ARM: dts: cm-t335: add support for DVI/LCD
      ARM: dts: cm-t335: add support for I2C GPIO expander
      ARM: dts: cm-t335: add support for SBC-T335
      ARM: dts: cm-t335: add support for USB0
      ARM: dts: omap: replace legacy *,wakeup property with wakeup-source
      ARM: dts: am335x: replace gpio-key,wakeup with wakeup-source property
      ARM: DTS: am437x: Use the new DT bindings for the eDMA3
      ARM: DTS: am33xx: Use the new DT bindings for the eDMA3
      dmaengine: edma: DT: Change reserved slot array from 16bit to 32bit type
      dmaengine: edma: DT: Change memcpy channel array from 16bit to 32bit type
    
    Signed-off-by: Olof Johansson <olof@lixom.net>

commit 45e2916be242ccf50cdc6da7863245722a46ea9e
Merge: 8907dbaa363d f2e6a0a913b5
Author: Olof Johansson <olof@lixom.net>
Date:   Tue Dec 22 14:49:17 2015 -0800

    Merge tag 'omap-for-v4.5/soc-initcall' of git://git.kernel.org/pub/scm/linux/kernel/git/tmlind/linux-omap into next/soc
    
    SoC changes for omaps for v4.5 merge window. The main change here is to
    change the omap initcall levels a bit to initialize things later to allow
    early device drivers at core_initcall level. This makes things easier
    for us as most clocks can be made into regular device drivers except for
    a few early clocks needed to initialize system timers. I wanted to have
    these changes sit in Linux next for a few weeks before sending out a pull
    request, and so far now issues have showed up.
    
    The other changes in this series are timer changes for making use of the
    new PWM driver, and timer changes to support more high security SoCs.
    Also few minor improvments for module autoidle settings for ti81xx spinbox
    and dra7 debug on uart4 in hwmod code. The rest is pretty much just removal
    of platform data for SoCs that are all device tree only nowadays.
    
    * tag 'omap-for-v4.5/soc-initcall' of git://git.kernel.org/pub/scm/linux/kernel/git/tmlind/linux-omap:
      ARM: OMAP2+: Remove device creation for omap-pcm-audio
      ARM: OMAP1: Remove device creation for omap-pcm-audio
      ARM: OMAP2+: Change core_initcall levels to postcore_initcall
      ARM: DRA7: hwmod: Enable DEBUG_LL for UART4
      ARM: OMAP: RX-51: fix a typo in log writing
      ARM: omap4: hwmod: Remove elm address space from hwmod data
      ARM: OMAP2+: timer: Remove secure timer for DRA7xx HS devices
      ARM: OMAP: dmtimer: check for fixed timers during config
      ARM: OMAP2+: Remove omap_mmu_dev_attr structure
      ARM: OMAP4: hwmod data: Remove legacy IOMMU attr and addrs
      ARM: OMAP3: hwmod data: Remove legacy IOMMU data
      ARM: OMAP2+: Remove legacy device instantiation of IOMMUs
      ARM: OMAP2+: Add hwmod spinbox support for dm816x
      ARM: OMAP: add DT support for ti,dm816-timer
      ARM: OMAP: dmtimer: Add clock source from DT
    
    Signed-off-by: Olof Johansson <olof@lixom.net>

commit 485fa1261f780e8a13d0b25a24673947e6c50953
Author: Adam Ford <aford173@gmail.com>
Date:   Wed Dec 16 15:34:15 2015 -0600

    ARM: OMAP2+: LogicPD Torpedo + Wireless: Add Bluetooth
    
    Bindings for the WL1283 Bluetooth was removed from the shared transport
    driver in commit c0bd1b9e5895 ("Revert ti-st: add device tree support")
    Until we havea better binding, we need to use the platform data to
    initialize Bluetooth.
    
    Signed-off-by: Adam Ford <aford173@gmail.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 1dfe34654c43..cd9775a4459d 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -153,6 +153,21 @@ static struct platform_device wl18xx_device = {
 	}
 };
 
+static struct ti_st_plat_data wilink7_pdata = {
+	.nshutdown_gpio = 162,
+	.dev_name = "/dev/ttyO1",
+	.flow_cntrl = 1,
+	.baud_rate = 300000,
+};
+
+static struct platform_device wl128x_device = {
+	.name	= "kim",
+	.id	= -1,
+	.dev	= {
+		.platform_data = &wilink7_pdata,
+	}
+};
+
 static struct platform_device btwilink_device = {
 	.name	= "btwilink",
 	.id	= -1,
@@ -279,6 +294,13 @@ static void __init omap3_tao3530_legacy_init(void)
 	hsmmc2_internal_input_clk();
 }
 
+static void __init omap3_logicpd_torpedo_init(void)
+{
+	omap3_gpio126_127_129();
+	platform_device_register(&wl128x_device);
+	platform_device_register(&btwilink_device);
+}
+
 /* omap3pandora legacy devices */
 #define PANDORA_WIFI_IRQ_GPIO		21
 #define PANDORA_WIFI_NRESET_GPIO	23
@@ -529,7 +551,7 @@ static struct pdata_init pdata_quirks[] __initdata = {
 	{ "nokia,omap3-n950", hsmmc2_internal_input_clk, },
 	{ "isee,omap3-igep0020-rev-f", omap3_igep0020_rev_f_legacy_init, },
 	{ "isee,omap3-igep0030-rev-g", omap3_igep0030_rev_g_legacy_init, },
-	{ "logicpd,dm3730-torpedo-devkit", omap3_gpio126_127_129, },
+	{ "logicpd,dm3730-torpedo-devkit", omap3_logicpd_torpedo_init, },
 	{ "ti,omap3-evm-37xx", omap3_evm_legacy_init, },
 	{ "ti,am3517-evm", am3517_evm_legacy_init, },
 	{ "technexion,omap3-tao3530", omap3_tao3530_legacy_init, },

commit 448f8bc69f3f74e2ecd143ef9c774851fc70d347
Author: Aaro Koskinen <aaro.koskinen@iki.fi>
Date:   Mon Nov 23 23:32:57 2015 +0200

    ARM: OMAP: RX-51: fix a typo in log writing
    
    Fix a typo when registering HW RNG.
    
    Signed-off-by: Aaro Koskinen <aaro.koskinen@iki.fi>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 1dfe34654c43..35ea6c0b03d4 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -268,7 +268,7 @@ static void __init nokia_n900_legacy_init(void)
 			pr_warn("Thumb binaries may crash randomly without this workaround\n");
 		}
 
-		pr_info("RX-51: Registring OMAP3 HWRNG device\n");
+		pr_info("RX-51: Registering OMAP3 HWRNG device\n");
 		platform_device_register(&omap3_rom_rng_device);
 
 	}

commit 9b1b61cd8e31d9beba871333d7a798b3adb89288
Author: Lucas Stach <l.stach@pengutronix.de>
Date:   Thu Oct 15 12:32:21 2015 +0200

    ARM: OMAP2+: remove custom abort handler for t410
    
    This is not needed anymore. Handling a potentially pending imprecise external
    abort left behind by the bootloader is now done in a slightly safer way inside
    the common ARM startup code.
    
    With the recent changes to abort handling, this issue got fixed by 57df53808534
    ("ARM: OMAP2+: Fix imprecise external abort caused by bogus SRAM init").
    
    Signed-off-by: Lucas Stach <l.stach@pengutronix.de>
    [tony@atomide.com: updated comments to describe what fixed the issue]
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 1dfe34654c43..58144779dec4 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -24,9 +24,6 @@
 #include <linux/platform_data/iommu-omap.h>
 #include <linux/platform_data/wkup_m3.h>
 
-#include <asm/siginfo.h>
-#include <asm/signal.h>
-
 #include "common.h"
 #include "common-board-devices.h"
 #include "dss-common.h"
@@ -385,29 +382,6 @@ static void __init omap3_pandora_legacy_init(void)
 }
 #endif /* CONFIG_ARCH_OMAP3 */
 
-#ifdef CONFIG_SOC_TI81XX
-static int fault_fixed_up;
-
-static int t410_abort_handler(unsigned long addr, unsigned int fsr,
-			      struct pt_regs *regs)
-{
-	if ((fsr == 0x406 || fsr == 0xc06) && !fault_fixed_up) {
-		pr_warn("External imprecise Data abort at addr=%#lx, fsr=%#x ignored.\n",
-			addr, fsr);
-		fault_fixed_up = 1;
-		return 0;
-	}
-
-	return 1;
-}
-
-static void __init t410_abort_init(void)
-{
-	hook_fault_code(16 + 6, t410_abort_handler, SIGBUS, BUS_OBJERR,
-			"imprecise external abort");
-}
-#endif
-
 #if defined(CONFIG_ARCH_OMAP4) || defined(CONFIG_SOC_OMAP5)
 static struct iommu_platform_data omap4_iommu_pdata = {
 	.reset_name = "mmu_cache",
@@ -536,9 +510,6 @@ static struct pdata_init pdata_quirks[] __initdata = {
 	{ "openpandora,omap3-pandora-600mhz", omap3_pandora_legacy_init, },
 	{ "openpandora,omap3-pandora-1ghz", omap3_pandora_legacy_init, },
 #endif
-#ifdef CONFIG_SOC_TI81XX
-	{ "hp,t410", t410_abort_init, },
-#endif
 #ifdef CONFIG_SOC_OMAP5
 	{ "ti,omap5-uevm", omap5_uevm_legacy_init, },
 #endif

commit 57df5380853460bc66b59a46273ce113c923d39c
Author: Tony Lindgren <tony@atomide.com>
Date:   Fri Oct 16 12:23:33 2015 -0700

    ARM: OMAP2+: Fix imprecise external abort caused by bogus SRAM init
    
    Some omaps are producing imprecise external aborts because we are
    wrongly trying to init SRAM for device tree based booting. Only
    omap3 is still using the legacy SRAM code, so we need to make it
    omap3 specific. Otherwise we can get errors like this on at least
    dm814x:
    
    Unhandled fault: imprecise external abort (0xc06) at 0xc08b156c
    ...
    (omap_rev) from [<c08b12e0>] (omap_sram_init+0xf8/0x3e0)
    (omap_sram_init) from [<c08aca0c>] (omap_sdrc_init+0x10/0xb0)
    (omap_sdrc_init) from [<c08b581c>] (pdata_quirks_init+0x18/0x44)
    (pdata_quirks_init) from [<c08b5478>] (omap_generic_init+0x10/0x1c)
    (omap_generic_init) from [<c08a57e0>] (customize_machine+0x1c/0x40)
    (customize_machine) from [<c00098a4>] (do_one_initcall+0x80/0x1dc)
    (do_one_initcall) from [<c08a2ec4>] (kernel_init_freeable+0x218/0x2e8)
    (kernel_init_freeable) from [<c063a554>] (kernel_init+0x8/0xec)
    (kernel_init) from [<c000f890>] (ret_from_fork+0x14/0x24)
    
    Let's fix the issue by making sure omap_sdrc_init only gets called for
    omap3. To do that, we need to have compatible "ti,omap3" in the dts
    files. And let's also use "ti,omap3630" instead of "ti,omap36xx" like
    we're supposed to.
    
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index ea56397599c2..1dfe34654c43 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -559,7 +559,14 @@ static void pdata_quirks_check(struct pdata_init *quirks)
 
 void __init pdata_quirks_init(const struct of_device_id *omap_dt_match_table)
 {
-	omap_sdrc_init(NULL, NULL);
+	/*
+	 * We still need this for omap2420 and omap3 PM to work, others are
+	 * using drivers/misc/sram.c already.
+	 */
+	if (of_machine_is_compatible("ti,omap2420") ||
+	    of_machine_is_compatible("ti,omap3"))
+		omap_sdrc_init(NULL, NULL);
+
 	pdata_quirks_check(auxdata_quirks);
 	of_platform_populate(NULL, omap_dt_match_table,
 			     omap_auxdata_lookup, NULL);

commit b3a5af435ab4b860714b2f56c65fd506aa677e71
Merge: 102178108e22 4c80a00388dd
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Tue Sep 1 13:09:20 2015 -0700

    Merge tag 'armsoc-dt' of git://git.kernel.org/pub/scm/linux/kernel/git/arm/arm-soc
    
    Pull ARM DT updates from Olof Johansson:
     "Ladies and gentlemen, we proudly announce to you the latest branch of
      ARM device tree contents for the mainline kernel.  Come and see, come
      and see!
    
      No less than twentythree thousand lines of additions! Just imagine the
      joy you will have of using your mainline kernel on newly supported
      hardware such as Rockchip Chromebooks, Freescale i.MX6UL boards or
      UniPhier hardware!
    
      For those of you feeling less adventurous, added hardware support on
      platforms such as TI DM814x and Gumstix Overo platforms might be more
      of your liking.
    
      We've got something for everyone here!
    
      Ahem.  Cough.  So, anyway...
    
      This is the usual large batch of DT updates.  Lots and lots of smaller
      changes, some of the larger ones to point out are:
    
       - Rockchip veyron (Chromebook) support, as well as several other new boards
       - DRM support on Atmel AT91SAM9N12EK
       - USB additions on some Allwinner platforms
       - Mediatek MT6580 support
       - Freescale i.MX6UL support
       - cleanups for Renesas shmobile platforms
       - lots of added devices on LPC18xx
       - lots of added devices and boards on UniPhier
    
      There's also some dependent code added here, in particular some
      branches that are primarily merged through the clock tree"
    
    * tag 'armsoc-dt' of git://git.kernel.org/pub/scm/linux/kernel/git/arm/arm-soc: (389 commits)
      ARM: tegra: Add gpio-ranges property
      ARM: tegra: Fix AHB base address on Tegra20, Tegra30 and Tegra114
      ARM: tegra: Add Tegra124 PMU support
      ARM: tegra: jetson-tk1: Add GK20A GPU DT node
      ARM: tegra: venice2: Add GK20A GPU DT node
      ARM: tegra: Add IOMMU node to GK20A
      ARM: tegra: Add CPU regulator to the Jetson TK1 device tree
      ARM: tegra: Add entries for cpufreq on Tegra124
      ARM: tegra: Enable the DFLL on the Jetson TK1
      ARM: tegra: Add the DFLL to Tegra124 device tree
      ARM: dts: zynq: Add devicetree entry for Xilinx Zynq reset controller.
      ARM: dts: UniPhier: fix PPI interrupt CPU mask of timer nodes
      ARM: dts: rockchip: correct regulator power states for suspend
      ARM: dts: rockchip: correct regulator PM properties
      ARM: dts: vexpress: Use assigned-clock-parents for sp810
      pinctrl: tegra: Only set the gpio range if needed
      arm: boot: dts: am4372: add ARM timers and SCU nodes
      ARM: dts: AM4372: Add the am4372-rtc compatible string
      ARM: shmobile: r8a7794 dtsi: Add CPG/MSTP Clock Domain
      ARM: shmobile: r8a7793 dtsi: Add CPG/MSTP Clock Domain
      ...

commit f5887fe5d14181aef0653ab04f60988252d42461
Author: Tony Lindgren <tony@atomide.com>
Date:   Thu Jul 23 22:33:19 2015 -0700

    ARM: OMAP2+: Add custom abort handler for t410
    
    Similar to commit fdf4850cb5b2 ("ARM: BCM5301X: workaround suppress fault"),
    let's add custom handling for the aborts on t410 that prevent booting:
    
    Unhandled fault: imprecise external abort (0xc06) at 0xee091fb0
    pgd = ee4bc000
    [ee091fb0] *pgd=ae00041e(bad)
    Kernel panic - not syncing: Attempted to kill init! exitcode=0x00000007
    
    Cc: Matthijs van Duin <matthijsvanduin@gmail.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 4e655ae2d507..1e9917c29958 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -24,6 +24,9 @@
 #include <linux/platform_data/iommu-omap.h>
 #include <linux/platform_data/wkup_m3.h>
 
+#include <asm/siginfo.h>
+#include <asm/signal.h>
+
 #include "common.h"
 #include "common-board-devices.h"
 #include "dss-common.h"
@@ -382,6 +385,29 @@ static void __init omap3_pandora_legacy_init(void)
 }
 #endif /* CONFIG_ARCH_OMAP3 */
 
+#ifdef CONFIG_SOC_TI81XX
+static int fault_fixed_up;
+
+static int t410_abort_handler(unsigned long addr, unsigned int fsr,
+			      struct pt_regs *regs)
+{
+	if ((fsr == 0x406 || fsr == 0xc06) && !fault_fixed_up) {
+		pr_warn("External imprecise Data abort at addr=%#lx, fsr=%#x ignored.\n",
+			addr, fsr);
+		fault_fixed_up = 1;
+		return 0;
+	}
+
+	return 1;
+}
+
+static void __init t410_abort_init(void)
+{
+	hook_fault_code(16 + 6, t410_abort_handler, SIGBUS, BUS_OBJERR,
+			"imprecise external abort");
+}
+#endif
+
 #if defined(CONFIG_ARCH_OMAP4) || defined(CONFIG_SOC_OMAP5)
 static struct iommu_platform_data omap4_iommu_pdata = {
 	.reset_name = "mmu_cache",
@@ -510,6 +536,9 @@ static struct pdata_init pdata_quirks[] __initdata = {
 	{ "openpandora,omap3-pandora-600mhz", omap3_pandora_legacy_init, },
 	{ "openpandora,omap3-pandora-1ghz", omap3_pandora_legacy_init, },
 #endif
+#ifdef CONFIG_SOC_TI81XX
+	{ "hp,t410", t410_abort_init, },
+#endif
 #ifdef CONFIG_SOC_OMAP5
 	{ "ti,omap5-uevm", omap5_uevm_legacy_init, },
 #endif

commit f9d50fef4b6447527c2be1ad07499221c2511391
Author: Grazvydas Ignotas <notasas@gmail.com>
Date:   Tue Jul 21 04:12:01 2015 +0300

    ARM: OMAP2+: omap3-pandora: add wifi support
    
    Add wl1251 support via pdata-quirks as it's driver lacks DT
    support. MMC3 is marked disabled in DT so that MMC3 instance of
    hsmmc driver is probed using platform data with special card init
    callback.
    
    Signed-off-by: Grazvydas Ignotas <notasas@gmail.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 9bfb47a4756e..4e655ae2d507 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -14,6 +14,11 @@
 #include <linux/kernel.h>
 #include <linux/of_platform.h>
 #include <linux/ti_wilink_st.h>
+#include <linux/wl12xx.h>
+#include <linux/mmc/card.h>
+#include <linux/mmc/host.h>
+#include <linux/regulator/machine.h>
+#include <linux/regulator/fixed.h>
 
 #include <linux/platform_data/pinctrl-single.h>
 #include <linux/platform_data/iommu-omap.h>
@@ -26,6 +31,7 @@
 #include "omap_device.h"
 #include "omap-secure.h"
 #include "soc.h"
+#include "hsmmc.h"
 
 struct pdata_init {
 	const char *compatible;
@@ -270,14 +276,109 @@ static void __init omap3_tao3530_legacy_init(void)
 	hsmmc2_internal_input_clk();
 }
 
+/* omap3pandora legacy devices */
+#define PANDORA_WIFI_IRQ_GPIO		21
+#define PANDORA_WIFI_NRESET_GPIO	23
+
 static struct platform_device pandora_backlight = {
 	.name	= "pandora-backlight",
 	.id	= -1,
 };
 
+static struct regulator_consumer_supply pandora_vmmc3_supply[] = {
+	REGULATOR_SUPPLY("vmmc", "omap_hsmmc.2"),
+};
+
+static struct regulator_init_data pandora_vmmc3 = {
+	.constraints = {
+		.valid_ops_mask		= REGULATOR_CHANGE_STATUS,
+	},
+	.num_consumer_supplies	= ARRAY_SIZE(pandora_vmmc3_supply),
+	.consumer_supplies	= pandora_vmmc3_supply,
+};
+
+static struct fixed_voltage_config pandora_vwlan = {
+	.supply_name		= "vwlan",
+	.microvolts		= 1800000, /* 1.8V */
+	.gpio			= PANDORA_WIFI_NRESET_GPIO,
+	.startup_delay		= 50000, /* 50ms */
+	.enable_high		= 1,
+	.init_data		= &pandora_vmmc3,
+};
+
+static struct platform_device pandora_vwlan_device = {
+	.name		= "reg-fixed-voltage",
+	.id		= 1,
+	.dev = {
+		.platform_data = &pandora_vwlan,
+	},
+};
+
+static void pandora_wl1251_init_card(struct mmc_card *card)
+{
+	/*
+	 * We have TI wl1251 attached to MMC3. Pass this information to
+	 * SDIO core because it can't be probed by normal methods.
+	 */
+	if (card->type == MMC_TYPE_SDIO || card->type == MMC_TYPE_SD_COMBO) {
+		card->quirks |= MMC_QUIRK_NONSTD_SDIO;
+		card->cccr.wide_bus = 1;
+		card->cis.vendor = 0x104c;
+		card->cis.device = 0x9066;
+		card->cis.blksize = 512;
+		card->cis.max_dtr = 24000000;
+		card->ocr = 0x80;
+	}
+}
+
+static struct omap2_hsmmc_info pandora_mmc3[] = {
+	{
+		.mmc		= 3,
+		.caps		= MMC_CAP_4_BIT_DATA | MMC_CAP_POWER_OFF_CARD,
+		.gpio_cd	= -EINVAL,
+		.gpio_wp	= -EINVAL,
+		.init_card	= pandora_wl1251_init_card,
+	},
+	{}	/* Terminator */
+};
+
+static void __init pandora_wl1251_init(void)
+{
+	struct wl1251_platform_data pandora_wl1251_pdata;
+	int ret;
+
+	memset(&pandora_wl1251_pdata, 0, sizeof(pandora_wl1251_pdata));
+
+	pandora_wl1251_pdata.power_gpio = -1;
+
+	ret = gpio_request_one(PANDORA_WIFI_IRQ_GPIO, GPIOF_IN, "wl1251 irq");
+	if (ret < 0)
+		goto fail;
+
+	pandora_wl1251_pdata.irq = gpio_to_irq(PANDORA_WIFI_IRQ_GPIO);
+	if (pandora_wl1251_pdata.irq < 0)
+		goto fail_irq;
+
+	pandora_wl1251_pdata.use_eeprom = true;
+	ret = wl1251_set_platform_data(&pandora_wl1251_pdata);
+	if (ret < 0)
+		goto fail_irq;
+
+	return;
+
+fail_irq:
+	gpio_free(PANDORA_WIFI_IRQ_GPIO);
+fail:
+	pr_err("wl1251 board initialisation failed\n");
+}
+
 static void __init omap3_pandora_legacy_init(void)
 {
 	platform_device_register(&pandora_backlight);
+	platform_device_register(&pandora_vwlan_device);
+	omap_hsmmc_init(pandora_mmc3);
+	omap_hsmmc_late_init(pandora_mmc3);
+	pandora_wl1251_init();
 }
 #endif /* CONFIG_ARCH_OMAP3 */
 

commit fc53e2ccf000b45298a325a6b6c3560d4ba8932b
Author: Grazvydas Ignotas <notasas@gmail.com>
Date:   Tue Jul 21 04:12:00 2015 +0300

    ARM: OMAP2+: omap3-pandora: add backlight support
    
    Add backlight support via pdata-quirks as it's driver lacks DT support.
    
    Signed-off-by: Grazvydas Ignotas <notasas@gmail.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 5417f2cbb2d4..9bfb47a4756e 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -269,6 +269,16 @@ static void __init omap3_tao3530_legacy_init(void)
 {
 	hsmmc2_internal_input_clk();
 }
+
+static struct platform_device pandora_backlight = {
+	.name	= "pandora-backlight",
+	.id	= -1,
+};
+
+static void __init omap3_pandora_legacy_init(void)
+{
+	platform_device_register(&pandora_backlight);
+}
 #endif /* CONFIG_ARCH_OMAP3 */
 
 #if defined(CONFIG_ARCH_OMAP4) || defined(CONFIG_SOC_OMAP5)
@@ -396,6 +406,8 @@ static struct pdata_init pdata_quirks[] __initdata = {
 	{ "ti,omap3-evm-37xx", omap3_evm_legacy_init, },
 	{ "ti,am3517-evm", am3517_evm_legacy_init, },
 	{ "technexion,omap3-tao3530", omap3_tao3530_legacy_init, },
+	{ "openpandora,omap3-pandora-600mhz", omap3_pandora_legacy_init, },
+	{ "openpandora,omap3-pandora-1ghz", omap3_pandora_legacy_init, },
 #endif
 #ifdef CONFIG_SOC_OMAP5
 	{ "ti,omap5-uevm", omap5_uevm_legacy_init, },

commit f734a9b3b19e01d598d03a336de32a59a52c1575
Author: Sekhar Nori <nsekhar@ti.com>
Date:   Sat Jul 11 20:29:15 2015 +0530

    ARM: OMAP2+: sparse: add missing static declaration
    
    Add missing static declaration for file local variables.
    This fixes sparse warnings of type:
    
    arch/arm/mach-omap2/omap_hwmod_81xx_data.c:491:26: warning: symbol 'dm81xx_alwon_l3_slow__gpmc' was not declared. Should it be static?
    
    Signed-off-by: Sekhar Nori <nsekhar@ti.com>
    Signed-off-by: Paul Walmsley <paul@pwsan.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 821171cf6b7d..1a352f561113 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -31,7 +31,7 @@ struct pdata_init {
 	void (*fn)(void);
 };
 
-struct of_dev_auxdata omap_auxdata_lookup[];
+static struct of_dev_auxdata omap_auxdata_lookup[];
 static struct twl4030_gpio_platform_data twl_gpio_auxdata;
 
 #ifdef CONFIG_MACH_NOKIA_N8X0
@@ -128,7 +128,7 @@ static void __init omap3_sbc_t3530_legacy_init(void)
 	omap3_sbc_t3x_usb_hub_init(167, "sb-t35 usb hub");
 }
 
-struct ti_st_plat_data wilink_pdata = {
+static struct ti_st_plat_data wilink_pdata = {
 	.nshutdown_gpio = 137,
 	.dev_name = "/dev/ttyO1",
 	.flow_cntrl = 1,
@@ -323,7 +323,7 @@ static struct pdata_init auxdata_quirks[] __initdata = {
 	{ /* sentinel */ },
 };
 
-struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
+static struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
 #ifdef CONFIG_MACH_NOKIA_N8X0
 	OF_DEV_AUXDATA("ti,omap2420-mmc", 0x4809c000, "mmci-omap.0", NULL),
 	OF_DEV_AUXDATA("menelaus", 0x72, "1-0072", &n8x0_menelaus_platform_data),

commit 6da74c54162c9582b21be978153513adbf44a678
Author: Dave Gerlach <d-gerlach@ti.com>
Date:   Mon Jul 13 12:34:53 2015 -0500

    ARM: OMAP2+: Use pdata-quirks for wkup_m3 reset management
    
    Use pdata-quirks to provide platform data required for reset
    management during boot and shutdown of the wkup_m3 processor
    on both the AM33xx and AM43xx SoCs. The WkupM3 remote processor
    is used to implement and achieve low-power functionality on
    the AM33xx & AM43xx SoCs.
    
    Signed-off-by: Suman Anna <s-anna@ti.com>
    Signed-off-by: Dave Gerlach <d-gerlach@ti.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 821171cf6b7d..5417f2cbb2d4 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -17,6 +17,7 @@
 
 #include <linux/platform_data/pinctrl-single.h>
 #include <linux/platform_data/iommu-omap.h>
+#include <linux/platform_data/wkup_m3.h>
 
 #include "common.h"
 #include "common-board-devices.h"
@@ -278,6 +279,14 @@ static struct iommu_platform_data omap4_iommu_pdata = {
 };
 #endif
 
+#if defined(CONFIG_SOC_AM33XX) || defined(CONFIG_SOC_AM43XX)
+static struct wkup_m3_platform_data wkup_m3_data = {
+	.reset_name = "wkup_m3",
+	.assert_reset = omap_device_assert_hardreset,
+	.deassert_reset = omap_device_deassert_hardreset,
+};
+#endif
+
 #ifdef CONFIG_SOC_OMAP5
 static void __init omap5_uevm_legacy_init(void)
 {
@@ -340,6 +349,10 @@ struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
 	OF_DEV_AUXDATA("ti,am3517-emac", 0x5c000000, "davinci_emac.0",
 		       &am35xx_emac_pdata),
 #endif
+#ifdef CONFIG_SOC_AM33XX
+	OF_DEV_AUXDATA("ti,am3352-wkup-m3", 0x44d00000, "44d00000.wkup_m3",
+		       &wkup_m3_data),
+#endif
 #ifdef CONFIG_ARCH_OMAP4
 	OF_DEV_AUXDATA("ti,omap4-padconf", 0x4a100040, "4a100040.pinmux", &pcs_pdata),
 	OF_DEV_AUXDATA("ti,omap4-padconf", 0x4a31e040, "4a31e040.pinmux", &pcs_pdata),
@@ -353,6 +366,8 @@ struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
 #endif
 #ifdef CONFIG_SOC_AM43XX
 	OF_DEV_AUXDATA("ti,am437-padconf", 0x44e10800, "44e10800.pinmux", &pcs_pdata),
+	OF_DEV_AUXDATA("ti,am4372-wkup-m3", 0x44d00000, "44d00000.wkup_m3",
+		       &wkup_m3_data),
 #endif
 #if defined(CONFIG_ARCH_OMAP4) || defined(CONFIG_SOC_OMAP5)
 	OF_DEV_AUXDATA("ti,omap4-iommu", 0x4a066000, "4a066000.mmu",

commit b96b332fd518cd4d08104bc5ca552ac1ade7e2c7
Author: Tony Lindgren <tony@atomide.com>
Date:   Wed May 20 09:23:43 2015 -0700

    ARM: OMAP3: Add support for configuring MMC pins as GPIO pins
    
    Some devices are using the MMC1 pins 4..8 as GPIO pins, and in
    this case they need to be configured for 1.8V IO voltage if not
    done by the bootloader as otherwise some devices like smsc911x
    won't work properly.
    
    Let's also make sure this register is saved and restored for
    idle.
    
    Cc: Tim Nordell <tim.nordell@logicpd.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index af11511dda50..821171cf6b7d 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -44,6 +44,27 @@ static void __init omap2420_n8x0_legacy_init(void)
 #endif
 
 #ifdef CONFIG_ARCH_OMAP3
+/*
+ * Configures GPIOs 126, 127 and 129 to 1.8V mode instead of 3.0V
+ * mode for MMC1 in case bootloader did not configure things.
+ * Note that if the pins are used for MMC1, pbias-regulator
+ * manages the IO voltage.
+ */
+static void __init omap3_gpio126_127_129(void)
+{
+	u32 reg;
+
+	reg = omap_ctrl_readl(OMAP343X_CONTROL_PBIAS_LITE);
+	reg &= ~OMAP343X_PBIASLITEVMODE1;
+	reg |= OMAP343X_PBIASLITEPWRDNZ1;
+	omap_ctrl_writel(reg, OMAP343X_CONTROL_PBIAS_LITE);
+	if (cpu_is_omap3630()) {
+		reg = omap_ctrl_readl(OMAP34XX_CONTROL_WKUP_CTRL);
+		reg |= OMAP36XX_GPIO_IO_PWRDNZ;
+		omap_ctrl_writel(reg, OMAP34XX_CONTROL_WKUP_CTRL);
+	}
+}
+
 static void __init hsmmc2_internal_input_clk(void)
 {
 	u32 reg;
@@ -356,6 +377,7 @@ static struct pdata_init pdata_quirks[] __initdata = {
 	{ "nokia,omap3-n950", hsmmc2_internal_input_clk, },
 	{ "isee,omap3-igep0020-rev-f", omap3_igep0020_rev_f_legacy_init, },
 	{ "isee,omap3-igep0030-rev-g", omap3_igep0030_rev_g_legacy_init, },
+	{ "logicpd,dm3730-torpedo-devkit", omap3_gpio126_127_129, },
 	{ "ti,omap3-evm-37xx", omap3_evm_legacy_init, },
 	{ "ti,am3517-evm", am3517_evm_legacy_init, },
 	{ "technexion,omap3-tao3530", omap3_tao3530_legacy_init, },

commit 99f84cae43df242f0d69ffcfee3a4d69f9b71b44
Author: Eliad Peller <eliad@wizery.com>
Date:   Wed Mar 18 18:38:29 2015 +0200

    ARM: dts: add wl12xx/wl18xx bindings
    
    Replace all the pdata-quirks for setting wl12xx/wl18xx
    platform data with proper DT definitions.
    
    Signed-off-by: Eliad Peller <eliad@wizery.com>
    Acked-by: Javier Martinez Canillas <javier@dowhile0.org>
    Acked-by: Enric Balletbo i Serra <eballetbo@gmail.com>
    Tested-by: Nikita Kiryanov <nikita@compulab.co.il>
    Tested-by: Tony Lindgren <tony@atomide.com>
    Acked-by: Kalle Valo <kvalo@codeaurora.org>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index cebdf8d0dc08..af11511dda50 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -14,7 +14,6 @@
 #include <linux/kernel.h>
 #include <linux/of_platform.h>
 #include <linux/ti_wilink_st.h>
-#include <linux/wl12xx.h>
 
 #include <linux/platform_data/pinctrl-single.h>
 #include <linux/platform_data/iommu-omap.h>
@@ -35,35 +34,6 @@ struct pdata_init {
 struct of_dev_auxdata omap_auxdata_lookup[];
 static struct twl4030_gpio_platform_data twl_gpio_auxdata;
 
-#if IS_ENABLED(CONFIG_WL12XX)
-
-static struct wl12xx_platform_data wl12xx __initdata;
-
-static void __init __used legacy_init_wl12xx(u32 ref_clock_freq,
-					     u32 tcxo_clock_freq,
-					     int gpio)
-{
-	int res;
-
-	wl12xx.ref_clock_freq = ref_clock_freq;
-	wl12xx.tcxo_clock_freq = tcxo_clock_freq;
-	wl12xx.irq = gpio_to_irq(gpio);
-	wl12xx.irq_trigger = IRQ_TYPE_LEVEL_HIGH;
-
-	res = wl12xx_set_platform_data(&wl12xx);
-	if (res) {
-		pr_err("error setting wl12xx data: %d\n", res);
-		return;
-	}
-}
-#else
-static inline void legacy_init_wl12xx(u32 ref_clock_freq,
-				      u32 tcxo_clock_freq,
-				      int gpio)
-{
-}
-#endif
-
 #ifdef CONFIG_MACH_NOKIA_N8X0
 static void __init omap2420_n8x0_legacy_init(void)
 {
@@ -130,7 +100,6 @@ static void __init omap3_sbc_t3730_twl_init(void)
 static void __init omap3_sbc_t3730_legacy_init(void)
 {
 	omap3_sbc_t3x_usb_hub_init(167, "sb-t35 usb hub");
-	legacy_init_wl12xx(38400000, 0, 136);
 }
 
 static void __init omap3_sbc_t3530_legacy_init(void)
@@ -160,14 +129,12 @@ static struct platform_device btwilink_device = {
 
 static void __init omap3_igep0020_rev_f_legacy_init(void)
 {
-	legacy_init_wl12xx(0, 0, 177);
 	platform_device_register(&wl18xx_device);
 	platform_device_register(&btwilink_device);
 }
 
 static void __init omap3_igep0030_rev_g_legacy_init(void)
 {
-	legacy_init_wl12xx(0, 0, 136);
 	platform_device_register(&wl18xx_device);
 	platform_device_register(&btwilink_device);
 }
@@ -175,12 +142,6 @@ static void __init omap3_igep0030_rev_g_legacy_init(void)
 static void __init omap3_evm_legacy_init(void)
 {
 	hsmmc2_internal_input_clk();
-	legacy_init_wl12xx(38400000, 0, 149);
-}
-
-static void __init omap3_zoom_legacy_init(void)
-{
-	legacy_init_wl12xx(26000000, 0, 162);
 }
 
 static void am35xx_enable_emac_int(void)
@@ -247,7 +208,6 @@ static void __init omap3_sbc_t3517_legacy_init(void)
 	am35xx_emac_reset();
 	hsmmc2_internal_input_clk();
 	omap3_sbc_t3517_wifi_init();
-	legacy_init_wl12xx(38400000, 0, 145);
 }
 
 static void __init am3517_evm_legacy_init(void)
@@ -289,23 +249,6 @@ static void __init omap3_tao3530_legacy_init(void)
 }
 #endif /* CONFIG_ARCH_OMAP3 */
 
-#ifdef CONFIG_ARCH_OMAP4
-static void __init omap4_sdp_legacy_init(void)
-{
-	legacy_init_wl12xx(26000000, 26000000, 53);
-}
-
-static void __init omap4_panda_legacy_init(void)
-{
-	legacy_init_wl12xx(38400000, 0, 53);
-}
-
-static void __init var_som_om44_legacy_init(void)
-{
-	legacy_init_wl12xx(38400000, 0, 41);
-}
-#endif
-
 #if defined(CONFIG_ARCH_OMAP4) || defined(CONFIG_SOC_OMAP5)
 static struct iommu_platform_data omap4_iommu_pdata = {
 	.reset_name = "mmu_cache",
@@ -314,13 +257,6 @@ static struct iommu_platform_data omap4_iommu_pdata = {
 };
 #endif
 
-#ifdef CONFIG_SOC_AM33XX
-static void __init am335x_evmsk_legacy_init(void)
-{
-	legacy_init_wl12xx(38400000, 0, 31);
-}
-#endif
-
 #ifdef CONFIG_SOC_OMAP5
 static void __init omap5_uevm_legacy_init(void)
 {
@@ -421,19 +357,9 @@ static struct pdata_init pdata_quirks[] __initdata = {
 	{ "isee,omap3-igep0020-rev-f", omap3_igep0020_rev_f_legacy_init, },
 	{ "isee,omap3-igep0030-rev-g", omap3_igep0030_rev_g_legacy_init, },
 	{ "ti,omap3-evm-37xx", omap3_evm_legacy_init, },
-	{ "ti,omap3-zoom3", omap3_zoom_legacy_init, },
 	{ "ti,am3517-evm", am3517_evm_legacy_init, },
 	{ "technexion,omap3-tao3530", omap3_tao3530_legacy_init, },
 #endif
-#ifdef CONFIG_ARCH_OMAP4
-	{ "ti,omap4-sdp", omap4_sdp_legacy_init, },
-	{ "ti,omap4-panda", omap4_panda_legacy_init, },
-	{ "variscite,var-dvk-om44", var_som_om44_legacy_init, },
-	{ "variscite,var-stk-om44", var_som_om44_legacy_init, },
-#endif
-#ifdef CONFIG_SOC_AM33XX
-	{ "ti,am335x-evmsk", am335x_evmsk_legacy_init, },
-#endif
 #ifdef CONFIG_SOC_OMAP5
 	{ "ti,omap5-uevm", omap5_uevm_legacy_init, },
 #endif

commit 44486b48b066330e0ed0a66478cc49f5975ec6c1
Author: Luciano Coelho <luca@coelho.fi>
Date:   Wed Mar 18 18:38:26 2015 +0200

    wl12xx: use frequency instead of enumerations for pdata clocks
    
    Instead of defining an enumeration with the FW specific values for the
    different clock rates, use the actual frequency instead.  Also add a
    boolean to specify whether the clock is XTAL or not.
    
    Change all board files to reflect this.
    
    Signed-off-by: Luciano Coelho <luca@coelho.fi>
    [Eliad - small fixes, update board file changes]
    Signed-off-by: Eliad Peller <eliad@wizery.com>
    Tested-by: Nikita Kiryanov <nikita@compulab.co.il>
    Acked-by: Kalle Valo <kvalo@codeaurora.org>
    Acked-by: Sekhar Nori <nsekhar@ti.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index e86fb0d55c59..cebdf8d0dc08 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -39,14 +39,14 @@ static struct twl4030_gpio_platform_data twl_gpio_auxdata;
 
 static struct wl12xx_platform_data wl12xx __initdata;
 
-static void __init __used legacy_init_wl12xx(unsigned ref_clock,
-					     unsigned tcxo_clock,
+static void __init __used legacy_init_wl12xx(u32 ref_clock_freq,
+					     u32 tcxo_clock_freq,
 					     int gpio)
 {
 	int res;
 
-	wl12xx.board_ref_clock = ref_clock;
-	wl12xx.board_tcxo_clock = tcxo_clock;
+	wl12xx.ref_clock_freq = ref_clock_freq;
+	wl12xx.tcxo_clock_freq = tcxo_clock_freq;
 	wl12xx.irq = gpio_to_irq(gpio);
 	wl12xx.irq_trigger = IRQ_TYPE_LEVEL_HIGH;
 
@@ -57,8 +57,8 @@ static void __init __used legacy_init_wl12xx(unsigned ref_clock,
 	}
 }
 #else
-static inline void legacy_init_wl12xx(unsigned ref_clock,
-				      unsigned tcxo_clock,
+static inline void legacy_init_wl12xx(u32 ref_clock_freq,
+				      u32 tcxo_clock_freq,
 				      int gpio)
 {
 }
@@ -130,7 +130,7 @@ static void __init omap3_sbc_t3730_twl_init(void)
 static void __init omap3_sbc_t3730_legacy_init(void)
 {
 	omap3_sbc_t3x_usb_hub_init(167, "sb-t35 usb hub");
-	legacy_init_wl12xx(WL12XX_REFCLOCK_38, 0, 136);
+	legacy_init_wl12xx(38400000, 0, 136);
 }
 
 static void __init omap3_sbc_t3530_legacy_init(void)
@@ -175,12 +175,12 @@ static void __init omap3_igep0030_rev_g_legacy_init(void)
 static void __init omap3_evm_legacy_init(void)
 {
 	hsmmc2_internal_input_clk();
-	legacy_init_wl12xx(WL12XX_REFCLOCK_38, 0, 149);
+	legacy_init_wl12xx(38400000, 0, 149);
 }
 
 static void __init omap3_zoom_legacy_init(void)
 {
-	legacy_init_wl12xx(WL12XX_REFCLOCK_26, 0, 162);
+	legacy_init_wl12xx(26000000, 0, 162);
 }
 
 static void am35xx_enable_emac_int(void)
@@ -247,7 +247,7 @@ static void __init omap3_sbc_t3517_legacy_init(void)
 	am35xx_emac_reset();
 	hsmmc2_internal_input_clk();
 	omap3_sbc_t3517_wifi_init();
-	legacy_init_wl12xx(WL12XX_REFCLOCK_38, 0, 145);
+	legacy_init_wl12xx(38400000, 0, 145);
 }
 
 static void __init am3517_evm_legacy_init(void)
@@ -292,18 +292,17 @@ static void __init omap3_tao3530_legacy_init(void)
 #ifdef CONFIG_ARCH_OMAP4
 static void __init omap4_sdp_legacy_init(void)
 {
-	legacy_init_wl12xx(WL12XX_REFCLOCK_26,
-			   WL12XX_TCXOCLOCK_26, 53);
+	legacy_init_wl12xx(26000000, 26000000, 53);
 }
 
 static void __init omap4_panda_legacy_init(void)
 {
-	legacy_init_wl12xx(WL12XX_REFCLOCK_38, 0, 53);
+	legacy_init_wl12xx(38400000, 0, 53);
 }
 
 static void __init var_som_om44_legacy_init(void)
 {
-	legacy_init_wl12xx(WL12XX_REFCLOCK_38, 0, 41);
+	legacy_init_wl12xx(38400000, 0, 41);
 }
 #endif
 
@@ -318,7 +317,7 @@ static struct iommu_platform_data omap4_iommu_pdata = {
 #ifdef CONFIG_SOC_AM33XX
 static void __init am335x_evmsk_legacy_init(void)
 {
-	legacy_init_wl12xx(WL12XX_REFCLOCK_38, 0, 31);
+	legacy_init_wl12xx(38400000, 0, 31);
 }
 #endif
 

commit 6f921fab5844941f7605b7f1a265f5fc7fe969a7
Author: Luciano Coelho <luca@coelho.fi>
Date:   Wed Mar 18 18:38:25 2015 +0200

    wlcore: set irq_trigger in board files instead of hiding behind a quirk
    
    The platform_quirk element in the platform data was used
    to change the way the IRQ is triggered.  When set,
    the EDGE_IRQ quirk would change the irqflags used
    and treat edge trigger differently from the rest.
    
    Instead of hiding this irq flag setting behind the quirk,
    have the board files set the irq_trigger explicitly.
    
    This will allow us to use standard irq DT definitions
    later on.
    
    Signed-off-by: Luciano Coelho <luca@coelho.fi>
    [Eliad - rebase, add irq_trigger field and pass it,
    update board file changes]
    Signed-off-by: Eliad Peller <eliad@wizery.com>
    Tested-by: Nikita Kiryanov <nikita@compulab.co.il>
    Acked-by: Kalle Valo <kvalo@codeaurora.org>
    Acked-by: Sekhar Nori <nsekhar@ti.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index e642b079e9f3..e86fb0d55c59 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -48,6 +48,7 @@ static void __init __used legacy_init_wl12xx(unsigned ref_clock,
 	wl12xx.board_ref_clock = ref_clock;
 	wl12xx.board_tcxo_clock = tcxo_clock;
 	wl12xx.irq = gpio_to_irq(gpio);
+	wl12xx.irq_trigger = IRQ_TYPE_LEVEL_HIGH;
 
 	res = wl12xx_set_platform_data(&wl12xx);
 	if (res) {

commit 5b7610f235627878617648a99dd1442997f1c889
Author: Tony Lindgren <tony@atomide.com>
Date:   Fri Mar 6 10:37:34 2015 -0800

    ARM: OMAP2+: Fix wl12xx on dm3730-evm with mainline u-boot
    
    I upgraded my u-boot and noticed that wl12xx stopped working.
    Turns out the kernel is not setting the quirk for the MMC2
    copy clock while the eariler bootloader I had was setting it.
    
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 190fa43e7479..e642b079e9f3 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -173,6 +173,7 @@ static void __init omap3_igep0030_rev_g_legacy_init(void)
 
 static void __init omap3_evm_legacy_init(void)
 {
+	hsmmc2_internal_input_clk();
 	legacy_init_wl12xx(WL12XX_REFCLOCK_38, 0, 149);
 }
 

commit 13eeb0f32645a9247b4c099b523af8c6e0420f56
Author: Tony Lindgren <tony@atomide.com>
Date:   Tue Jan 13 09:00:38 2015 -0800

    ARM: OMAP3: Remove legacy support for am35xx-emac
    
    This is no longer needed now that 3517 is booting in device tree
    only mode.
    
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 3d7eee1d3cfa..190fa43e7479 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -19,7 +19,6 @@
 #include <linux/platform_data/pinctrl-single.h>
 #include <linux/platform_data/iommu-omap.h>
 
-#include "am35xx.h"
 #include "common.h"
 #include "common-board-devices.h"
 #include "dss-common.h"

commit ea4409cc44e8f0f36182fcc22eb48b15ed61dd16
Merge: bcc8cef7c43c f80ecaf55b49
Author: Arnd Bergmann <arnd@arndb.de>
Date:   Fri Nov 28 14:56:14 2014 +0100

    Merge tag 'omap-for-v3.19/dt-part2-updated' of git://git.kernel.org/pub/scm/linux/kernel/git/tmlind/linux-omap into next/dt
    
    Pull "More dts changes for omaps to add support for new devices" from Tony Lindgren:
    
    - Add DCAN support am335x, am437x and dra7
    
    - Add devices for sb-t3x computers
    
    - Add support for NovaTech OrionLXm
    
    - Add n900 battery and si4713 support
    
    * tag 'omap-for-v3.19/dt-part2-updated' of git://git.kernel.org/pub/scm/linux/kernel/git/tmlind/linux-omap: (26 commits)
      ARM: dts: am335x-evm: Add DCAN1 details
      ARM: dts: am33xx: Update DCAN nodes
      ARM: dts: am33xx: Add control module syscon node
      ARM: dts: am437x-gp: Add dcan support
      ARM: dts: am4372: Add DCAN nodes
      ARM: dts: am4372: Add control module syscon node
      ARM: dts: dra72-evm: Add CAN support
      ARM: dts: dra7-evm: Add CAN support
      ARM: dts: DRA7: Add DCAN nodes
      ARM: dts: dra7: Add syscon regmap for CORE CONTROL area
      ARM: dts: sbc-t3x30: add audio support
      ARM: dts: sbc-t3x: add TV out display alias
      ARM: dts: cm-t3x: add TV out support
      ARM: dts: cm-t3x: add I2C1 pinmux
      ARM: dts: AM43xx: add tscadc DT entries for am437x-evm and am43x-epos-evm
      ARM: dts: cm-t3x30: add keypad support
      ARM: dts: sb-t35: add EEPROM support
      ARM: dts: cm-t3x: add EEPROM support
      ARM: OMAP2+: remove cm-t3x touchscreen pdata quirk
      ARM: dts: cm-t3x: add ADS7846 touchscreen support
      ...
    
    Signed-off-by: Arnd Bergmann <arnd@arndb.de>

commit 7dcfa7e1e27b6d3823ec77e6b4f0a6828690e1b2
Author: Dmitry Lifshitz <lifshitz@compulab.co.il>
Date:   Tue Nov 18 11:13:18 2014 +0200

    ARM: OMAP2+: remove cm-t3x touchscreen pdata quirk
    
    Remove ADS7846 touchscreen pdata quirk for CM-T3x CoMs
    
    Signed-off-by: Dmitry Lifshitz <lifshitz@compulab.co.il>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index e72f0fc91b02..02080c08ea0f 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -131,13 +131,11 @@ static void __init omap3_sbc_t3730_legacy_init(void)
 {
 	omap3_sbc_t3x_usb_hub_init(167, "sb-t35 usb hub");
 	legacy_init_wl12xx(WL12XX_REFCLOCK_38, 0, 136);
-	omap_ads7846_init(1, 57, 0, NULL);
 }
 
 static void __init omap3_sbc_t3530_legacy_init(void)
 {
 	omap3_sbc_t3x_usb_hub_init(167, "sb-t35 usb hub");
-	omap_ads7846_init(1, 57, 0, NULL);
 }
 
 struct ti_st_plat_data wilink_pdata = {
@@ -249,7 +247,6 @@ static void __init omap3_sbc_t3517_legacy_init(void)
 	hsmmc2_internal_input_clk();
 	omap3_sbc_t3517_wifi_init();
 	legacy_init_wl12xx(WL12XX_REFCLOCK_38, 0, 145);
-	omap_ads7846_init(1, 57, 0, NULL);
 }
 
 static void __init am3517_evm_legacy_init(void)

commit 498149dd1218625867d5139773c560f9f12193c9
Merge: 7d9e89c7c481 065bd7fe50de
Author: Arnd Bergmann <arnd@arndb.de>
Date:   Thu Nov 20 11:46:06 2014 +0100

    Merge tag 'omap-for-v3.19/dt-part1' of git://git.kernel.org/pub/scm/linux/kernel/git/tmlind/linux-omap into next/dt
    
    Pull "Device tree related changes for omaps" from Tony Lindgren:
    
    - Fix currently harmless but wrong sizes for various GPMC connected
      devices
    
    - Set up timings for several GPMC connected devices to get rid of
      bootloader dependencies in later patches
    
    - Enable various drivers for dra7xx
    
    - Prepare Igep boards to support new variants
    
    - Add intial support for BeagleBoard-X15
    
    * tag 'omap-for-v3.19/dt-part1' of git://git.kernel.org/pub/scm/linux/kernel/git/tmlind/linux-omap: (37 commits)
      ARM: dts: DRA7: Add aliases for all serial ports
      ARM: dts: Add am57xx-beagle-x15
      ARM: OMAP2+: igep00x0: Add pdata-quirks for the btwilink device.
      ARM: dts: omap3-igep00x0: Remove i2c2 node.
      ARM: dts: omap3-igep0020-rev-f: Support IGEPv2 Rev. F
      ARM: dts: omap3-igep0020-common: Introduce igep0020 common dtsi file.
      ARM: dts: omap3-igep0030-rev-g: Support IGEP COM MODULE Rev. G
      ARM: dts: omap3-igep0030-common: Introduce igep0030 common dtsi file.
      ARM: dts: omap3-igep00x0: Move outside common file the on board Wifi module.
      ARM: dts: omap3-igep0020: Specify IGEPv2 revision in device tree.
      ARM: dts: omap3-igep0030: Specify IGEP COM revision in device tree.
      ARM: dts: omap3-igep00x0: Move NAND configuration to a common place.
      ARM: dts: omap3-igep00x0: Fix UART2 pins that aren't common.
      ARM: dts: dra7: add labels to DWC3 nodes
      ARM: dts: dra72x-evm: Enable CPSW and MDIO
      ARM: dts: dra7-evm: Keep all VDD rails always-on
      ARM: dts: dra72-evm: Add MMC nodes
      ARM: dts: dra72-evm: Add power button node
      ARM: dts: dra72-evm: Provide explicit pinmux for TPS PMIC
      ARM: dts: dra72-evm: Add regulator information to USB2 PHYs
      ...
    
    Signed-off-by: Arnd Bergmann <arnd@arndb.de>

commit d565b5f4e50bfbb93408afb0502176021759bcd2
Author: Enric Balletbo i Serra <eballetbo@iseebcn.com>
Date:   Thu Nov 6 13:01:51 2014 +0100

    ARM: OMAP2+: igep00x0: Add pdata-quirks for the btwilink device.
    
    Add btwilink device for IGEPv2 Rev. F and IGEP COM MODULE Rev. G.
    
    Signed-off-by: Enric Balletbo i Serra <eballetbo@iseebcn.com>
    Acked-by: Javier Martinez Canillas <javier@dowhile0.org>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index c95346c94829..e72f0fc91b02 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -13,6 +13,7 @@
 #include <linux/init.h>
 #include <linux/kernel.h>
 #include <linux/of_platform.h>
+#include <linux/ti_wilink_st.h>
 #include <linux/wl12xx.h>
 
 #include <linux/platform_data/pinctrl-single.h>
@@ -139,8 +140,38 @@ static void __init omap3_sbc_t3530_legacy_init(void)
 	omap_ads7846_init(1, 57, 0, NULL);
 }
 
-static void __init omap3_igep0020_legacy_init(void)
+struct ti_st_plat_data wilink_pdata = {
+	.nshutdown_gpio = 137,
+	.dev_name = "/dev/ttyO1",
+	.flow_cntrl = 1,
+	.baud_rate = 300000,
+};
+
+static struct platform_device wl18xx_device = {
+	.name	= "kim",
+	.id	= -1,
+	.dev	= {
+		.platform_data = &wilink_pdata,
+	}
+};
+
+static struct platform_device btwilink_device = {
+	.name	= "btwilink",
+	.id	= -1,
+};
+
+static void __init omap3_igep0020_rev_f_legacy_init(void)
+{
+	legacy_init_wl12xx(0, 0, 177);
+	platform_device_register(&wl18xx_device);
+	platform_device_register(&btwilink_device);
+}
+
+static void __init omap3_igep0030_rev_g_legacy_init(void)
 {
+	legacy_init_wl12xx(0, 0, 136);
+	platform_device_register(&wl18xx_device);
+	platform_device_register(&btwilink_device);
 }
 
 static void __init omap3_evm_legacy_init(void)
@@ -393,7 +424,8 @@ static struct pdata_init pdata_quirks[] __initdata = {
 	{ "nokia,omap3-n900", nokia_n900_legacy_init, },
 	{ "nokia,omap3-n9", hsmmc2_internal_input_clk, },
 	{ "nokia,omap3-n950", hsmmc2_internal_input_clk, },
-	{ "isee,omap3-igep0020", omap3_igep0020_legacy_init, },
+	{ "isee,omap3-igep0020-rev-f", omap3_igep0020_rev_f_legacy_init, },
+	{ "isee,omap3-igep0030-rev-g", omap3_igep0030_rev_g_legacy_init, },
 	{ "ti,omap3-evm-37xx", omap3_evm_legacy_init, },
 	{ "ti,omap3-zoom3", omap3_zoom_legacy_init, },
 	{ "ti,am3517-evm", am3517_evm_legacy_init, },

commit 7d2911c4381555b31ef0bcae42a0dbf9ade7426e
Author: Tony Lindgren <tony@atomide.com>
Date:   Thu Oct 30 09:59:27 2014 -0700

    net: smc91x: Fix gpios for device tree based booting
    
    With legacy booting, the platform init code was taking care of
    the configuring of GPIOs. With device tree based booting, things
    may or may not work depending what bootloader has configured or
    if the legacy platform code gets called.
    
    Let's add support for the pwrdn and reset GPIOs to the smc91x
    driver to fix the issues of smc91x not working properly when
    booted in device tree mode.
    
    And let's change n900 to use these settings as some versions
    of the bootloader do not configure things properly causing
    errors.
    
    Reported-by: Kevin Hilman <khilman@linaro.org>
    Signed-off-by: Tony Lindgren <tony@atomide.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index c95346c94829..cec9d6c6442c 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -252,9 +252,6 @@ static void __init nokia_n900_legacy_init(void)
 		platform_device_register(&omap3_rom_rng_device);
 
 	}
-
-	/* Only on some development boards */
-	gpio_request_one(164, GPIOF_OUT_INIT_LOW, "smc91x reset");
 }
 
 static void __init omap3_tao3530_legacy_init(void)

commit 8b45bc892e6842115fc87c2b2a3b86a20617606a
Merge: eb785bef684f fa637bf0595e
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Oct 8 17:37:16 2014 -0400

    Merge tag 'drivers-for-linus' of git://git.kernel.org/pub/scm/linux/kernel/git/arm/arm-soc
    
    Pull ARM SoC driver updates from Arnd Bergmann:
     "These are changes for drivers that are intimately tied to some SoC and
      for some reason could not get merged through the respective subsystem
      maintainer tree.
    
      Most of the new code is for the Keystone Navigator driver, which is
      new base support that is going to be needed for their hardware
      accelerated network driver and other units.
    
      Most of the commits are for moving old code around from at91 and omap
      for things that are done in device drivers nowadays.
    
       - at91: move reset, poweroff, memory and clocksource code into
         drivers directories
       - socfpga: add edac driver (through arm-soc, as requested by Boris)
       - omap: move omap-intc code to drivers/irqchip
       - sunxi: added an RTC driver for sun6i
       - omap: mailbox driver related changes
       - keystone: support for the "Navigator" component
       - versatile: new reboot, led and soc drivers"
    
    * tag 'drivers-for-linus' of git://git.kernel.org/pub/scm/linux/kernel/git/arm/arm-soc: (92 commits)
      bus: arm-ccn: Fix spurious warning message
      leds: add device tree bindings for register bit LEDs
      soc: add driver for the ARM RealView
      power: reset: driver for the Versatile syscon reboot
      leds: add a driver for syscon-based LEDs
      drivers/soc: ti: fix build break with modules
      MAINTAINERS: Add Keystone Multicore Navigator drivers entry
      soc: ti: add Keystone Navigator DMA support
      Documentation: dt: soc: add Keystone Navigator DMA bindings
      soc: ti: add Keystone Navigator QMSS driver
      Documentation: dt: soc: add Keystone Navigator QMSS bindings
      rtc: sunxi: Depend on platforms sun4i/sun7i that actually have the rtc
      rtc: sun6i: Add sun6i RTC driver
      irqchip: omap-intc: remove unnecessary comments
      irqchip: omap-intc: correct maximum number or MIR registers
      irqchip: omap-intc: enable TURBO idle mode
      irqchip: omap-intc: enable IP protection
      irqchip: omap-intc: remove unnecesary of_address_to_resource() call
      irqchip: omap-intc: comment style cleanup
      irqchip: omap-intc: minor improvement to omap_irq_pending()
      ...

commit eb785bef684f2b7d03b530efc8e6f199e9777e2f
Merge: cf377ad7d42c ee48874d4aa5
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Oct 8 17:22:23 2014 -0400

    Merge tag 'dt-for-linus' of git://git.kernel.org/pub/scm/linux/kernel/git/arm/arm-soc
    
    Pull ARM SoC DT updates from Arnd Bergmann:
     "As usual, this is the largest branch, though this time a little under
      half of the total changes with 307 individual non-merge changesets.
    
      The largest changes are the addition of new machines, in particular
      the Tegra based Chromebook, the Renesas r8a7794 SoC, and DT support
      for the old i.MX1 platform.
    
      Other changes include
       - at91: various sam9 and sama5 updates
       - exynos: much extended Peach Pi/Pit (Chromebook 2) support
       - keystone: new peripherals
       - meson: added DT for meson6 SoC
       - mvebu: new device support for Armada 370/375
       - qcom: improved support for IPQ8064 and MSM8x60
       - rockchip: much improved support for rk3288
       - shmobile: lots of updates all over the place
       - sunxi: dts license change
       - sunxi: more a23 device support
       - vexpress: CLCD DT description"
    
    * tag 'dt-for-linus' of git://git.kernel.org/pub/scm/linux/kernel/git/arm/arm-soc: (308 commits)
      ARM: DTS: meson: update DTSI to add watchdog node
      ARM: dts: keystone-k2l: fix mdio io start address
      ARM: dts: keystone-k2e: fix mdio io start address
      ARM: dts: keystone-k2e: update usb1 node for dma properties
      ARM: dts: keystone: fix io range for usb_phy0
      Revert "Merge tag 'hix5hd2-dt-for-3.18' of git://github.com/hisilicon/linux-hisi into next/dt"
      Revert "ARM: dts: hix5hd2: add wdg node"
      ARM: dts: add rk3288 i2s controller
      ARM: vexpress: Add CLCD Device Tree properties
      ARM: bcm2835: add I2S pinctrl to device tree
      ARM: meson: documentation: add bindings documentation
      ARM: meson: dts: add basic Meson/Meson6/Meson6-atv1200 DTSI/DTS
      ARM: dts: mt6589: Change compatible string for GIC
      ARM: dts: mediatek: Add compatible property for aquaris5
      ARM: dts: mt6589-aquaris5: Add boot argument earlyprintk
      ARM: dts: mt6589: Fix typo in GIC unit address
      ARM: dts: Build dtb for Mediatek board
      ARM: dts: keystone: fix bindings for pcie and usb clock nodes
      ARM: dts: keystone: k2l: Fix chip selects for SPI devices
      ARM: dts: keystone: add dsp gpio controllers nodes
      ...

commit cf377ad7d42c566356d79049536d9cb37499cb77
Merge: 212fe84a6f21 d8f0faa339b0
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Oct 8 17:13:04 2014 -0400

    Merge tag 'soc-for-linus' of git://git.kernel.org/pub/scm/linux/kernel/git/arm/arm-soc
    
    Pull ARM SoC platform changes from Arnd Bergmann:
     "New and updated SoC support.  Among the things new for this release
      are:
    
       - at91: Added support for the new SAMA5D4 SoC, following the earlier
         SAMA5D3
       - bcm: Added support for BCM63XX family of DSL SoCs
       - hisi: Added support for HiP04 server-class SoC
       - meson: Initial support for the Amlogic Meson6 (aka 8726MX) platform
       - shmobile: added support for new r8a7794 (R-Car E2) automotive SoC
    
      Noteworthy changes to existing SoC support are:
    
       - imx: convert i.MX1 to device tree
       - omap: lots of power management work
       - omap: base support to enable moving to standard UART driver
       - shmobile: lots of progress for multiplatform support, still
         ongoing"
    
    * tag 'soc-for-linus' of git://git.kernel.org/pub/scm/linux/kernel/git/arm/arm-soc: (171 commits)
      ARM: hisi: depend on ARCH_MULTI_V7
      CNS3xxx: Fix debug UART.
      ARM: at91: fix nommu build regression
      ARM: meson: add basic support for MesonX SoCs
      ARM: meson: debug: add debug UART for earlyprintk support
      irq: Export handle_fasteoi_irq
      ARM: mediatek: Add earlyprintk support for mt6589
      ARM: hisi: Fix platmcpm compilation when ARMv6 is selected
      ARM: debug: fix alphanumerical order on debug uarts
      ARM: at91: document Atmel SMART compatibles
      ARM: at91: add sama5d4 support to sama5_defconfig
      ARM: at91: dt: add device tree file for SAMA5D4ek board
      ARM: at91: dt: add device tree file for SAMA5D4 SoC
      ARM: at91: SAMA5D4 SoC detection code and low level routines
      ARM: at91: introduce basic SAMA5D4 support
      clk: at91: add a driver for the h32mx clock
      ARM: pxa3xx: provide specific platform_devices for all ssp ports
      ARM: pxa: ssp: provide platform_device_id for PXA3xx
      ARM: OMAP4+: Remove static iotable mappings for SRAM
      ARM: OMAP4+: Move SRAM data to DT
      ...

commit 212fe84a6f215c39795a76517c1c02114d428681
Merge: 4a4743e840d0 05301fe7de11
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Wed Oct 8 17:06:53 2014 -0400

    Merge tag 'cleanup-for-linus' of git://git.kernel.org/pub/scm/linux/kernel/git/arm/arm-soc
    
    Pull ARM SoC cleanups from Arnd Bergmann:
     "This time around, the cleanup branch contains mostly code removal.  A
      number of board files for at91, imx and msm have become obsolete
      because of the DT conversion and are now ready to be removed.  The
      OMAP platform has traditionally had its own DMA engine abstraction and
      as this is being phased out, a lot of the original code is now unused
      and can be removed as well.
    
      S3C24xx can be simplified now that the restart code is a proper device
      driver.
    
      Finally, a number of cleanups in shmobile are done to prepare for the
      addition of new code in other branches"
    
    * tag 'cleanup-for-linus' of git://git.kernel.org/pub/scm/linux/kernel/git/arm/arm-soc: (43 commits)
      ARM: at91: Remove the support for the RSI EWS board
      arm: mach-omap2: Convert pr_warning to pr_warn
      ARM: OMAP: Remove unused pieces of legacy DMA API
      ARM: at91: remove board file for Acme Systems Fox G20
      ARM: orion5x: Convert pr_warning to pr_warn
      ARM: S3C24XX: remove separate restart code
      ARM: EXYNOS: Do not calculate boot address twice
      ARM: sunxi: Remove sun4i reboot code from mach directory
      ARM: imx: Remove mach-mxt_td60 board file
      ARM: shmobile: armadillo800eva legacy: Use rmobile_add_devices_to_domains()
      ARM: shmobile: r8a7740: Clean up pm domain table
      ARM: shmobile: r8a7740: Use rmobile_add_devices_to_domains()
      ARM: shmobile: sh7372: Make domain_devices[] static __initdata
      ARM: shmobile: mackerel: Make domain_devices[] static __initdata
      clocksource: tcb_clksrc: sanitize IRQ request
      ARM: at91/tclib: mask interruptions at shutdown and probe
      ARM: at91/tclib: move initialization from alloc to probe
      ARM: at91/tclib: prefer using of devm_* functions
      ARM: clps711x: Switch CLPS711X subarch to use clk and clocksource driver
      ARM: shmobile: r8a7791 is now called "R-Car M2-W"
      ...

commit 3d0cb73e9c85e60206ea9d5191bc0b9a0c4c8a99
Author: Joe Perches <joe@perches.com>
Date:   Sat Sep 13 11:31:16 2014 -0700

    arm: mach-omap2: Convert pr_warning to pr_warn
    
    Use the more common pr_warn.
    
    Other miscellanea:
    
    o Realign arguments
    
    Signed-off-by: Joe Perches <joe@perches.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 90c88d498485..73b333f35162 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -244,8 +244,8 @@ static void __init nokia_n900_legacy_init(void)
 			/* set IBE to 1 */
 			rx51_secure_update_aux_cr(BIT(6), 0);
 		} else {
-			pr_warning("RX-51: Not enabling ARM errata 430973 workaround\n");
-			pr_warning("Thumb binaries may crash randomly without this workaround\n");
+			pr_warn("RX-51: Not enabling ARM errata 430973 workaround\n");
+			pr_warn("Thumb binaries may crash randomly without this workaround\n");
 		}
 
 		pr_info("RX-51: Registring OMAP3 HWRNG device\n");

commit 271d4c6bc709d922e5f8913bcb64d6c53a752e31
Author: Tony Lindgren <tony@atomide.com>
Date:   Thu Sep 18 09:03:36 2014 -0700

    ARM: dts: Add support for Ethernet on some N900 macro boards
    
    As we have support for this in board-rx51-peripherals.c, let's
    add it to the .dts files too.
    
    Note that the reset GPIO will eventually go to the driver.
    For now let's just pull it down and skip any further reset
    in case the bootloader has configured the MAC address so
    NFSroot works.
    
    Also note that after 3430-sdp are using proper GPMC timings
    we can remove the tests for smsc,lan91c94 in gpmc.c.
    
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index b9d091b4d983..61e8394a7d13 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -252,6 +252,9 @@ static void __init nokia_n900_legacy_init(void)
 		platform_device_register(&omap3_rom_rng_device);
 
 	}
+
+	/* Only on some development boards */
+	gpio_request_one(164, GPIOF_OUT_INIT_LOW, "smc91x reset");
 }
 
 static void __init omap3_tao3530_legacy_init(void)

commit e92ce89c29fe104bc1246913f385093bbae7b564
Author: Felipe Balbi <balbi@ti.com>
Date:   Tue Sep 16 15:31:40 2014 -0500

    arm: omap2: n8x0: move i2c devices to DT
    
    By moving i2c devices to DT we can clean up
    i2c_board_info and fix a problem with moving
    INTC to irq domain where IRQs can be renumbered
    on each boot.
    
    Cc: Aaro Koskinen <aaro.koskinen@iki.fi>
    Signed-off-by: Felipe Balbi <balbi@ti.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 8695fd4ea476..06a0ccfa00a2 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -336,6 +336,8 @@ static struct pdata_init auxdata_quirks[] __initdata = {
 struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
 #ifdef CONFIG_MACH_NOKIA_N8X0
 	OF_DEV_AUXDATA("ti,omap2420-mmc", 0x4809c000, "mmci-omap.0", NULL),
+	OF_DEV_AUXDATA("menelaus", 0x72, "1-0072", &n8x0_menelaus_platform_data),
+	OF_DEV_AUXDATA("tlv320aic3x", 0x18, "2-0018", &n810_aic33_data),
 #endif
 #ifdef CONFIG_ARCH_OMAP3
 	OF_DEV_AUXDATA("ti,omap3-padconf", 0x48002030, "48002030.pinmux", &pcs_pdata),

commit 051c544010cf089ca6b8a229546bb7ec2950a54d
Merge: 5081ce621d35 31957609db52
Author: Tony Lindgren <tony@atomide.com>
Date:   Thu Sep 11 13:03:25 2014 -0700

    Merge branch 'omap-for-v3.18/fixes-not-urgent' into omap-for-v3.18/intc-v2

commit 31957609db529d401658adc2e91ef7df7ea42699
Author: Uwe Kleine-König <u.kleine-koenig@pengutronix.de>
Date:   Wed Sep 10 10:26:17 2014 +0200

    ARM: OMAP2+: make of_device_ids const
    
    of_device_ids (i.e. compatible strings and the respective data) are not
    supposed to change at runtime. All functions working with of_device_ids
    provided by <linux/of.h> work with const of_device_ids. So mark the
    non-const function parameters and structs for OMAP2+ as const, too.
    
    Signed-off-by: Uwe Kleine-König <u.kleine-koenig@pengutronix.de>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 90c88d498485..05a8c8b07449 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -405,7 +405,7 @@ static void pdata_quirks_check(struct pdata_init *quirks)
 	}
 }
 
-void __init pdata_quirks_init(struct of_device_id *omap_dt_match_table)
+void __init pdata_quirks_init(const struct of_device_id *omap_dt_match_table)
 {
 	omap_sdrc_init(NULL, NULL);
 	pdata_quirks_check(auxdata_quirks);

commit 63dd5bc03a1ac9dd90807f6f3fc2475c0d4f046a
Author: Stefan Roese <sr@denx.de>
Date:   Fri Aug 29 12:40:03 2014 +0200

    ARM: OMAP2+: tao3530: Add pdata-quirk for the mmc2 internal clock
    
    Set internal clock source for MMC2 on tao3530.
    
    Signed-off-by: Stefan Roese <sr@denx.de>
    Cc: Thorsten Eisbein <thorsten.eisbein@head-acoustics.de>
    Cc: Tapani Utriainen <tapani@technexion.com>
    Cc: Tony Lindgren <tony@atomide.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 90c88d498485..b9d091b4d983 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -253,6 +253,11 @@ static void __init nokia_n900_legacy_init(void)
 
 	}
 }
+
+static void __init omap3_tao3530_legacy_init(void)
+{
+	hsmmc2_internal_input_clk();
+}
 #endif /* CONFIG_ARCH_OMAP3 */
 
 #ifdef CONFIG_ARCH_OMAP4
@@ -377,6 +382,7 @@ static struct pdata_init pdata_quirks[] __initdata = {
 	{ "ti,omap3-evm-37xx", omap3_evm_legacy_init, },
 	{ "ti,omap3-zoom3", omap3_zoom_legacy_init, },
 	{ "ti,am3517-evm", am3517_evm_legacy_init, },
+	{ "technexion,omap3-tao3530", omap3_tao3530_legacy_init, },
 #endif
 #ifdef CONFIG_ARCH_OMAP4
 	{ "ti,omap4-sdp", omap4_sdp_legacy_init, },

commit dbbe9770d11284322db289c6ec83e8911e7a8f89
Author: Keerthy <j-keerthy@ti.com>
Date:   Mon Apr 7 11:54:49 2014 +0530

    ARM: AM437x: use pdata quirks for pinctrl information
    
    Provide pdata-quirks for Am437x processor family.
    
    Signed-off-by: Keerthy <j-keerthy@ti.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 827e106234f4..5fea34edb607 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -359,6 +359,9 @@ struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
 #ifdef CONFIG_SOC_DRA7XX
 	OF_DEV_AUXDATA("ti,dra7-padconf", 0x4a003400, "4a003400.pinmux", &pcs_pdata),
 #endif
+#ifdef CONFIG_SOC_AM43XX
+	OF_DEV_AUXDATA("ti,am437-padconf", 0x44e10800, "44e10800.pinmux", &pcs_pdata),
+#endif
 #if defined(CONFIG_ARCH_OMAP4) || defined(CONFIG_SOC_OMAP5)
 	OF_DEV_AUXDATA("ti,omap4-iommu", 0x4a066000, "4a066000.mmu",
 		       &omap4_iommu_pdata),

commit b0a3d0da6734116acf59e53aba9c61bc87bc78f1
Author: Nishanth Menon <nm@ti.com>
Date:   Thu May 22 23:39:54 2014 -0500

    ARM: DRA7: use pdata quirks for pinctrl information
    
    Provide pdata-quirks for DRA7 processor family.
    
    Signed-off-by: Nishanth Menon <nm@ti.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index edacfede26b1..827e106234f4 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -356,6 +356,9 @@ struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
 	OF_DEV_AUXDATA("ti,omap5-padconf", 0x4a002840, "4a002840.pinmux", &pcs_pdata),
 	OF_DEV_AUXDATA("ti,omap5-padconf", 0x4ae0c840, "4ae0c840.pinmux", &pcs_pdata),
 #endif
+#ifdef CONFIG_SOC_DRA7XX
+	OF_DEV_AUXDATA("ti,dra7-padconf", 0x4a003400, "4a003400.pinmux", &pcs_pdata),
+#endif
 #if defined(CONFIG_ARCH_OMAP4) || defined(CONFIG_SOC_OMAP5)
 	OF_DEV_AUXDATA("ti,omap4-iommu", 0x4a066000, "4a066000.mmu",
 		       &omap4_iommu_pdata),

commit 874fef7d02fab2208ab5b2ed0ad72c67b36ffb15
Author: Nishanth Menon <nm@ti.com>
Date:   Thu May 22 15:19:29 2014 -0500

    ARM: OMAP5: use pdata quirks for pinctrl information
    
    Provide pdata-quirks for OMAP5 processor family.
    
    Signed-off-by: Nishanth Menon <nm@ti.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 90c88d498485..edacfede26b1 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -352,6 +352,10 @@ struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
 	OF_DEV_AUXDATA("ti,omap4-padconf", 0x4a100040, "4a100040.pinmux", &pcs_pdata),
 	OF_DEV_AUXDATA("ti,omap4-padconf", 0x4a31e040, "4a31e040.pinmux", &pcs_pdata),
 #endif
+#ifdef CONFIG_SOC_OMAP5
+	OF_DEV_AUXDATA("ti,omap5-padconf", 0x4a002840, "4a002840.pinmux", &pcs_pdata),
+	OF_DEV_AUXDATA("ti,omap5-padconf", 0x4ae0c840, "4ae0c840.pinmux", &pcs_pdata),
+#endif
 #if defined(CONFIG_ARCH_OMAP4) || defined(CONFIG_SOC_OMAP5)
 	OF_DEV_AUXDATA("ti,omap4-iommu", 0x4a066000, "4a066000.mmu",
 		       &omap4_iommu_pdata),

commit 755a9ba7bf24a45b6dbf8bb15a5a56c8ed12461a
Merge: 7477838f2e48 0f16aa3c24a2
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Mon Jun 2 16:34:00 2014 -0700

    Merge tag 'dt-for-3.16' of git://git.kernel.org/pub/scm/linux/kernel/git/arm/arm-soc into next
    
    Pull ARM SoC devicetree updates from Olof Johansson:
     "As with previous release, this continues to be among the largest
      branches we merge, with lots of new contents.
    
      New things for this release are among other things:
    
       - DTSI contents for the new SoCs supported in 3.16 (see SoC pull request)
       - Qualcomm APQ8064 and APQ8084 SoCs and eval boards
       - Nvidia Jetson TK1 development board (Tegra T124-based)
    
      Two new SoCs that didn't need enough new platform code to stand out
      enough for me to notice when writing the SoC tag, but that adds new DT
      contents are:
    
       - TI DRA72
       - Marvell Berlin 2Q"
    
    * tag 'dt-for-3.16' of git://git.kernel.org/pub/scm/linux/kernel/git/arm/arm-soc: (500 commits)
      ARM: dts: add secure firmware support for exynos5420-arndale-octa
      ARM: dts: add pmu sysreg node to exynos3250
      ARM: dts: correct the usb phy node in exynos5800-peach-pi
      ARM: dts: correct the usb phy node in exynos5420-peach-pit
      ARM: dts: add dts files for exynos5410 and exynos5410-smdk5410
      ARM: dts: add dts files for exynos3250 SoC
      ARM: dts: add mfc node for exynos5800
      ARM: dts: add Vbus regulator for USB 3.0 on exynos5800-peach-pi
      ARM: dts: enable fimd for exynos5800-peach-pi
      ARM: dts: enable display controller for exynos5800-peach-pi
      ARM: dts: enable hdmi for exynos5800-peach-pi
      ARM: dts: add dts file for exynos5800-peach-pi board
      ARM: dts: add dts file for exynos5800 SoC
      ARM: dts: add dts file for exynos5260-xyref5260 board
      ARM: dts: add dts files for exynos5260 SoC
      ARM: dts: update watchdog node name in exynos5440
      ARM: dts: use key code macros on Origen and Arndale boards
      ARM: dts: enable RTC and WDT nodes on Origen boards
      ARM: dts: qcom: Add APQ8084-MTP board support
      ARM: dts: qcom: Add APQ8084 SoC support
      ...

commit 95eb894e93dfaab96f7fe3db3fb767e754e8ee1b
Author: Joachim Eastwood <manabian@gmail.com>
Date:   Mon May 12 20:32:03 2014 +0200

    ARM: OMAP2+: Use pdata quirks for wl12xx on VAR-STK/DVK-OM44
    
    Signed-off-by: Joachim Eastwood <manabian@gmail.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index c3b73351cb7a..ab94f3a87c32 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -254,6 +254,11 @@ static void __init omap4_panda_legacy_init(void)
 {
 	legacy_init_wl12xx(WL12XX_REFCLOCK_38, 0, 53);
 }
+
+static void __init var_som_om44_legacy_init(void)
+{
+	legacy_init_wl12xx(WL12XX_REFCLOCK_38, 0, 41);
+}
 #endif
 
 #if defined(CONFIG_ARCH_OMAP4) || defined(CONFIG_SOC_OMAP5)
@@ -364,6 +369,8 @@ static struct pdata_init pdata_quirks[] __initdata = {
 #ifdef CONFIG_ARCH_OMAP4
 	{ "ti,omap4-sdp", omap4_sdp_legacy_init, },
 	{ "ti,omap4-panda", omap4_panda_legacy_init, },
+	{ "variscite,var-dvk-om44", var_som_om44_legacy_init, },
+	{ "variscite,var-stk-om44", var_som_om44_legacy_init, },
 #endif
 #ifdef CONFIG_SOC_AM33XX
 	{ "ti,am335x-evmsk", am335x_evmsk_legacy_init, },

commit 14c0a5b4b909b6276f5cdcdbaaa2cfe6cc2b1309
Author: Sebastian Reichel <sre@kernel.org>
Date:   Mon Apr 7 14:28:46 2014 +0200

    ARM: OMAP2+: Add support for RNG on DT booted N900
    
    Add support for OMAP3 ROM Random Number Generator via
    pdata-quirks.
    
    Signed-off-by: Sebastian Reichel <sre@kernel.org>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index c3b73351cb7a..fa298bd2476e 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -226,6 +226,14 @@ static void __init am3517_evm_legacy_init(void)
 	am35xx_emac_reset();
 }
 
+static struct platform_device omap3_rom_rng_device = {
+	.name		= "omap3-rom-rng",
+	.id		= -1,
+	.dev	= {
+		.platform_data	= rx51_secure_rng_call,
+	},
+};
+
 static void __init nokia_n900_legacy_init(void)
 {
 	hsmmc2_internal_input_clk();
@@ -239,6 +247,10 @@ static void __init nokia_n900_legacy_init(void)
 			pr_warning("RX-51: Not enabling ARM errata 430973 workaround\n");
 			pr_warning("Thumb binaries may crash randomly without this workaround\n");
 		}
+
+		pr_info("RX-51: Registring OMAP3 HWRNG device\n");
+		platform_device_register(&omap3_rom_rng_device);
+
 	}
 }
 #endif /* CONFIG_ARCH_OMAP3 */

commit 0af9fb63915cf5ebb47b5c9ff16526b47545baf5
Merge: e5744abb2fa3 0f5d9d2e7d23
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Mon Apr 7 10:47:51 2014 -0700

    Merge tag 'fbdev-omap-3.15' of git://git.kernel.org/pub/scm/linux/kernel/git/tomba/linux
    
    Pull OMAP fbdev changes from Tomi Valkeinen:
     "This is based on the already pulled fbdev-main changes, and this also
      merges .dts branch from Tony Lindgren (which has also been pulled), so
      that I was able to add the display related .dts changes.
    
      This contains OMAP related fbdev changes for 3.15.  The bulk of the
      patches are for adding Device Tree support for OMAP Display Subsystem:
    
       - SoCs: OMAP2/3/4
    
       - Boards: OMAP4 Panda, OMAP4 SDP, OMAP3 Beagle, OMAP3 Beagle-xM,
         OMAP3 IGEP0020, OMAP3 N900
    
       - Devices: TFP410 Encoder, tpd12s015 HDMI companion chip, Sony
         acx565akm panel, MIPI DSI Command mode panel and HDMI, DVI and
         Analog TV connectors"
    
    * tag 'fbdev-omap-3.15' of git://git.kernel.org/pub/scm/linux/kernel/git/tomba/linux: (45 commits)
      OMAPDSS: HDMI: fix interlace output
      OMAPDSS: add missing __init for dss_init_ports
      ARM: OMAP2+: remove pdata quirks for displays
      OMAPDSS: remove DT hacks for regulators
      Doc/DT: Add DT binding documentation for tpd12s015 encoder
      Doc/DT: Add DT binding documentation for TFP410 encoder
      Doc/DT: Add DT binding documentation for Sony acx565akm panel
      Doc/DT: Add DT binding documentation for MIPI DSI CM Panel
      Doc/DT: Add DT binding documentation for HDMI Connector
      Doc/DT: Add DT binding documentation for DVI Connector
      Doc/DT: Add DT binding documentation for Analog TV Connector
      ARM: omap3-n900.dts: add display information
      ARM: omap3-igep0020.dts: add display information
      ARM: omap3-beagle-xm.dts: add display information
      ARM: omap3-beagle.dts: add display information
      ARM: omap4-sdp.dts: add display information
      Doc/DT: Add DT binding documentation for OMAP DSS
      OMAPDSS: acx565akm: Add DT support
      OMAPDSS: connector-analog-tv: Add DT support
      OMAPDSS: hdmi-connector: Add DT support
      ...

commit f83ccb93585d1f472c30fa2bbb8b56c23dbdb506
Merge: 930b440cd825 50b4af414d41
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Sat Apr 5 15:29:04 2014 -0700

    Merge tag 'dt-3.15' of git://git.kernel.org/pub/scm/linux/kernel/git/arm/arm-soc
    
    Pull ARM SoC device tree changes from Arnd Bergmann:
     "A large part of the arm-soc patches are nowadays DT changes, adding
      support for new SoCs, boards and devices without changing kernel
      source.  The plan is still to move the devicetree files out of the
      kernel tree and reduce the amount of churn going on here, but we keep
      finding reasons to delay doing that.
    
      Changes are really all over the place, with little sticking out
      particularly.  We have contributions from a total of 116 people in
      this branch.
    
      Unfortunately, the size of this branch also causes a significant
      number of conflicts at the moment, typically when subsystem
      maintainers merge patches that change the driver at the same time as
      the dts files.  In most cases this could be avoided because the dts
      changes are supposed to be compatible in both ways, and we are asking
      everyone to send ARM dts changes through our tree only"
    
    * tag 'dt-3.15' of git://git.kernel.org/pub/scm/linux/kernel/git/arm/arm-soc: (541 commits)
      dts: stmmac: Document the clocks property in the stmmac base document
      dts: socfpga: Add DTS entry for adding the stmmac glue layer for stmmac.
      ARM: STi: stih41x: Add support for the FSM Serial Flash Controller
      ARM: STi: stih416: Add support for the FSM Serial Flash Controller
      ARM: tegra: fix Dalmore pinctrl configuration
      ARM: dts: keystone: use common "ti,keystone" compatible instead of -evm
      ARM: dts: k2hk-evm: set ubifs partition size for 512M NAND
      ARM: dts: Build all keystone dt blobs
      ARM: dts: keystone: Fix control register range for clktsip
      ARM: dts: keystone: Fix domain register range for clkfftc1
      ARM: dts: bcm28155-ap: leave camldo1 on to fix reboot
      ARM: dts: add bcm590xx pmu support and enable for bcm28155-ap
      ARM: dts: bcm21664: Add device tree files.
      ARM: DT: bcm21664: Device tree bindings
      ARM: efm32: properly namespace i2c location property
      ARM: efm32: fix unit address part in USART2 device nodes' names
      ARM: mvebu: Enable NAND controller in Armada 385-DB
      ARM: mvebu: Add support for NAND controller in Armada 38x SoC
      ARM: mvebu: Add the Core Divider clock to Armada 38x SoCs
      ARM: mvebu: Add a 2 GHz fixed-clock on Armada 38x SoCs
      ...

commit b4f889208ffbd425ff1cb9ddcaf8483a3b91cd6a
Author: Tomi Valkeinen <tomi.valkeinen@ti.com>
Date:   Wed Dec 18 10:34:32 2013 +0200

    ARM: OMAP2+: remove pdata quirks for displays
    
    Remove pdata quirks for the displays on boards that are now supported
    properly with DT.
    
    Signed-off-by: Tomi Valkeinen <tomi.valkeinen@ti.com>
    Acked-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index db242c483dc0..b67f987bd094 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -139,7 +139,6 @@ static void __init omap3_sbc_t3530_legacy_init(void)
 
 static void __init omap3_igep0020_legacy_init(void)
 {
-	omap3_igep2_display_init_of();
 }
 
 static void __init omap3_evm_legacy_init(void)
@@ -229,14 +228,12 @@ static void __init am3517_evm_legacy_init(void)
 #ifdef CONFIG_ARCH_OMAP4
 static void __init omap4_sdp_legacy_init(void)
 {
-	omap_4430sdp_display_init_of();
 	legacy_init_wl12xx(WL12XX_REFCLOCK_26,
 			   WL12XX_TCXOCLOCK_26, 53);
 }
 
 static void __init omap4_panda_legacy_init(void)
 {
-	omap4_panda_display_init_of();
 	legacy_init_wl12xx(WL12XX_REFCLOCK_38, 0, 53);
 }
 #endif

commit 67eb1e6e4ae7ceaeb81b7a89f8fe85b93240f73b
Author: Suman Anna <s-anna@ti.com>
Date:   Wed Mar 5 18:24:15 2014 -0600

    ARM: OMAP2+: extend iommu pdata-quirks to OMAP5
    
    OMAP5 has the same iommus as OMAP4, so extend the OMAP4
    iommu pdata quirks for OMAP5 as well.
    
    Signed-off-by: Suman Anna <s-anna@ti.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 24bd3da928fa..db242c483dc0 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -239,7 +239,9 @@ static void __init omap4_panda_legacy_init(void)
 	omap4_panda_display_init_of();
 	legacy_init_wl12xx(WL12XX_REFCLOCK_38, 0, 53);
 }
+#endif
 
+#if defined(CONFIG_ARCH_OMAP4) || defined(CONFIG_SOC_OMAP5)
 static struct iommu_platform_data omap4_iommu_pdata = {
 	.reset_name = "mmu_cache",
 	.assert_reset = omap_device_assert_hardreset,
@@ -316,6 +318,8 @@ struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
 #ifdef CONFIG_ARCH_OMAP4
 	OF_DEV_AUXDATA("ti,omap4-padconf", 0x4a100040, "4a100040.pinmux", &pcs_pdata),
 	OF_DEV_AUXDATA("ti,omap4-padconf", 0x4a31e040, "4a31e040.pinmux", &pcs_pdata),
+#endif
+#if defined(CONFIG_ARCH_OMAP4) || defined(CONFIG_SOC_OMAP5)
 	OF_DEV_AUXDATA("ti,omap4-iommu", 0x4a066000, "4a066000.mmu",
 		       &omap4_iommu_pdata),
 	OF_DEV_AUXDATA("ti,omap4-iommu", 0x55082000, "55082000.mmu",

commit 910f1678bba914973c077a8b120444eb3bd979d6
Author: Suman Anna <s-anna@ti.com>
Date:   Wed Mar 5 18:24:13 2014 -0600

    ARM: OMAP2+: use pdata quirks for iommu reset lines
    
    The OMAP iommu driver performs the reset management for the
    iommu instances in processor sub-systems using the omap_device
    API which are currently supplied as platform data ops. Use pdata
    quirks to maintain the functionality as the OMAP iommu driver
    gets converted to use DT nodes, until the reset portions are
    decoupled from omap_hwmod/omap_device into a separate reset
    driver.
    
    This patch adds the pdata quirks for the reset management of
    iommus within the DSP (OMAP3 & OMAP4) and IPU subsystems (OMAP4).
    
    Signed-off-by: Suman Anna <s-anna@ti.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 9723886c18ba..24bd3da928fa 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -16,12 +16,14 @@
 #include <linux/wl12xx.h>
 
 #include <linux/platform_data/pinctrl-single.h>
+#include <linux/platform_data/iommu-omap.h>
 
 #include "am35xx.h"
 #include "common.h"
 #include "common-board-devices.h"
 #include "dss-common.h"
 #include "control.h"
+#include "omap_device.h"
 
 struct pdata_init {
 	const char *compatible;
@@ -78,6 +80,12 @@ static void __init hsmmc2_internal_input_clk(void)
 	omap_ctrl_writel(reg, OMAP343X_CONTROL_DEVCONF1);
 }
 
+static struct iommu_platform_data omap3_iommu_pdata = {
+	.reset_name = "mmu",
+	.assert_reset = omap_device_assert_hardreset,
+	.deassert_reset = omap_device_deassert_hardreset,
+};
+
 static int omap3_sbc_t3730_twl_callback(struct device *dev,
 					   unsigned gpio,
 					   unsigned ngpio)
@@ -231,6 +239,12 @@ static void __init omap4_panda_legacy_init(void)
 	omap4_panda_display_init_of();
 	legacy_init_wl12xx(WL12XX_REFCLOCK_38, 0, 53);
 }
+
+static struct iommu_platform_data omap4_iommu_pdata = {
+	.reset_name = "mmu_cache",
+	.assert_reset = omap_device_assert_hardreset,
+	.deassert_reset = omap_device_deassert_hardreset,
+};
 #endif
 
 #ifdef CONFIG_SOC_AM33XX
@@ -292,6 +306,8 @@ struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
 #ifdef CONFIG_ARCH_OMAP3
 	OF_DEV_AUXDATA("ti,omap3-padconf", 0x48002030, "48002030.pinmux", &pcs_pdata),
 	OF_DEV_AUXDATA("ti,omap3-padconf", 0x48002a00, "48002a00.pinmux", &pcs_pdata),
+	OF_DEV_AUXDATA("ti,omap2-iommu", 0x5d000000, "5d000000.mmu",
+		       &omap3_iommu_pdata),
 	/* Only on am3517 */
 	OF_DEV_AUXDATA("ti,davinci_mdio", 0x5c030000, "davinci_mdio.0", NULL),
 	OF_DEV_AUXDATA("ti,am3517-emac", 0x5c000000, "davinci_emac.0",
@@ -300,6 +316,10 @@ struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
 #ifdef CONFIG_ARCH_OMAP4
 	OF_DEV_AUXDATA("ti,omap4-padconf", 0x4a100040, "4a100040.pinmux", &pcs_pdata),
 	OF_DEV_AUXDATA("ti,omap4-padconf", 0x4a31e040, "4a31e040.pinmux", &pcs_pdata),
+	OF_DEV_AUXDATA("ti,omap4-iommu", 0x4a066000, "4a066000.mmu",
+		       &omap4_iommu_pdata),
+	OF_DEV_AUXDATA("ti,omap4-iommu", 0x55082000, "55082000.mmu",
+		       &omap4_iommu_pdata),
 #endif
 	{ /* sentinel */ },
 };

commit 90f4f01ba5c61c5a510664fbf105fee3bd137be4
Author: Imre Kaloz <kaloz@openwrt.org>
Date:   Mon Mar 3 10:02:56 2014 +0100

    ARM: OMAP2+: Use pdata quirks for wl12xx on the AM335x EV-MSK
    
    Enable the WiLink6 connected to mmc2.
    
    Signed-off-by: Imre Kaloz <kaloz@openwrt.org
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 111b8a2923e6..9723886c18ba 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -233,6 +233,13 @@ static void __init omap4_panda_legacy_init(void)
 }
 #endif
 
+#ifdef CONFIG_SOC_AM33XX
+static void __init am335x_evmsk_legacy_init(void)
+{
+	legacy_init_wl12xx(WL12XX_REFCLOCK_38, 0, 31);
+}
+#endif
+
 #ifdef CONFIG_SOC_OMAP5
 static void __init omap5_uevm_legacy_init(void)
 {
@@ -318,6 +325,9 @@ static struct pdata_init pdata_quirks[] __initdata = {
 	{ "ti,omap4-sdp", omap4_sdp_legacy_init, },
 	{ "ti,omap4-panda", omap4_panda_legacy_init, },
 #endif
+#ifdef CONFIG_SOC_AM33XX
+	{ "ti,am335x-evmsk", am335x_evmsk_legacy_init, },
+#endif
 #ifdef CONFIG_SOC_OMAP5
 	{ "ti,omap5-uevm", omap5_uevm_legacy_init, },
 #endif

commit 2ecf8aa1122ba3b2b2affc164af24e164383311d
Author: Roger Quadros <rogerq@ti.com>
Date:   Thu Feb 27 16:18:29 2014 +0200

    ARM: OMAP2+: Remove legacy_init_ehci_clk()
    
    The necessary clock phandle for the EHCI clock is now provided
    via device tree so we no longer need this legacy method.
    
    Update the omap4-panda and omap5-uevm board DTS to provide the
    necessary EHCI PHY clock information.
    
    Signed-off-by: Roger Quadros <rogerq@ti.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 3e1407c909f7..111b8a2923e6 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -31,20 +31,6 @@ struct pdata_init {
 struct of_dev_auxdata omap_auxdata_lookup[];
 static struct twl4030_gpio_platform_data twl_gpio_auxdata;
 
-/*
- * Create alias for USB host PHY clock.
- * Remove this when clock phandle can be provided via DT
- */
-static void __init __used legacy_init_ehci_clk(char *clkname)
-{
-	int ret;
-
-	ret = clk_add_alias("main_clk", NULL, clkname, NULL);
-	if (ret)
-		pr_err("%s:Failed to add main_clk alias to %s :%d\n",
-		       __func__, clkname, ret);
-}
-
 #if IS_ENABLED(CONFIG_WL12XX)
 
 static struct wl12xx_platform_data wl12xx __initdata;
@@ -243,7 +229,6 @@ static void __init omap4_sdp_legacy_init(void)
 static void __init omap4_panda_legacy_init(void)
 {
 	omap4_panda_display_init_of();
-	legacy_init_ehci_clk("auxclk3_ck");
 	legacy_init_wl12xx(WL12XX_REFCLOCK_38, 0, 53);
 }
 #endif
@@ -251,7 +236,6 @@ static void __init omap4_panda_legacy_init(void)
 #ifdef CONFIG_SOC_OMAP5
 static void __init omap5_uevm_legacy_init(void)
 {
-	legacy_init_ehci_clk("auxclk1_ck");
 }
 #endif
 

commit b62d91e5e1abe59f50b5861d26fdecec0e38eecf
Author: Dmitry Lifshitz <lifshitz@compulab.co.il>
Date:   Sun Jan 12 15:22:55 2014 +0200

    ARM: OMAP2+: make reset pulse for sbc-t3x usb hubs
    
    sbc-t3x boards features two external USB ports on SB-T35 baseboard.
    The baseboardi USB hub reset signal should be de-asserted to make
    those ports functional.
    
    sbc-t3517 features additional (assembled on CoM) USB hub which also
    requires reset signal handling.
    
    Add quirks code to handle proper reset pulse signal.
    
    Signed-off-by: Dmitry Lifshitz <lifshitz@compulab.co.il>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 1ee831fc5d0e..3e1407c909f7 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -108,6 +108,23 @@ static int omap3_sbc_t3730_twl_callback(struct device *dev,
 	return 0;
 }
 
+static void __init omap3_sbc_t3x_usb_hub_init(int gpio, char *hub_name)
+{
+	int err = gpio_request_one(gpio, GPIOF_OUT_INIT_LOW, hub_name);
+
+	if (err) {
+		pr_err("SBC-T3x: %s reset gpio request failed: %d\n",
+			hub_name, err);
+		return;
+	}
+
+	gpio_export(gpio, 0);
+
+	udelay(10);
+	gpio_set_value(gpio, 1);
+	msleep(1);
+}
+
 static void __init omap3_sbc_t3730_twl_init(void)
 {
 	twl_gpio_auxdata.setup = omap3_sbc_t3730_twl_callback;
@@ -115,12 +132,14 @@ static void __init omap3_sbc_t3730_twl_init(void)
 
 static void __init omap3_sbc_t3730_legacy_init(void)
 {
+	omap3_sbc_t3x_usb_hub_init(167, "sb-t35 usb hub");
 	legacy_init_wl12xx(WL12XX_REFCLOCK_38, 0, 136);
 	omap_ads7846_init(1, 57, 0, NULL);
 }
 
 static void __init omap3_sbc_t3530_legacy_init(void)
 {
+	omap3_sbc_t3x_usb_hub_init(167, "sb-t35 usb hub");
 	omap_ads7846_init(1, 57, 0, NULL);
 }
 
@@ -198,6 +217,8 @@ static void __init omap3_sbc_t3517_wifi_init(void)
 
 static void __init omap3_sbc_t3517_legacy_init(void)
 {
+	omap3_sbc_t3x_usb_hub_init(152, "cm-t3517 usb hub");
+	omap3_sbc_t3x_usb_hub_init(98, "sb-t35 usb hub");
 	am35xx_emac_reset();
 	hsmmc2_internal_input_clk();
 	omap3_sbc_t3517_wifi_init();

commit fb45105a838f8806f908a9fdf1269355b5daac56
Author: Dmitry Lifshitz <lifshitz@compulab.co.il>
Date:   Sun Jan 12 15:22:54 2014 +0200

    ARM: dts: sbc-t3517: add support for sbc-t3517
    
    Add support for CM-T3517 CoM and SBC-T3517 board.
    
    reused common support for sbc-t3x boards
    (omap3-cm-t3x.dtsi, omap3-sb-t35.dtsi):
    
    * SB-T35 baseboard eth
    * MMC1, UART3
    * HS USB Port 1/2
    * I2C1/3
    * Heartbit led
    
    Added basic support for:
    
    * MMC1 wp/cd signals
    * CM-T3517 Usb Hub
    * WL12xx WiFi chip
    * Davinci EMAC
    * AM35X OTG
    
    Signed-off-by: Dmitry Lifshitz <lifshitz@compulab.co.il>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 4f2591eaa17c..1ee831fc5d0e 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -165,7 +165,7 @@ static struct emac_platform_data am35xx_emac_pdata = {
 	.interrupt_disable	= am35xx_disable_emac_int,
 };
 
-static void __init am3517_evm_legacy_init(void)
+static void __init am35xx_emac_reset(void)
 {
 	u32 v;
 
@@ -174,6 +174,41 @@ static void __init am3517_evm_legacy_init(void)
 	omap_ctrl_writel(v, AM35XX_CONTROL_IP_SW_RESET);
 	omap_ctrl_readl(AM35XX_CONTROL_IP_SW_RESET); /* OCP barrier */
 }
+
+static struct gpio cm_t3517_wlan_gpios[] __initdata = {
+	{ 56,	GPIOF_OUT_INIT_HIGH,	"wlan pwr" },
+	{ 4,	GPIOF_OUT_INIT_HIGH,	"xcvr noe" },
+};
+
+static void __init omap3_sbc_t3517_wifi_init(void)
+{
+	int err = gpio_request_array(cm_t3517_wlan_gpios,
+				ARRAY_SIZE(cm_t3517_wlan_gpios));
+	if (err) {
+		pr_err("SBC-T3517: wl12xx gpios request failed: %d\n", err);
+		return;
+	}
+
+	gpio_export(cm_t3517_wlan_gpios[0].gpio, 0);
+	gpio_export(cm_t3517_wlan_gpios[1].gpio, 0);
+
+	msleep(100);
+	gpio_set_value(cm_t3517_wlan_gpios[1].gpio, 0);
+}
+
+static void __init omap3_sbc_t3517_legacy_init(void)
+{
+	am35xx_emac_reset();
+	hsmmc2_internal_input_clk();
+	omap3_sbc_t3517_wifi_init();
+	legacy_init_wl12xx(WL12XX_REFCLOCK_38, 0, 145);
+	omap_ads7846_init(1, 57, 0, NULL);
+}
+
+static void __init am3517_evm_legacy_init(void)
+{
+	am35xx_emac_reset();
+}
 #endif /* CONFIG_ARCH_OMAP3 */
 
 #ifdef CONFIG_ARCH_OMAP4
@@ -263,6 +298,7 @@ struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
  */
 static struct pdata_init pdata_quirks[] __initdata = {
 #ifdef CONFIG_ARCH_OMAP3
+	{ "compulab,omap3-sbc-t3517", omap3_sbc_t3517_legacy_init, },
 	{ "compulab,omap3-sbc-t3530", omap3_sbc_t3530_legacy_init, },
 	{ "compulab,omap3-sbc-t3730", omap3_sbc_t3730_legacy_init, },
 	{ "nokia,omap3-n900", hsmmc2_internal_input_clk, },

commit 40ecc02e571c78de8fadc4a0d4ba9a92f4ed8fad
Author: Dmitry Lifshitz <lifshitz@compulab.co.il>
Date:   Sun Jan 12 15:22:53 2014 +0200

    ARM: dts: sbc-t3530: add support for sbc-t3530
    
    Add support for CM-T3530 CoM and SBC-T3530 board.
    
    Signed-off-by: Dmitry Lifshitz <lifshitz@compulab.co.il>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 0748adec0071..4f2591eaa17c 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -119,6 +119,11 @@ static void __init omap3_sbc_t3730_legacy_init(void)
 	omap_ads7846_init(1, 57, 0, NULL);
 }
 
+static void __init omap3_sbc_t3530_legacy_init(void)
+{
+	omap_ads7846_init(1, 57, 0, NULL);
+}
+
 static void __init omap3_igep0020_legacy_init(void)
 {
 	omap3_igep2_display_init_of();
@@ -258,6 +263,7 @@ struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
  */
 static struct pdata_init pdata_quirks[] __initdata = {
 #ifdef CONFIG_ARCH_OMAP3
+	{ "compulab,omap3-sbc-t3530", omap3_sbc_t3530_legacy_init, },
 	{ "compulab,omap3-sbc-t3730", omap3_sbc_t3730_legacy_init, },
 	{ "nokia,omap3-n900", hsmmc2_internal_input_clk, },
 	{ "nokia,omap3-n9", hsmmc2_internal_input_clk, },

commit d234e423993faa3c58df057484fc5a45e1b577f5
Author: Dmitry Lifshitz <lifshitz@compulab.co.il>
Date:   Sun Jan 12 15:22:45 2014 +0200

    ARM: dts: sbc-t3x: refactor DT support
    
    Refactor the sbc-t3x device tree as a preparation for additional
    (sbc-t3530, sbc-t3517, etc.) boards support.
    
    No functional changes.
    
    The device tree will have the following structure:
    
    omap3-cm-t3x.dtsi
     |
     |<-- omap3-cm-t3x30.dtsi
     |     |
     |     |
     |     |     -----                  -------          ------------
     |     |    | CoM |                | Board |        | Base board |
     |     |     -----                  -------          ------------
     |     |                                            omap3-sb-t35.dtsi
     |     |                                                  |
     |     |<-- omap3-cm-t3730.dts <-- omap3-sbc-t3730.dts -->|
     |     |                                                  |
     |     |<-- omap3-cm-t3530.dts <-- omap3-sbc-t3530.dts -->|
     |                                                        |
     |<-------- omap3-cm-t3517.dts <-- omap3-sbc-t3517.dts -->|
    
    Signed-off-by: Dmitry Lifshitz <lifshitz@compulab.co.il>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 3d5b24dcd9a4..0748adec0071 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -99,7 +99,7 @@ static int omap3_sbc_t3730_twl_callback(struct device *dev,
 	int res;
 
 	res = gpio_request_one(gpio + 2, GPIOF_OUT_INIT_HIGH,
-			       "wlan rst");
+			       "wlan pwr");
 	if (res)
 		return res;
 

commit 4b41636878ee32d4c45a49de7749abca9721bd6a
Author: Tony Lindgren <tony@atomide.com>
Date:   Thu Feb 27 15:35:48 2014 -0800

    ARM: OMAP3: Fix pinctrl interrupts for core2
    
    After splitting padconf core into two parts to avoid exposing
    unaccessable registers, the new padconf core2 domain was left
    without a wake-up interrupt.
    
    Fix the issue by passing the shared wake-up interrupt in
    platform data like we do for padconf core and wkup domains
    already.
    
    Fixes: 3d49538364 (ARM: dts: Split omap3 pinmux core device)
    
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 0cc710d0da90..c33e07e2f0d4 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -257,6 +257,7 @@ struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
 #endif
 #ifdef CONFIG_ARCH_OMAP3
 	OF_DEV_AUXDATA("ti,omap3-padconf", 0x48002030, "48002030.pinmux", &pcs_pdata),
+	OF_DEV_AUXDATA("ti,omap3-padconf", 0x480025a0, "480025a0.pinmux", &pcs_pdata),
 	OF_DEV_AUXDATA("ti,omap3-padconf", 0x48002a00, "48002a00.pinmux", &pcs_pdata),
 	/* Only on am3517 */
 	OF_DEV_AUXDATA("ti,davinci_mdio", 0x5c030000, "davinci_mdio.0", NULL),

commit deff82e688a278eb4b822fd616c05fc62907bb71
Author: Sebastian Reichel <sre@debian.org>
Date:   Mon Feb 17 22:30:58 2014 +0100

    ARM: OMAP2+: Add support for thumb mode on DT booted N900
    
    Without enabling the workaround for ARM errata 430973 thumb
    compiled userland crashes randomly on the Nokia N900.
    
    Signed-off-by: Sebastian Reichel <sre@debian.org>
    Reviewed-by: Pavel Machek <pavel@ucw.cz>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 3d5b24dcd9a4..0cc710d0da90 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -22,6 +22,8 @@
 #include "common-board-devices.h"
 #include "dss-common.h"
 #include "control.h"
+#include "omap-secure.h"
+#include "soc.h"
 
 struct pdata_init {
 	const char *compatible;
@@ -169,6 +171,22 @@ static void __init am3517_evm_legacy_init(void)
 	omap_ctrl_writel(v, AM35XX_CONTROL_IP_SW_RESET);
 	omap_ctrl_readl(AM35XX_CONTROL_IP_SW_RESET); /* OCP barrier */
 }
+
+static void __init nokia_n900_legacy_init(void)
+{
+	hsmmc2_internal_input_clk();
+
+	if (omap_type() == OMAP2_DEVICE_TYPE_SEC) {
+		if (IS_ENABLED(CONFIG_ARM_ERRATA_430973)) {
+			pr_info("RX-51: Enabling ARM errata 430973 workaround\n");
+			/* set IBE to 1 */
+			rx51_secure_update_aux_cr(BIT(6), 0);
+		} else {
+			pr_warning("RX-51: Not enabling ARM errata 430973 workaround\n");
+			pr_warning("Thumb binaries may crash randomly without this workaround\n");
+		}
+	}
+}
 #endif /* CONFIG_ARCH_OMAP3 */
 
 #ifdef CONFIG_ARCH_OMAP4
@@ -259,7 +277,7 @@ struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
 static struct pdata_init pdata_quirks[] __initdata = {
 #ifdef CONFIG_ARCH_OMAP3
 	{ "compulab,omap3-sbc-t3730", omap3_sbc_t3730_legacy_init, },
-	{ "nokia,omap3-n900", hsmmc2_internal_input_clk, },
+	{ "nokia,omap3-n900", nokia_n900_legacy_init, },
 	{ "nokia,omap3-n9", hsmmc2_internal_input_clk, },
 	{ "nokia,omap3-n950", hsmmc2_internal_input_clk, },
 	{ "isee,omap3-igep0020", omap3_igep0020_legacy_init, },

commit 0f0cfc69547ea3e26f53e50eae2f25fe6ea1a77d
Author: Tony Lindgren <tony@atomide.com>
Date:   Wed Dec 18 13:13:21 2013 -0800

    ARM: dts: Add support for sbc-3xxx with cm-t3730
    
    This adds support for CompuLab SBC-T3530, also known as cm-t3730:
    
    http://compulab.co.il/products/sbcs/sbc-t3530/
    
    It seems that with the sbc-3xxx mainboard is also used on
    SBC-T3517 and SBC-T3730 with just a different CPU module:
    
    http://compulab.co.il/products/sbcs/sbc-t3517/
    http://compulab.co.il/products/sbcs/sbc-t3730/
    
    So let's add a common omap3-sb-t35.dtsi and then separate SoC
    specific omap3-sbc-t3730.dts, omap3-sbc-t3530.dts and
    omap3-sbc-t3517.dts.
    
    I've tested this with SBC-T3730 as that's the only one I have.
    At least serial, both Ethernet controllers, MMC, and wl12xx WLAN
    work.
    
    Note that WLAN seems to be different for SBC-T3530. And SBC-T3517
    may need some changes for the EMAC Ethernet if that's used
    instead of the smsc911x.
    
    Cc: devicetree@vger.kernel.org
    Cc: Mike Rapoport <mike@compulab.co.il>
    Acked-by: Igor Grinberg <grinberg@compulab.co.il>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 5aaf720211f4..3d5b24dcd9a4 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -92,6 +92,33 @@ static void __init hsmmc2_internal_input_clk(void)
 	omap_ctrl_writel(reg, OMAP343X_CONTROL_DEVCONF1);
 }
 
+static int omap3_sbc_t3730_twl_callback(struct device *dev,
+					   unsigned gpio,
+					   unsigned ngpio)
+{
+	int res;
+
+	res = gpio_request_one(gpio + 2, GPIOF_OUT_INIT_HIGH,
+			       "wlan rst");
+	if (res)
+		return res;
+
+	gpio_export(gpio, 0);
+
+	return 0;
+}
+
+static void __init omap3_sbc_t3730_twl_init(void)
+{
+	twl_gpio_auxdata.setup = omap3_sbc_t3730_twl_callback;
+}
+
+static void __init omap3_sbc_t3730_legacy_init(void)
+{
+	legacy_init_wl12xx(WL12XX_REFCLOCK_38, 0, 136);
+	omap_ads7846_init(1, 57, 0, NULL);
+}
+
 static void __init omap3_igep0020_legacy_init(void)
 {
 	omap3_igep2_display_init_of();
@@ -199,6 +226,9 @@ static struct pdata_init auxdata_quirks[] __initdata = {
 	{ "nokia,n800", omap2420_n8x0_legacy_init, },
 	{ "nokia,n810", omap2420_n8x0_legacy_init, },
 	{ "nokia,n810-wimax", omap2420_n8x0_legacy_init, },
+#endif
+#ifdef CONFIG_ARCH_OMAP3
+	{ "compulab,omap3-sbc-t3730", omap3_sbc_t3730_twl_init, },
 #endif
 	{ /* sentinel */ },
 };
@@ -228,6 +258,7 @@ struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
  */
 static struct pdata_init pdata_quirks[] __initdata = {
 #ifdef CONFIG_ARCH_OMAP3
+	{ "compulab,omap3-sbc-t3730", omap3_sbc_t3730_legacy_init, },
 	{ "nokia,omap3-n900", hsmmc2_internal_input_clk, },
 	{ "nokia,omap3-n9", hsmmc2_internal_input_clk, },
 	{ "nokia,omap3-n950", hsmmc2_internal_input_clk, },

commit 719003144642687d6dea27f7541ef026b9f356ac
Author: Tony Lindgren <tony@atomide.com>
Date:   Fri Dec 6 10:53:04 2013 -0800

    ARM: OMAP2+: Use pdata quirks for emac on am3517
    
    As the emac uses the system control module registers for
    reset and interrupts, we need to pass those in the platform
    data until we have a separate system control module driver.
    
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 47afff3b9c37..5aaf720211f4 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -8,6 +8,7 @@
  * published by the Free Software Foundation.
  */
 #include <linux/clk.h>
+#include <linux/davinci_emac.h>
 #include <linux/gpio.h>
 #include <linux/init.h>
 #include <linux/kernel.h>
@@ -16,6 +17,7 @@
 
 #include <linux/platform_data/pinctrl-single.h>
 
+#include "am35xx.h"
 #include "common.h"
 #include "common-board-devices.h"
 #include "dss-common.h"
@@ -104,6 +106,42 @@ static void __init omap3_zoom_legacy_init(void)
 {
 	legacy_init_wl12xx(WL12XX_REFCLOCK_26, 0, 162);
 }
+
+static void am35xx_enable_emac_int(void)
+{
+	u32 v;
+
+	v = omap_ctrl_readl(AM35XX_CONTROL_LVL_INTR_CLEAR);
+	v |= (AM35XX_CPGMAC_C0_RX_PULSE_CLR | AM35XX_CPGMAC_C0_TX_PULSE_CLR |
+	      AM35XX_CPGMAC_C0_MISC_PULSE_CLR | AM35XX_CPGMAC_C0_RX_THRESH_CLR);
+	omap_ctrl_writel(v, AM35XX_CONTROL_LVL_INTR_CLEAR);
+	omap_ctrl_readl(AM35XX_CONTROL_LVL_INTR_CLEAR); /* OCP barrier */
+}
+
+static void am35xx_disable_emac_int(void)
+{
+	u32 v;
+
+	v = omap_ctrl_readl(AM35XX_CONTROL_LVL_INTR_CLEAR);
+	v |= (AM35XX_CPGMAC_C0_RX_PULSE_CLR | AM35XX_CPGMAC_C0_TX_PULSE_CLR);
+	omap_ctrl_writel(v, AM35XX_CONTROL_LVL_INTR_CLEAR);
+	omap_ctrl_readl(AM35XX_CONTROL_LVL_INTR_CLEAR); /* OCP barrier */
+}
+
+static struct emac_platform_data am35xx_emac_pdata = {
+	.interrupt_enable	= am35xx_enable_emac_int,
+	.interrupt_disable	= am35xx_disable_emac_int,
+};
+
+static void __init am3517_evm_legacy_init(void)
+{
+	u32 v;
+
+	v = omap_ctrl_readl(AM35XX_CONTROL_IP_SW_RESET);
+	v &= ~AM35XX_CPGMACSS_SW_RST;
+	omap_ctrl_writel(v, AM35XX_CONTROL_IP_SW_RESET);
+	omap_ctrl_readl(AM35XX_CONTROL_IP_SW_RESET); /* OCP barrier */
+}
 #endif /* CONFIG_ARCH_OMAP3 */
 
 #ifdef CONFIG_ARCH_OMAP4
@@ -172,6 +210,10 @@ struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
 #ifdef CONFIG_ARCH_OMAP3
 	OF_DEV_AUXDATA("ti,omap3-padconf", 0x48002030, "48002030.pinmux", &pcs_pdata),
 	OF_DEV_AUXDATA("ti,omap3-padconf", 0x48002a00, "48002a00.pinmux", &pcs_pdata),
+	/* Only on am3517 */
+	OF_DEV_AUXDATA("ti,davinci_mdio", 0x5c030000, "davinci_mdio.0", NULL),
+	OF_DEV_AUXDATA("ti,am3517-emac", 0x5c000000, "davinci_emac.0",
+		       &am35xx_emac_pdata),
 #endif
 #ifdef CONFIG_ARCH_OMAP4
 	OF_DEV_AUXDATA("ti,omap4-padconf", 0x4a100040, "4a100040.pinmux", &pcs_pdata),
@@ -192,6 +234,7 @@ static struct pdata_init pdata_quirks[] __initdata = {
 	{ "isee,omap3-igep0020", omap3_igep0020_legacy_init, },
 	{ "ti,omap3-evm-37xx", omap3_evm_legacy_init, },
 	{ "ti,omap3-zoom3", omap3_zoom_legacy_init, },
+	{ "ti,am3517-evm", am3517_evm_legacy_init, },
 #endif
 #ifdef CONFIG_ARCH_OMAP4
 	{ "ti,omap4-sdp", omap4_sdp_legacy_init, },

commit dad12d11380882616872a8243a9c3f706fcedd31
Author: Tony Lindgren <tony@atomide.com>
Date:   Fri Dec 6 10:52:58 2013 -0800

    ARM: OMAP2+: Add support for legacy auxdata for twl
    
    As we currently need to support a mix of legacy platform data and
    device tree intialized data, let's make sure things keep working
    for the TWL GPIOs.
    
    Mostly the issue is caused by the fact that DSS does not yet have
    device tree bindings, so we need to rely on the TWL GPIO callback
    for setting up things like LCD backlight for some boards.
    
    As of_platform_populate() for the TWL GPIO is called by twl-core
    after the I2C bus has been initialized, we cannot pass the auxdata
    table from the board init code to twl-core like we used to with
    just legacy platform data.
    
    So let's use the omap_device bus hook to patch in the platform
    data for TWL GPIO until we have sorted out the issues with the
    TWL GPIOs and device tree bindings.
    
    The other option was be to initialize twl core using legacy
    platform data, which seems like a step backwards as we're moving
    to device tree only initialization.  And we really don't want to
    add custom configuration functions to the TWL GPIO driver either
    for this.
    
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 6a7554515b6e..47afff3b9c37 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -27,6 +27,7 @@ struct pdata_init {
 };
 
 struct of_dev_auxdata omap_auxdata_lookup[];
+static struct twl4030_gpio_platform_data twl_gpio_auxdata;
 
 /*
  * Create alias for USB host PHY clock.
@@ -136,6 +137,21 @@ void omap_pcs_legacy_init(int irq, void (*rearm)(void))
 	pcs_pdata.rearm = rearm;
 }
 
+/*
+ * GPIOs for TWL are initialized by the I2C bus and need custom
+ * handing until DSS has device tree bindings.
+ */
+void omap_auxdata_legacy_init(struct device *dev)
+{
+	if (dev->platform_data)
+		return;
+
+	if (strcmp("twl4030-gpio", dev_name(dev)))
+		return;
+
+	dev->platform_data = &twl_gpio_auxdata;
+}
+
 /*
  * Few boards still need auxdata populated before we populate
  * the dev entries in of_platform_populate().

commit fa590c923401368d86db361350849a7bf9f42b8a
Author: Tony Lindgren <tony@atomide.com>
Date:   Mon Nov 25 15:17:10 2013 -0800

    ARM: OMAP2+: Add quirks support for n8x0
    
    This allows us to keep things working when booted with
    device tree. Note that we still need to initialize most
    things with platform data as the drivers are lacking
    support for device tree.
    
    Tested-by: Aaro Koskinen <aaro.koskinen@iki.fi>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 468e4c1f2976..6a7554515b6e 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -26,6 +26,8 @@ struct pdata_init {
 	void (*fn)(void);
 };
 
+struct of_dev_auxdata omap_auxdata_lookup[];
+
 /*
  * Create alias for USB host PHY clock.
  * Remove this when clock phandle can be provided via DT
@@ -68,6 +70,15 @@ static inline void legacy_init_wl12xx(unsigned ref_clock,
 }
 #endif
 
+#ifdef CONFIG_MACH_NOKIA_N8X0
+static void __init omap2420_n8x0_legacy_init(void)
+{
+	omap_auxdata_lookup[0].platform_data = n8x0_legacy_init();
+}
+#else
+#define omap2420_n8x0_legacy_init	NULL
+#endif
+
 #ifdef CONFIG_ARCH_OMAP3
 static void __init hsmmc2_internal_input_clk(void)
 {
@@ -130,6 +141,11 @@ void omap_pcs_legacy_init(int irq, void (*rearm)(void))
  * the dev entries in of_platform_populate().
  */
 static struct pdata_init auxdata_quirks[] __initdata = {
+#ifdef CONFIG_SOC_OMAP2420
+	{ "nokia,n800", omap2420_n8x0_legacy_init, },
+	{ "nokia,n810", omap2420_n8x0_legacy_init, },
+	{ "nokia,n810-wimax", omap2420_n8x0_legacy_init, },
+#endif
 	{ /* sentinel */ },
 };
 

commit 036582f76ad900e4c1b9ec290ce66c6f698bd00d
Author: Tony Lindgren <tony@atomide.com>
Date:   Mon Nov 25 15:17:09 2013 -0800

    ARM: OMAP2+: Add support for board specific auxdata quirks
    
    Looks like some boards need to fill in the auxdata before
    we call of_platform_populate(). Let's add support for
    auxdata quirks like we already have for pdata quirks for
    legacy drivers.
    
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 39f020c982e8..468e4c1f2976 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -125,7 +125,18 @@ void omap_pcs_legacy_init(int irq, void (*rearm)(void))
 	pcs_pdata.rearm = rearm;
 }
 
+/*
+ * Few boards still need auxdata populated before we populate
+ * the dev entries in of_platform_populate().
+ */
+static struct pdata_init auxdata_quirks[] __initdata = {
+	{ /* sentinel */ },
+};
+
 struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
+#ifdef CONFIG_MACH_NOKIA_N8X0
+	OF_DEV_AUXDATA("ti,omap2420-mmc", 0x4809c000, "mmci-omap.0", NULL),
+#endif
 #ifdef CONFIG_ARCH_OMAP3
 	OF_DEV_AUXDATA("ti,omap3-padconf", 0x48002030, "48002030.pinmux", &pcs_pdata),
 	OF_DEV_AUXDATA("ti,omap3-padconf", 0x48002a00, "48002a00.pinmux", &pcs_pdata),
@@ -137,6 +148,10 @@ struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
 	{ /* sentinel */ },
 };
 
+/*
+ * Few boards still need to initialize some legacy devices with
+ * platform data until the drivers support device tree.
+ */
 static struct pdata_init pdata_quirks[] __initdata = {
 #ifdef CONFIG_ARCH_OMAP3
 	{ "nokia,omap3-n900", hsmmc2_internal_input_clk, },
@@ -156,14 +171,8 @@ static struct pdata_init pdata_quirks[] __initdata = {
 	{ /* sentinel */ },
 };
 
-void __init pdata_quirks_init(struct of_device_id *omap_dt_match_table)
+static void pdata_quirks_check(struct pdata_init *quirks)
 {
-	struct pdata_init *quirks = pdata_quirks;
-
-	omap_sdrc_init(NULL, NULL);
-	of_platform_populate(NULL, omap_dt_match_table,
-			     omap_auxdata_lookup, NULL);
-
 	while (quirks->compatible) {
 		if (of_machine_is_compatible(quirks->compatible)) {
 			if (quirks->fn)
@@ -173,3 +182,12 @@ void __init pdata_quirks_init(struct of_device_id *omap_dt_match_table)
 		quirks++;
 	}
 }
+
+void __init pdata_quirks_init(struct of_device_id *omap_dt_match_table)
+{
+	omap_sdrc_init(NULL, NULL);
+	pdata_quirks_check(auxdata_quirks);
+	of_platform_populate(NULL, omap_dt_match_table,
+			     omap_auxdata_lookup, NULL);
+	pdata_quirks_check(pdata_quirks);
+}

commit edd5eb4e99e4153ea7be05390fda542d986bf28d
Author: Tony Lindgren <tony@atomide.com>
Date:   Mon Nov 25 14:23:45 2013 -0800

    ARM: OMAP2+: Fix eMMC on n900 with device tree
    
    Looks like we need to configure the regulators and use the pdata
    quirk to make eMMC work with device tree.
    
    It seems that mostly vaux3 is used, and only some earlier revisions
    used vmmc2. This has been tested to work on devices where the
    system_rev passed by the bootloader has versions 0x0010, 0x2101
    and 0x2204.
    
    Cc: devicetree@vger.kernel.org
    Cc: Pavel Machek <pavel@ucw.cz>
    Cc: Aaro Koskinen <aaro.koskinen@iki.fi>
    Signed-off-by: Sebastian Reichel <sre@debian.org>
    [tony@atomide.com: updated with pinctrl changes and comments from Sebastian]
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 10c71450cf63..39f020c982e8 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -139,6 +139,7 @@ struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
 
 static struct pdata_init pdata_quirks[] __initdata = {
 #ifdef CONFIG_ARCH_OMAP3
+	{ "nokia,omap3-n900", hsmmc2_internal_input_clk, },
 	{ "nokia,omap3-n9", hsmmc2_internal_input_clk, },
 	{ "nokia,omap3-n950", hsmmc2_internal_input_clk, },
 	{ "isee,omap3-igep0020", omap3_igep0020_legacy_init, },

commit 79b39f7918559da88be9463fc8b6674dd1ca2896
Author: Tony Lindgren <tony@atomide.com>
Date:   Fri Oct 11 09:20:54 2013 -0700

    ARM: OMAP2+: Use pdata quirks for wl12xx for omap3 evm and zoom3
    
    As the wl12xx bindings are still pending, this way we can
    get things working for omap3 evm and zoom platforms.
    
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 18afbde020f7..10c71450cf63 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -82,6 +82,16 @@ static void __init omap3_igep0020_legacy_init(void)
 {
 	omap3_igep2_display_init_of();
 }
+
+static void __init omap3_evm_legacy_init(void)
+{
+	legacy_init_wl12xx(WL12XX_REFCLOCK_38, 0, 149);
+}
+
+static void __init omap3_zoom_legacy_init(void)
+{
+	legacy_init_wl12xx(WL12XX_REFCLOCK_26, 0, 162);
+}
 #endif /* CONFIG_ARCH_OMAP3 */
 
 #ifdef CONFIG_ARCH_OMAP4
@@ -132,6 +142,8 @@ static struct pdata_init pdata_quirks[] __initdata = {
 	{ "nokia,omap3-n9", hsmmc2_internal_input_clk, },
 	{ "nokia,omap3-n950", hsmmc2_internal_input_clk, },
 	{ "isee,omap3-igep0020", omap3_igep0020_legacy_init, },
+	{ "ti,omap3-evm-37xx", omap3_evm_legacy_init, },
+	{ "ti,omap3-zoom3", omap3_zoom_legacy_init, },
 #endif
 #ifdef CONFIG_ARCH_OMAP4
 	{ "ti,omap4-sdp", omap4_sdp_legacy_init, },

commit 30a69ef785e87c791aab0b4dae76709a7baa3e85
Author: Tony Lindgren <tony@atomide.com>
Date:   Thu Oct 10 15:45:13 2013 -0700

    ARM: OMAP: Move DT wake-up event handling over to use pinctrl-single-omap
    
    Now pinctrl-single-omap can handle the wake-up events for us now
    as long as the events are configured in the .dts files.
    
    Done in collaboration with Roger Quadros <rogerq@ti.com>.
    
    Cc: Peter Ujfalusi <peter.ujfalusi@ti.com>
    Cc: Grygorii Strashko <grygorii.strashko@ti.com>
    Cc: Prakash Manjunathappa <prakash.pm@ti.com>
    Cc: Roger Quadros <rogerq@ti.com>
    Cc: Haojian Zhuang <haojian.zhuang@linaro.org>
    Cc: Linus Walleij <linus.walleij@linaro.org>
    Reviewed-by: Kevin Hilman <khilman@linaro.org>
    Tested-by: Kevin Hilman <khilman@linaro.org>
    Signed-off-by: Roger Quadros <rogerq@ti.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 76abc5b63d6d..18afbde020f7 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -14,6 +14,8 @@
 #include <linux/of_platform.h>
 #include <linux/wl12xx.h>
 
+#include <linux/platform_data/pinctrl-single.h>
+
 #include "common.h"
 #include "common-board-devices.h"
 #include "dss-common.h"
@@ -105,7 +107,23 @@ static void __init omap5_uevm_legacy_init(void)
 }
 #endif
 
+static struct pcs_pdata pcs_pdata;
+
+void omap_pcs_legacy_init(int irq, void (*rearm)(void))
+{
+	pcs_pdata.irq = irq;
+	pcs_pdata.rearm = rearm;
+}
+
 struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
+#ifdef CONFIG_ARCH_OMAP3
+	OF_DEV_AUXDATA("ti,omap3-padconf", 0x48002030, "48002030.pinmux", &pcs_pdata),
+	OF_DEV_AUXDATA("ti,omap3-padconf", 0x48002a00, "48002a00.pinmux", &pcs_pdata),
+#endif
+#ifdef CONFIG_ARCH_OMAP4
+	OF_DEV_AUXDATA("ti,omap4-padconf", 0x4a100040, "4a100040.pinmux", &pcs_pdata),
+	OF_DEV_AUXDATA("ti,omap4-padconf", 0x4a31e040, "4a31e040.pinmux", &pcs_pdata),
+#endif
 	{ /* sentinel */ },
 };
 

commit 8651bd8ce36fb324c218167c970d6734dc825f2c
Author: Tony Lindgren <tony@atomide.com>
Date:   Thu Oct 10 15:45:12 2013 -0700

    ARM: OMAP2+: Add support for auxdata
    
    For few things we're still going to be needing platform
    data for device tree based drivers. Let's set up auxdata
    handling and do it in pdata-quirks.c so we have all the
    legacy calls in one place.
    
    Reviewed-by: Kevin Hilman <khilman@linaro.org>
    Tested-by: Kevin Hilman <khilman@linaro.org>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 9113e7037ae5..76abc5b63d6d 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -11,6 +11,7 @@
 #include <linux/gpio.h>
 #include <linux/init.h>
 #include <linux/kernel.h>
+#include <linux/of_platform.h>
 #include <linux/wl12xx.h>
 
 #include "common.h"
@@ -104,6 +105,10 @@ static void __init omap5_uevm_legacy_init(void)
 }
 #endif
 
+struct of_dev_auxdata omap_auxdata_lookup[] __initdata = {
+	{ /* sentinel */ },
+};
+
 static struct pdata_init pdata_quirks[] __initdata = {
 #ifdef CONFIG_ARCH_OMAP3
 	{ "nokia,omap3-n9", hsmmc2_internal_input_clk, },
@@ -120,10 +125,14 @@ static struct pdata_init pdata_quirks[] __initdata = {
 	{ /* sentinel */ },
 };
 
-void __init pdata_quirks_init(void)
+void __init pdata_quirks_init(struct of_device_id *omap_dt_match_table)
 {
 	struct pdata_init *quirks = pdata_quirks;
 
+	omap_sdrc_init(NULL, NULL);
+	of_platform_populate(NULL, omap_dt_match_table,
+			     omap_auxdata_lookup, NULL);
+
 	while (quirks->compatible) {
 		if (of_machine_is_compatible(quirks->compatible)) {
 			if (quirks->fn)

commit 15c9887e15e874f3c15342a897577e914a781738
Author: Javier Martinez Canillas <javier.martinez@collabora.co.uk>
Date:   Wed Oct 9 11:19:18 2013 +0200

    ARM: OMAP2+: pdata-quirks: add legacy display init for IGEPv2 board
    
    IGEPv2 board has both an DVI and TFP410 video interfaces but
    DSS support for DeviceTree has not yet landed in mainline so
    is necessary to init the displays using legacy platform code.
    
    Signed-off-by: Javier Martinez Canillas <javier.martinez@collabora.co.uk>
    Acked-by: Tomi Valkeinen <tomi.valkeinen@ti.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 3d472dbb9205..9113e7037ae5 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -74,6 +74,11 @@ static void __init hsmmc2_internal_input_clk(void)
 	reg |= OMAP2_MMCSDIO2ADPCLKISEL;
 	omap_ctrl_writel(reg, OMAP343X_CONTROL_DEVCONF1);
 }
+
+static void __init omap3_igep0020_legacy_init(void)
+{
+	omap3_igep2_display_init_of();
+}
 #endif /* CONFIG_ARCH_OMAP3 */
 
 #ifdef CONFIG_ARCH_OMAP4
@@ -103,6 +108,7 @@ static struct pdata_init pdata_quirks[] __initdata = {
 #ifdef CONFIG_ARCH_OMAP3
 	{ "nokia,omap3-n9", hsmmc2_internal_input_clk, },
 	{ "nokia,omap3-n950", hsmmc2_internal_input_clk, },
+	{ "isee,omap3-igep0020", omap3_igep0020_legacy_init, },
 #endif
 #ifdef CONFIG_ARCH_OMAP4
 	{ "ti,omap4-sdp", omap4_sdp_legacy_init, },

commit faf4bd47b06d8c92610cda8d49bfe4b79f79f74f
Author: Aaro Koskinen <aaro.koskinen@iki.fi>
Date:   Tue Sep 24 22:28:15 2013 +0300

    ARM: OMAP2+: pdata-quirks: set internal clock source for MMC2 on N950/N9
    
    Set internal clock source for MMC2 on N950/N9.
    
    Signed-off-by: Aaro Koskinen <aaro.koskinen@iki.fi>
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 04bfa647a934..3d472dbb9205 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -16,6 +16,7 @@
 #include "common.h"
 #include "common-board-devices.h"
 #include "dss-common.h"
+#include "control.h"
 
 struct pdata_init {
 	const char *compatible;
@@ -64,6 +65,17 @@ static inline void legacy_init_wl12xx(unsigned ref_clock,
 }
 #endif
 
+#ifdef CONFIG_ARCH_OMAP3
+static void __init hsmmc2_internal_input_clk(void)
+{
+	u32 reg;
+
+	reg = omap_ctrl_readl(OMAP343X_CONTROL_DEVCONF1);
+	reg |= OMAP2_MMCSDIO2ADPCLKISEL;
+	omap_ctrl_writel(reg, OMAP343X_CONTROL_DEVCONF1);
+}
+#endif /* CONFIG_ARCH_OMAP3 */
+
 #ifdef CONFIG_ARCH_OMAP4
 static void __init omap4_sdp_legacy_init(void)
 {
@@ -88,6 +100,10 @@ static void __init omap5_uevm_legacy_init(void)
 #endif
 
 static struct pdata_init pdata_quirks[] __initdata = {
+#ifdef CONFIG_ARCH_OMAP3
+	{ "nokia,omap3-n9", hsmmc2_internal_input_clk, },
+	{ "nokia,omap3-n950", hsmmc2_internal_input_clk, },
+#endif
 #ifdef CONFIG_ARCH_OMAP4
 	{ "ti,omap4-sdp", omap4_sdp_legacy_init, },
 	{ "ti,omap4-panda", omap4_panda_legacy_init, },

commit 5f0a2c6976d0bfaeda1eaba1837f28e5a3146a69
Author: Tony Lindgren <tony@atomide.com>
Date:   Wed Sep 25 15:44:40 2013 -0700

    ARM: OMAP2+: Use pdata quirks for wl12xx legacy init
    
    Let's use the platform data quirk support for wl12xx
    and move the board specific code out of devices.c.
    
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index 648d9573aaea..04bfa647a934 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -8,8 +8,10 @@
  * published by the Free Software Foundation.
  */
 #include <linux/clk.h>
+#include <linux/gpio.h>
 #include <linux/init.h>
 #include <linux/kernel.h>
+#include <linux/wl12xx.h>
 
 #include "common.h"
 #include "common-board-devices.h"
@@ -34,16 +36,47 @@ static void __init __used legacy_init_ehci_clk(char *clkname)
 		       __func__, clkname, ret);
 }
 
+#if IS_ENABLED(CONFIG_WL12XX)
+
+static struct wl12xx_platform_data wl12xx __initdata;
+
+static void __init __used legacy_init_wl12xx(unsigned ref_clock,
+					     unsigned tcxo_clock,
+					     int gpio)
+{
+	int res;
+
+	wl12xx.board_ref_clock = ref_clock;
+	wl12xx.board_tcxo_clock = tcxo_clock;
+	wl12xx.irq = gpio_to_irq(gpio);
+
+	res = wl12xx_set_platform_data(&wl12xx);
+	if (res) {
+		pr_err("error setting wl12xx data: %d\n", res);
+		return;
+	}
+}
+#else
+static inline void legacy_init_wl12xx(unsigned ref_clock,
+				      unsigned tcxo_clock,
+				      int gpio)
+{
+}
+#endif
+
 #ifdef CONFIG_ARCH_OMAP4
 static void __init omap4_sdp_legacy_init(void)
 {
 	omap_4430sdp_display_init_of();
+	legacy_init_wl12xx(WL12XX_REFCLOCK_26,
+			   WL12XX_TCXOCLOCK_26, 53);
 }
 
 static void __init omap4_panda_legacy_init(void)
 {
 	omap4_panda_display_init_of();
 	legacy_init_ehci_clk("auxclk3_ck");
+	legacy_init_wl12xx(WL12XX_REFCLOCK_38, 0, 53);
 }
 #endif
 

commit 3e7a318530c3d536972e9a2bb44e0ce0c16eaa4e
Author: Tony Lindgren <tony@atomide.com>
Date:   Wed Sep 25 15:44:39 2013 -0700

    ARM: OMAP2+: Use pdata quirk support for board-generic.c
    
    Let's use platform data quirk support for board-generic.c.
    This removes all board specific hacks out of board-generic.c.
    
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
index e6051998f929..648d9573aaea 100644
--- a/arch/arm/mach-omap2/pdata-quirks.c
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -20,7 +20,48 @@ struct pdata_init {
 	void (*fn)(void);
 };
 
+/*
+ * Create alias for USB host PHY clock.
+ * Remove this when clock phandle can be provided via DT
+ */
+static void __init __used legacy_init_ehci_clk(char *clkname)
+{
+	int ret;
+
+	ret = clk_add_alias("main_clk", NULL, clkname, NULL);
+	if (ret)
+		pr_err("%s:Failed to add main_clk alias to %s :%d\n",
+		       __func__, clkname, ret);
+}
+
+#ifdef CONFIG_ARCH_OMAP4
+static void __init omap4_sdp_legacy_init(void)
+{
+	omap_4430sdp_display_init_of();
+}
+
+static void __init omap4_panda_legacy_init(void)
+{
+	omap4_panda_display_init_of();
+	legacy_init_ehci_clk("auxclk3_ck");
+}
+#endif
+
+#ifdef CONFIG_SOC_OMAP5
+static void __init omap5_uevm_legacy_init(void)
+{
+	legacy_init_ehci_clk("auxclk1_ck");
+}
+#endif
+
 static struct pdata_init pdata_quirks[] __initdata = {
+#ifdef CONFIG_ARCH_OMAP4
+	{ "ti,omap4-sdp", omap4_sdp_legacy_init, },
+	{ "ti,omap4-panda", omap4_panda_legacy_init, },
+#endif
+#ifdef CONFIG_SOC_OMAP5
+	{ "ti,omap5-uevm", omap5_uevm_legacy_init, },
+#endif
 	{ /* sentinel */ },
 };
 

commit 6a08e1e6f7fafa2fa5fb6a129c4c8d9c29f11b62
Author: Tony Lindgren <tony@atomide.com>
Date:   Wed Sep 25 15:44:39 2013 -0700

    ARM: OMAP2+: Add quirk support for legacy platform data init
    
    We want to drop the board-*.c files but keep things working.
    Let's make it a bit easier to support legacy platform data
    init with quirks. This also keeps board-generic.c clean from
    board specific hacks.
    
    For now, the quirks table is empty, that is populated
    in the later patches.
    
    Signed-off-by: Tony Lindgren <tony@atomide.com>

diff --git a/arch/arm/mach-omap2/pdata-quirks.c b/arch/arm/mach-omap2/pdata-quirks.c
new file mode 100644
index 000000000000..e6051998f929
--- /dev/null
+++ b/arch/arm/mach-omap2/pdata-quirks.c
@@ -0,0 +1,39 @@
+/*
+ * Legacy platform_data quirks
+ *
+ * Copyright (C) 2013 Texas Instruments
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License version 2 as
+ * published by the Free Software Foundation.
+ */
+#include <linux/clk.h>
+#include <linux/init.h>
+#include <linux/kernel.h>
+
+#include "common.h"
+#include "common-board-devices.h"
+#include "dss-common.h"
+
+struct pdata_init {
+	const char *compatible;
+	void (*fn)(void);
+};
+
+static struct pdata_init pdata_quirks[] __initdata = {
+	{ /* sentinel */ },
+};
+
+void __init pdata_quirks_init(void)
+{
+	struct pdata_init *quirks = pdata_quirks;
+
+	while (quirks->compatible) {
+		if (of_machine_is_compatible(quirks->compatible)) {
+			if (quirks->fn)
+				quirks->fn();
+			break;
+		}
+		quirks++;
+	}
+}
