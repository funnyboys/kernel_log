commit 92f6f2d7f5c844faebf5b47d4a8f15de519b48c2
Author: Vishal Verma <vishal.l.verma@intel.com>
Date:   Mon Mar 18 19:06:29 2019 -0600

    tools/testing/nvdimm: add watermarks for dax_pmem* modules
    
    Add nfit_test 'watermarks' for the dax_pmem, dax_pmem_core, and
    dax_pmem_compat modules. This causes the nfit_test module to fail
    loading in case any of these modules are also not overridden with the
    ldconfig wrapped modules. Without this, nfit_test would sometimes fail
    creation of device-dax namespaces on the nfit_test_bus with an unhelpful
    error log such as:
    
        dax_pmem dax5.0: could not reserve metadata
        dax_pmem: probe of dax5.0 failed with error -16
    
    Which was caused due to the unwrapped version of
    devm_request_mem_region() being called.
    
    Cc: Dan Williams <dan.j.williams@intel.com>
    Signed-off-by: Vishal Verma <vishal.l.verma@intel.com>
    Signed-off-by: Dan Williams <dan.j.williams@intel.com>

diff --git a/tools/testing/nvdimm/watermark.h b/tools/testing/nvdimm/watermark.h
index ed0528757bd4..43fc4f3e7927 100644
--- a/tools/testing/nvdimm/watermark.h
+++ b/tools/testing/nvdimm/watermark.h
@@ -6,6 +6,9 @@ int pmem_test(void);
 int libnvdimm_test(void);
 int acpi_nfit_test(void);
 int device_dax_test(void);
+int dax_pmem_test(void);
+int dax_pmem_core_test(void);
+int dax_pmem_compat_test(void);
 
 /*
  * dummy routine for nfit_test to validate it is linking to the properly

commit 0fb5c8df609eaca3cb7c24e7f91470f8dd5984ec
Author: Dan Williams <dan.j.williams@intel.com>
Date:   Thu Feb 1 12:28:54 2018 -0800

    tools/testing/nvdimm: force nfit_test to depend on instrumented modules
    
    The libnvdimm unit tests will fail when they are run against the
    production / in-tree version of libnvdimm.ko or nfit.ko due to
    symbols not being mocked per nfit_test's expectation. For example,
    nfit_test expects acpi_evaluate_dsm() to be replaced by
    __wrap_acpi_evaluate_dsm() to test how acpi_nfit_ctl() responds to
    different stimuli.
    
    Create a test-only symbol name that nfit_test links against to cause
    module load failures when the wrong module is present.
    
    For example, with this change, attempts to use the wrong module will
    report:
    
        nfit_test: Unknown symbol libnvdimm_test (err 0)
    
    Reported-by: Dave Jiang <dave.jiang@intel.com>
    Reported-by: Vishal Verma <vishal.l.verma@intel.com>
    Signed-off-by: Dan Williams <dan.j.williams@intel.com>

diff --git a/tools/testing/nvdimm/watermark.h b/tools/testing/nvdimm/watermark.h
new file mode 100644
index 000000000000..ed0528757bd4
--- /dev/null
+++ b/tools/testing/nvdimm/watermark.h
@@ -0,0 +1,21 @@
+// SPDX-License-Identifier: GPL-2.0
+// Copyright(c) 2018 Intel Corporation. All rights reserved.
+#ifndef _TEST_NVDIMM_WATERMARK_H_
+#define _TEST_NVDIMM_WATERMARK_H_
+int pmem_test(void);
+int libnvdimm_test(void);
+int acpi_nfit_test(void);
+int device_dax_test(void);
+
+/*
+ * dummy routine for nfit_test to validate it is linking to the properly
+ * mocked module and not the standard one from the base tree.
+ */
+#define nfit_test_watermark(x)				\
+int x##_test(void)					\
+{							\
+	pr_debug("%s for nfit_test\n", KBUILD_MODNAME);	\
+	return 0;					\
+}							\
+EXPORT_SYMBOL(x##_test)
+#endif /* _TEST_NVDIMM_WATERMARK_H_ */
