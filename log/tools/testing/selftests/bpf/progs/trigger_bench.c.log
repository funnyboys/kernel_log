commit c5d420c32cb44fdd10d76f0f01bcd0b09383d0b5
Author: Andrii Nakryiko <andriin@fb.com>
Date:   Tue May 12 12:24:45 2020 -0700

    selftest/bpf: Add BPF triggering benchmark
    
    It is sometimes desirable to be able to trigger BPF program from user-space
    with minimal overhead. sys_enter would seem to be a good candidate, yet in
    a lot of cases there will be a lot of noise from syscalls triggered by other
    processes on the system. So while searching for low-overhead alternative, I've
    stumbled upon getpgid() syscall, which seems to be specific enough to not
    suffer from accidental syscall by other apps.
    
    This set of benchmarks compares tp, raw_tp w/ filtering by syscall ID, kprobe,
    fentry and fmod_ret with returning error (so that syscall would not be
    executed), to determine the lowest-overhead way. Here are results on my
    machine (using benchs/run_bench_trigger.sh script):
    
      base      :    9.200 ± 0.319M/s
      tp        :    6.690 ± 0.125M/s
      rawtp     :    8.571 ± 0.214M/s
      kprobe    :    6.431 ± 0.048M/s
      fentry    :    8.955 ± 0.241M/s
      fmodret   :    8.903 ± 0.135M/s
    
    So it seems like fmodret doesn't give much benefit for such lightweight
    syscall. Raw tracepoint is pretty decent despite additional filtering logic,
    but it will be called for any other syscall in the system, which rules it out.
    Fentry, though, seems to be adding the least amoung of overhead and achieves
    97.3% of performance of baseline no-BPF-attached syscall.
    
    Using getpgid() seems to be preferable to set_task_comm() approach from
    test_overhead, as it's about 2.35x faster in a baseline performance.
    
    Signed-off-by: Andrii Nakryiko <andriin@fb.com>
    Signed-off-by: Alexei Starovoitov <ast@kernel.org>
    Acked-by: John Fastabend <john.fastabend@gmail.com>
    Acked-by: Yonghong Song <yhs@fb.com>
    Link: https://lore.kernel.org/bpf/20200512192445.2351848-5-andriin@fb.com

diff --git a/tools/testing/selftests/bpf/progs/trigger_bench.c b/tools/testing/selftests/bpf/progs/trigger_bench.c
new file mode 100644
index 000000000000..8b36b6640e7e
--- /dev/null
+++ b/tools/testing/selftests/bpf/progs/trigger_bench.c
@@ -0,0 +1,47 @@
+// SPDX-License-Identifier: GPL-2.0
+// Copyright (c) 2020 Facebook
+
+#include <linux/bpf.h>
+#include <asm/unistd.h>
+#include <bpf/bpf_helpers.h>
+#include <bpf/bpf_tracing.h>
+
+char _license[] SEC("license") = "GPL";
+
+long hits = 0;
+
+SEC("tp/syscalls/sys_enter_getpgid")
+int bench_trigger_tp(void *ctx)
+{
+	__sync_add_and_fetch(&hits, 1);
+	return 0;
+}
+
+SEC("raw_tp/sys_enter")
+int BPF_PROG(bench_trigger_raw_tp, struct pt_regs *regs, long id)
+{
+	if (id == __NR_getpgid)
+		__sync_add_and_fetch(&hits, 1);
+	return 0;
+}
+
+SEC("kprobe/__x64_sys_getpgid")
+int bench_trigger_kprobe(void *ctx)
+{
+	__sync_add_and_fetch(&hits, 1);
+	return 0;
+}
+
+SEC("fentry/__x64_sys_getpgid")
+int bench_trigger_fentry(void *ctx)
+{
+	__sync_add_and_fetch(&hits, 1);
+	return 0;
+}
+
+SEC("fmod_ret/__x64_sys_getpgid")
+int bench_trigger_fmodret(void *ctx)
+{
+	__sync_add_and_fetch(&hits, 1);
+	return -22;
+}
